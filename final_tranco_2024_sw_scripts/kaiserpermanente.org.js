const e={COL_DB:[[40.26871352449058,-109.05093521427948],[40.26871352449058,-102.05161461739759],[39.233200312601156,-102.04760270150756],[39.233200312601156,-106.01323800119017],[36.995560528203,-106.0160704139099],[36.99905657116556,-109.04559330972289]],COL_N:[[41.00280759604659,-109.05009316006237],[41.002982084032496,-107.35247567031722],[41.002729334743655,-102.05155506152467],[40.26871352449058,-102.05161461739759],[40.26871352449058,-109.05093521427948]],COL_S:[[39.233200312601156,-106.01323800119017],[39.233200312601156,-102.04760270150756],[36.99298746189116,-102.04206302451664],[36.995560528203,-106.0160704139099]],GGA:[[34.985003,-85.615678],[35.003003,-83.098129],[34.696461,-83.339989],[34.443159,-82.867254],[31.858897,-80.712496],[30.685164,-81.262179],[30.817346,-81.943786],[30.363396,-82.042729],[30.372875,-82.185647],[30.581179,-82.229622],[30.704058,-84.912707],[31.194008,-85.13258],[31.550453,-85.022643],[31.868228,-85.154567],[32.268555,-84.9237],[32.352123,-85.034308]],HAW:[[29.458731,-179.01596],[19.932041,-153.171998],[18.187607,-155.810477],[26.980829,-179.512816]],KNW:[[45.93205,-124.001622],[46.3367,-117.0412],[45.629405,-116.425843],[44.355278,-117.261699],[44.150681,-116.909902],[42.016652,-117.041811],[41.95132,-124.583464]],MID:[[39.487085,-77.583696],[39.444678,-76.187501],[37.909534,-76.253463],[38.074041,-77.946487]],NCA:[[42.032974,-124.771144],[42.049293,-120.009029],[39.00211,-119.989756],[36.70366,-116.798058],[36.155618,-122.009055],[40.363288,-124.559585]],SCA:[[36.155618,-122.009055],[36.70366,-116.798058],[34.976001,-114.569578],[34.307143,-114.151819],[32.731841,-114.538322],[32.537552,-117.5311],[34.524661,-120.855361]],WA:[[49.023461,-123.374367],[48.987122,-117.036534],[46.3367,-117.0412],[46.050038,-124.041251],[48.501739,-125.008693],[48.290194,-123.123408],[49.023461,-123.374367]]},t={CA:["NCA","SCA"],CO:["COL_DB","COL_S","COL_N"],DC:["MID"],GA:["GGA"],HI:["HAW"],MD:["MID"],OR:["KNW"],VA:["MID"],WA:["KNW","WA"]};function s(e,t,s){return(t.lat-e.lat)*(s.lng-e.lng)-(s.lat-e.lat)*(t.lng-e.lng)}function n(e,t,n){const a=e,r=t;let i=0;for(let e=0,t=n.length-1;e<n.length;t=e++){let o=n[e][0],c=n[e][1],l=n[t][0],u=n[t][1];u<=r?c>r&&s({lat:l,lng:u},{lat:o,lng:c},{lat:a,lng:r})>0&&i++:c<=r&&s({lat:l,lng:u},{lat:o,lng:c},{lat:a,lng:r})<0&&i--}return 0!=i}const a="2.3.1",r={},i={},o={};let c,l;const u=s=>{if(!s)return;const a=s.split(",")[0].split("|").map((e=>e.split(":"))).reduce(((e,t)=>{const s=t[1].trim();return e[t[0].trim().toLowerCase()]=isNaN(s)?s:+s,e}),{});return a&&a.region_code&&(a.kp_region=function(s,a,r){const i=t[r];if(i)for(const t of i)if(n(s,a,e[t]))return t.split("_")[0]}(a.latitude,a.longitude,a.region_code)),a},h=(e,t)=>(t||"").split(/(\[|\]|\.)/).reduce(((e,t)=>-1!=="[].".indexOf(t)?e:e===Object(e)&&t in e?e[t]:void 0),e),g="_netcache",d=[["content-type","application/json"]];const p=(e,...t)=>{console.log("%c[KPDL-SW]",`${e}padding:2px;`,...t)};const f=new class{level;constructor(e=0){this.level=e}error(...e){p("color:white;background-color:red;",...e)}info(...e){this.level>0&&p("color:cyan;",...e)}debug(...e){this.level>1&&p("color:orange;",...e)}trace(...e){this.level>2&&p("color:orange;",...e)}},y=new class{constructor(e){l=e}get version(){return a}get logger(){return l}get config(){return r||{}}get store(){return i||{}}logLevel(e){r._logging=e,l&&(l.level=e)}isStatusRequest(e){const t=new URL(e.request.url);return t.origin===location.origin&&"/kpdl-status"===t.pathname&&(e.respondWith(this.handleStatus(e)),!0)}async handleStatus(e){const t=new URL(e.request.url);t.searchParams.get("flush")&&this.purgeAll(!0),t.searchParams.get("netCache")&&(r.netCache=/^(1|true)$/g.test(t.searchParams.get("netCache")));const s=parseInt(t.searchParams.get("log"),10);!isNaN(s)&&this.logLevel(s);const n=/debug/.test(t.search),a=Object.assign({},{config:r,store:n&&i,promises:n&&Object.keys(o)});return new Response(JSON.stringify(a,null,2),{headers:new Headers([["content-type","application/json"]])})}async cachedFetch(e,t,s){return l.trace(`state.request ${e}`),o[e]||(l.debug(`state.fetch ${e}`),o[e]=fetch(t,{credentials:"include"}).then((e=>{if(200!==e.status)return;const t=[];return e.headers.forEach(((e,s)=>t.push([s,e]))),e.json().then((e=>({json:e,headers:t})))})).then(s).catch((e=>l.debug(e)))),o[e]}async fetchConfig(){return this.cachedFetch("config",`/config-json/kpdl.json?v=${(new Date).valueOf()}`,(e=>{const t=e.json;t.secureActions&&!t.secureActions.find((e=>"uidl"===e.key))&&t.secureActions.unshift({key:"uidl",path:"/uidatalayer/[^/]+/n?s/profile$",cache:!0});const s=e.headers.find((e=>"x-geolocation"===e[0].toLowerCase()));r.geolocation=s?u(s[1]):void 0,t._configVersion=t.version,delete t.version,Object.assign(r,t,{_version:a,_logging:l.level,_ts:(new Date).toISOString()}),this.ping(),l.debug("config:",r)}))}init(e,t,s){l.debug("state.init",e,t,s),r._visitorId===e&&r._secure===s||(this.purgeAll(),r._visitorId=e,r._sessionId=t,r._secure=s)}setSecure(e,t){l.debug("state.setSecure",e,t?"force":""),(t||r._secure!==e)&&(this.purgeAll(),r._secure=e)}get(e,t){return e&&t&&i[e]&&i[e][t]}set(e,t,s){e&&t&&(i[e]=i[e]||{},i[e][t]=s)}getDeep(e){return h(i,e)}getCache(e){if(r.secureActions.some((t=>t.key===e&&t.cache))){const t=(this.getDeep(`_netcache.${e}`)||[]).sort(((e,t)=>e.ts>t.ts?-1:1))[0],s=t?.body;return{key:e,data:s}}return{}}patch(e){if(!e&&!e.path)return;l.debug("state.patch:",e.path,e.key,e.value);const t=e.path.split("."),s=t.pop(),n=t.join(".");let a=h(i,n||s);a&&"object"==typeof a?(n&&(a[s]=a[s]||{},a=a[s]),a[e.key]=e.value):l.debug("state.patch:failed:",n,s)}purge(e,t){if(l.debug("state.purge:",e,t),i[e])if(t)for(const s of t.filter((e=>e)))if(/_\*$/.test(s)){const t=new RegExp("^"+s.slice(0,-1),"i"),n=Object.keys(i[e]).filter((e=>t.test(e)));l.debug("state.purge:",e,n),n.forEach((t=>delete i[e][t]))}else delete i[e][s];else delete i[e]}purgeAll(e){l.debug("state.purgeAll:",e?"w/config":""),e&&(Object.keys(r).forEach((e=>delete r[e])),r._version=a,delete o.config),Object.keys(i).forEach((e=>delete i[e])),Object.keys(o).forEach((t=>{(e||"config"!==t)&&delete o[t]}))}ping(){r._ping=r._ping||0,r._ping++,r._timeout=(new Date).valueOf()+1e4,l.trace("ping",r._ping,r._timeout),c||(c=setInterval((()=>{const e=(new Date).valueOf();e>r._timeout&&(l.debug("ping.timeout",e,r._timeout,e-r._timeout),this.purgeAll(!0),clearInterval(c),c=void 0)}),5e3))}}(f),v=new class{state;constructor(e){this.state=e}matchSecureAction(e,t){return this.state.logger.trace("netCache.matchSecureAction:",e,t),this.state.config.secureActions?.find((s=>{const n=s.method?.split(",");return(!n||-1!==n.indexOf(e))&&new RegExp(s.path).test(t)}))}hasSecureAction(e){const t=new URL(e.request.url),s=this.matchSecureAction(e.request.method,t.pathname);return s&&(this.state.logger.trace("netCache.hasSecureAction:",s,e),"auth"in s?"logout"===s.key?this.state.setSecure(!1,!0):e.respondWith(this.handleAuth(e,s)):"cache"in s?e.respondWith(this.handleSecureData(e,s)):"clear"in s&&this.clearSecureData(s.clear)),!1}async handleSecureData(e,t){const s=this.getRequestHash(e.request.clone(),t),n=t.key,a=this.state.get(g,n)||[],r=a.find((e=>e.hash===s));if(r?.body)return this.mergeState(n,r.body),this.state.logger.debug("netCache.handleSecureData:",e,t,r),r.ts=(new Date).toISOString(),this.state.set(g,n,a),new Response(JSON.stringify(r.body,null,2),{headers:new Headers(r.headers||d)});const i=await fetch(e.request,{credentials:"include"});if(i.ok){const r=i.clone(),o=[];r.headers.forEach(((e,t)=>o.push([t,e])));const c=await r.json();a.push({hash:s,headers:o,body:c,ts:(new Date).toISOString()}),a.sort(((e,t)=>e.ts>t.ts?-1:1));const l=Math.max(Math.min(parseInt(t.count,10)||0,3),1);if(this.state.set(g,n,a.slice(0,l)),this.mergeState(n,c),e.clientId){const t=await self.clients.get(e.clientId);t&&t.postMessage({type:"netCache",key:n})}return new Response(JSON.stringify(c,null,2),{headers:new Headers(o||d)})}return i}async handleAuth(e,t){const s=await fetch(e.request,{credentials:"include"});return this.state.setSecure(t.auth&&s.ok,!0),s}mergeState(e,t){if("uidl"===e)t.profile=Object.assign({},t.profile,{geolocation:this.state.config.geolocation});return t}clearSecureData(e="all"){this.state.logger.trace("netCache.clearSecureData:",e),"all"===e?this.state.purgeAll():this.state.purge(g,e.split(","))}getRequestHash(e,t){const s=[],n=new URL(e.url),a=n.pathname.match(/\/(v\d+(?:\.\d+)?)\//);s.push(a?a[1]:"");const r=t.headers?t.headers.toLowerCase().split(","):[];return r.unshift("x-versionid"),r.forEach((t=>s.push(e.headers.get(t)||""))),s.push(n.search||""),s.join("|")}hashString(e){let t=0,s=e.length;for(;s>0;)t=(t<<5)-t+e.charCodeAt(--s)|0;return t}}(y);self.addEventListener("install",(function(e){f.info("install:",y.version),e.waitUntil(self.skipWaiting())})),self.addEventListener("activate",(function(e){f.info("activate:",y.version),e.waitUntil(self.clients.claim())})),self.addEventListener("message",(async function(e){if(f.trace("onMessage:",e.data),e.data?.type)switch(e.data.type){case"init":y.init(e.data.visitorId,e.data.sessionId,!!e.data.secure),e.ports[0].postMessage({payload:!0});break;case"wait":e.waitUntil(async function(e){return new Promise((t=>setTimeout(t,e)))}(e.data.delay||0).then((()=>{y.ping(),e.ports[0].postMessage({payload:!0})})));break;case"reset":y.purgeAll(),e.ports[0].postMessage({payload:!0});break;case"patch":y.patch(e.data),e.ports[0].postMessage({payload:!0});break;case"net":const t=y.getCache(e.data.key);e.ports[0].postMessage(t);break;case"raw":const s=y.getDeep(e.data.path);e.ports[0].postMessage({payload:s});break;default:e.ports[0].postMessage({payload:!1})}})),self.addEventListener("fetch",(async function(e){try{if(-1===["","document","image"].indexOf(e.request.destination))return;if(f.trace(e.request.destination,e.request.mode,e.request.url),y.isStatusRequest(e))return;if(await y.fetchConfig(),y.config.netCache&&v.hasSecureAction(e))return}catch(e){f.error(`ERROR: ${e}`)}}));

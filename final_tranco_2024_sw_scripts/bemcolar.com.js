'use strict';const CACHE_NAME='store-cache-v1';const FILES_TO_CACHE=["/offline"];const IGNORE_PAGE_CACHE=['/admin','/amfeed','/checkout','/ajaxcart','/onestepcheckout','/customer','/sales/order','/sociallogin','/quickbuy','/oneclickbuy','/affiliate','/gtm.js','/warranty','/searchautocomplete','/productshipping'];const IGNORE_PIXEL=['connect.facebook.net','www.facebook.com','www.googletagmanager.com']
const IGNORE_EXT_CACHE=['.mp4']
const EVICT_CACHE_IN_PAGE=[{method:'POST',match:'/onestepcheckout/index/loginPost'},{method:'POST',match:'/checkout/cart/add'},{method:'POST',match:'/customer/account/createpost'},{method:'GET',match:'/customer/account/logout'},{method:'GET',match:'/sociallogin/google/connect'},{method:'GET',match:'/sociallogin/facebook/connect'},{method:'POST',match:'/ajaxcart/sidebar_cart/estimatePost/'},{method:'GET',match:'/directory/currency/switch'}];const isIgnoredPage=(url)=>{return isIgnoredImpl([...IGNORE_PAGE_CACHE,...IGNORE_EXT_CACHE],url);}
const isIgnoredPixel=(url)=>{return isIgnoredImpl(IGNORE_PIXEL,url);}
const isIgnoredImpl=(list,url)=>{if(!url.startsWith('http'))return true;return!!list.find((path)=>{return url.includes(path);});}
const needEvictCache=(request)=>{return!!EVICT_CACHE_IN_PAGE.find((value)=>{return request.method==value.method&&request.url.includes(value.match);});}
const evictMasterCache=(event)=>{event.waitUntil(caches.keys().then(cacheNames=>{return Promise.all(cacheNames.map(cacheName=>{return caches.delete(cacheName);}));}));}
const isBlockedByLGPD=(request)=>{return CONSENTS.includes((new URL(request.url)).hostname);}
let CONSENTS=[];self.addEventListener('install',(event)=>{event.waitUntil(caches.open(CACHE_NAME).then((cache)=>{return cache.addAll(FILES_TO_CACHE);}));event.waitUntil(caches.keys().then((keys)=>{return Promise.all(keys.map((key)=>{if(key!==CACHE_NAME){return caches.delete(key);}}));}));self.skipWaiting();});self.addEventListener('activate',(event)=>{self.clients.claim();});self.addEventListener('fetch',(event)=>{if(isBlockedByLGPD(event.request)){console.log('Service blocked by LGPD',event.request.url);event.respondWith(new Promise(resolve=>{resolve(new Response(null,{status:200}));}));return;}
if(needEvictCache(event.request)){console.log('Clear PWA cache from',event.request.url);evictMasterCache(event);return;}
if(isIgnoredPixel(event.request.url)){return;}
if(isIgnoredPixel(event.request.url)){return;}
if(event.request.method=='GET'&&!isIgnoredPage(event.request.url)){event.respondWith(caches.match(event.request).then(response=>{if(response){return response;}
var fetchRequest=event.request.clone();return fetch(fetchRequest).then(response=>{if(!response||response.status!==200||response.type!=='basic'){return response;}
var responseToCache=response.clone();caches.open(CACHE_NAME).then((cache)=>{cache.put(event.request,responseToCache);});return response;}).catch(()=>{return caches.open(CACHE_NAME).then((cache)=>{return cache.match('offline');});});}));return;}
event.respondWith(fetch(event.request).then(response=>{return response;}).catch(()=>{return caches.open(CACHE_NAME).then((cache)=>{return cache.match('offline');});}));});self.addEventListener('sync',(event)=>{let option=event.tag.replace(/(.*?)\:.*?$/,"$1");let value=event.tag.replace(/.*?\:(.*?)$/,"$1");if(option==="consents"){CONSENTS=value.split(',').filter((item,pos,self)=>{return self.indexOf(item)==pos;}).map((url)=>{try{const matches=url.match(/^(?:https?:)?(?:\/\/|\.)?([^\/\?]+)/i);return matches&&matches[1];}catch(ex){return '';}}).filter((item)=>{return item!=='';});evictMasterCache(event);}
if(option==="evict-cache"){evictMasterCache(event);}});self.addEventListener('message',(event)=>{let option=event.data.replace(/(.*?)\:.*?$/,"$1");let value=event.data.replace(/.*?\:(.*?)$/,"$1");if(option==="consents"){CONSENTS=value.split(',').filter((item,pos,self)=>{return self.indexOf(item)==pos;}).map((url)=>{try{const matches=url.match(/^(?:https?:)?(?:\/\/|\.)?([^\/\?]+)/i);return matches&&matches[1];}catch(ex){return '';}}).filter((item)=>{return item!=='';});evictMasterCache(event);}
if(option==="evict-cache"){evictMasterCache(event);}});
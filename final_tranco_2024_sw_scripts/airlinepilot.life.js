"use strict";var chatRegex=/\/chat\/channel\/(\d+)\//,inlineReplyIcon="https://sea2.discourse-cdn.com/flex016/images/push-notifications/inline_reply.png";function showNotification(e,t,i,n,o,s,c){var a={body:t,icon:i,badge:n,data:{url:c,baseUrl:s},tag:o};return chatRegex.test(c)&&(a.actions=[{action:"reply",title:"Reply",placeholder:"reply",type:"text",icon:inlineReplyIcon}]),self.registration.showNotification(e,a)}self.addEventListener("push",(function(e){var t=e.data.json();e.waitUntil(showNotification(t.title,t.body,t.icon,t.badge,t.tag,t.base_url,t.url))})),self.addEventListener("notificationclick",(function(e){e.notification.close();var t=e.notification.data.url,i=e.notification.data.baseUrl;if("reply"===e.action){let n;fetch("/session/csrf",{credentials:"include",headers:{Accept:"application/json"}}).then((e=>{if(!e.ok)throw new Error("Network response was not OK");return e.json()})).then((o=>{n=o.csrf;let s=t.match(chatRegex);if(s.length>0){let t=s[1];fetch(`${i}/chat/${t}.json`,{credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-CSRF-Token":n},body:`message=${e.reply}`,method:"POST",mode:"cors"})}}))}else e.waitUntil(clients.matchAll({type:"window"}).then((function(e){if(!e.some((function(e){return e.url===i+t&&"focus"in e?(e.focus(),!0):"postMessage"in e&&"focus"in e&&(e.focus(),e.postMessage({url:t}),!0)}))&&clients.openWindow)return clients.openWindow(i+t)})))})),self.addEventListener("pushsubscriptionchange",(function(e){e.waitUntil(Promise.all(fetch("https://multisite-flex016.discourse.org/push_notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({"subscription[endpoint]":e.newSubscription.endpoint,"subscription[keys][auth]":e.newSubscription.toJSON().keys.auth,"subscription[keys][p256dh]":e.newSubscription.toJSON().keys.p256dh,send_confirmation:!1})}),fetch("https://multisite-flex016.discourse.org/push_notifications/unsubscribe",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({"subscription[endpoint]":e.oldSubscription.endpoint,"subscription[keys][auth]":e.oldSubscription.toJSON().keys.auth,"subscription[keys][p256dh]":e.oldSubscription.toJSON().keys.p256dh})})))})),self.addEventListener("message",(function(e){"primaryTab"===e.data?.action&&e.waitUntil(self.clients.matchAll().then((function(e){const t=e.find((e=>e.focused))||e.find((e=>"visible"===e.visibilityState));e.forEach((function(e){e.postMessage({primaryTab:e.id===t?.id})}))})))}));
//# sourceMappingURL=https://global.discourse-cdn.com/flex016/assets/service-worker-583608dc3ec3f8e4d3690212aa2efa5bdc8a4efd920389a9eb00be046c0becbb.js.map
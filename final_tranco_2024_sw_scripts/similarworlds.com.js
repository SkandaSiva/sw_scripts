"use strict";const PWA_SW_VERSION=55,PWA_CACHE_UPLOAD_PREFIX="fileupload-",OFFLINE_URL="/offline.html",MANIFEST_URL="/manifest.json",CACHE_FILES=[OFFLINE_URL,MANIFEST_URL],CACHE_NAMES={offline:"offline-v55",media:"media-upl"};function html_entity_decode(e){return e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'")}function strip_tags(e){return e.replace(/<\/?([a-z][0-9a-z]*)\b[^>]*>/gi,"")}function normalizeBody(e){return html_entity_decode(strip_tags(e.replace(/<br \/>/g," ").replace(/<div/g," <div")))}function normalizeLink(e){return e.replace(/&amp;/g,"&")}function createCacheBustedRequest(e){var t=new Request(e,{cache:"reload"});if("cache"in t)return t;var n=new URL(e,self.location.href);return n.search+=(n.search?"&":"")+"cachebust="+Date.now(),new Request(n)}self.addEventListener("message",(function(e){if(null!==e.data)if("object"==typeof e.data&&e.data.body){var t=e.data;e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((function(e){for(var t=0;t<e.length;t++)if(e[t].focused)return!1;return!0})).then((function(e){return!e||(t.body=normalizeBody(t.body),t.data.link=normalizeLink(t.data.link),t.badge="https://images.similarworlds.com/Similar-Worlds-Logo-Symbol-96-White.png",self.registration.showNotification("SimilarWorlds",t))})))}else if("closeall"===e.data)e.waitUntil(self.registration.getNotifications().then((function(e){e.forEach((function(e){e.close()}))})))})),self.addEventListener("push",(function(e){var t=e.data?e.data.json():[];const n=[];for(var i=0;i<t.length;i++)if(t[i].body){t[i].body=normalizeBody(t[i].body),t[i].data.link=normalizeLink(t[i].data.link),t[i].renotify=!0,t[i].badge="https://images.similarworlds.com/Similar-Worlds-Logo-Symbol-96-White.png";const e=self.registration.showNotification("SimilarWorlds",t[i]).catch((function(e){console.error(e)}));n.push(e)}e.waitUntil(Promise.all(n))})),self.addEventListener("pushsubscriptionchange",(function(e){console.log("[ServiceWorker] Subscription Changed (expired?)")})),self.addEventListener("notificationclick",(function(e){var t="/";void 0!==e.notification.data.link&&null!==e.notification.data.link&&"/"!==(t=e.notification.data.link)[0]&&(t="/"+t);var n=e.notification.data.origin,i=e.notification.data.extra;e.notification.close(),e.waitUntil(clients.matchAll({type:"window"}).then((function(e){for(var o,r=(n?n.substring(0,n.indexOf("/",8)):self.location&&self.location.hostname?"https://"+self.location.hostname:"https://similarworlds.com")+t+(i?(t.indexOf("?")>-1?"&":"?")+i:""),a=0;a<e.length;a++)if((o=e[a]).url===r&&"focus"in o)return o.postMessage("reload"),o.focus();return!clients.openWindow||clients.openWindow(r)})))})),self.addEventListener("install",(function(e){e.waitUntil(caches.open(CACHE_NAMES.offline).then((function(e){return Promise.all(CACHE_FILES.map((function(t){return fetch(createCacheBustedRequest(t)).then((function(n){return e.put(t,n)}))})))})).then(self.skipWaiting()))})),self.addEventListener("activate",(function(e){const t=Object.values(CACHE_NAMES);return e.waitUntil(caches.keys().then((function(e){return Promise.all(e.map((function(e){return-1!==t.indexOf(e)||(console.log("[ServiceWorker] Deleting out of date cache: "+e),caches.delete(e))})))}))),self.clients.claim()})),self.addEventListener("fetch",(function(e){if(e.request.url.indexOf(MANIFEST_URL)>-1)return void e.respondWith(caches.match(MANIFEST_URL).then((function(t){return t||fetch(e.request).then((function(e){const t=e.clone();return caches.open(CACHE_NAMES.offline).then((function(e){return e.put(MANIFEST_URL,t)})),e}))})));const t=new URL(e.request.url);if("POST"===e.request.method){if(0===t.pathname.indexOf("/share"))return console.log("[ServiceWorker] Web Share Target detected"),void e.respondWith(shareTargetHandler(e));if(0===t.pathname.indexOf("/fileupload-"))return void e.respondWith(caches.open(CACHE_NAMES.media).then((function(t){return t.match(e.request.url).then((function(n){return console.log("[ServiceWorker] Deleting from cache: "+e.request.url.replace(new RegExp("^.*/fileupload-"),"")),t.delete(e.request.url),n}))})))}("navigate"===e.request.mode||"GET"===e.request.method&&e.request.headers.get("accept").includes("text/html"))&&e.respondWith(fetch(e.request).catch((function(e){return console.log("[ServiceWorker] Fetch failed; returning offline page instead."),console.error(e),caches.match(OFFLINE_URL).then((function(t){return t.text().then((function(t){return new Response(t.replace("<i>\x3c!-- error --\x3e</i>","<b>Error:</b> <i>"+e+"</i>"),{headers:{"Content-Type":"text/html"}})}))}))})))}));const shareTargetHandler=async e=>{const t=await e.request.formData();let n;const i=t.getAll("file");if(i&&0!==i.length)console.log("[ServiceWorker] Share - "+i.length+" file(s)"),await caches.open(CACHE_NAMES.media).then((function(e){for(const t of i){const n="fileupload-"+encodeURIComponent(t.name);console.log("[ServiceWorker] Adding to cache: "+t.name),e.put(n,new Response(t,{headers:{"content-length":t.size,"content-type":t.type}}))}})),n="tab=media";else{console.log("[ServiceWorker] Share - plain text");const e=JSON.stringify(Object.fromEntries(t));n="tab=post&data="+encodeURIComponent(e)}return Response.redirect(e.request.url+(-1===e.request.url.indexOf("?")?"?":"&")+n,303)};
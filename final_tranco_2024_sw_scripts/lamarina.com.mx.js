!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var s=t();for(var i in s)("object"==typeof exports?exports:e)[i]=s[i]}}(this,(()=>(()=>{var e={923:function(e){var t;t=()=>(()=>{"use strict";var e={147:e=>{e.exports=JSON.parse('{"name":"indigitall-web-core","description":"indigitall web core","version":"4.3.1","main":"index.js","author":"Smart2me S.L.","homepage":"https://indigitall.com","devDependencies":{"@babel/preset-env":"^7.18.10","babel-loader":"^8.2.5","filemanager-webpack-plugin":"^7.0.0","idempotent-babel-polyfill":"^7.4.4","script-loader":"^0.7.2","webpack":"^5.74.0","webpack-bundle-analyzer":"^4.6.1","webpack-cli":"^4.10.0"},"scripts":{"test":"echo \'There are not tests\'","public":"ws --directory ./public --port 80 --log.format dev","build":"webpack --config webpack.config.js --mode=production","build-dev":"webpack --config webpack.config.js --watch --mode=development","delete-node-modules":"rm -rf node_modules/ && rm -f package-lock.json","install-core":"npm install && npm run build"}}')}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={exports:{}};return e[i](o,o.exports,s),o.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{s.r(i),s.d(i,{default:()=>V});var e={};s.r(e),s.d(e,{BaseClient:()=>P,BaseRequest:()=>O});var t={};s.r(t),s.d(t,{Channel:()=>A,Device:()=>m,DeviceStatus:()=>N,ErrorDictionary:()=>p,ErrorModel:()=>S,EventType:()=>y,TopicSubscribeType:()=>C});var r={};s.r(r),s.d(r,{CommonUtils:()=>D,CorePermissions:()=>v,CryptoUtils:()=>B,ErrorUtils:()=>g,JsonUtils:()=>U,Log:()=>_,LogLevel:()=>R,TopicUtils:()=>M,Validations:()=>f});var o={platform:"webpush",version:"0.0.1"};const n=s(147);o.version=n.version;const a=o=Object.assign(o,{client:{URL_BASE:"https://device-api.indigitall.com/v1",URL_DEVICE_V2:"https://device-api.indigitall.com/v2",INAPP_URL_BASE:"https://inapp-api.indigitall.com/v1",INBOX_URL_BASE:"https://inbox-api.indigitall.com/v1",CUSTOMER_URL_BASE:"https://device-api.indigitall.com/v2"}}),c=new class{constructor(){this.storage=this.isLocalStorageAvailable()?window.localStorage:null}isLocalStorageAvailable(){try{const e=window.localStorage,t="__storage_test__";if(e)return e.setItem(t,t),e.removeItem(t),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==c.length}return!1}setItem(e,t){return null!=this.storage&&(this.storage.setItem(e,t),!0)}getItem(e){return null!=this.storage?this.storage.getItem(e):null}deleteItem(e){return!!this.storage&&(this.storage.setItem(e,value),!0)}clear(){this.storage&&this.storage.clear()}},E=c,h=new class{constructor(){this.TAG="[IND]IndexedDB: ",this.DB_NAME="indigitall.indexedDB",this.DB_VERSION=1,this.DB_STORE_NAME="indigitallStore",this.DB_STORE_MODE="readwrite",this.DB_KEY_PATH="id",this.DB_STORE_INDEX="storeIndex",this.IDB=indexedDB||mozzIndexedDB||webkitIndexedDB||msIndexedDB}async getDB(){return new Promise(((e,t)=>{const s=this.IDB;if(s){const i=s.open("indigitall.indexedDB",1);i.onupgradeneeded=function(){i.result.createObjectStore("indigitallStore").createIndex("storeIndex","store.key")},i.onsuccess=function(){const t=i.result,s=t.transaction("indigitallStore","readwrite"),r=s.objectStore("indigitallStore"),o=r.index("storeIndex");e({db:t,tx:s,store:r,index:o})},i.onerror=function(e){t(e)}}else t(!1)}))}async get(e,t){return new Promise(((s,i)=>{e||i(!1),e.index.get(t).onsuccess=t=>{t.target.result&&(this.close(e),s(t.target.result.store.value)),i(!1)}}))}async put(e,t,s){return new Promise(((i,r)=>{e||r(!1),e.store.put({store:{key:t,value:s}},t).onsuccess=t=>{this.close(e),i(s)}}))}close(e){if(e.tx)try{e.tx.oncomplete=()=>{e.db.close()}}catch(e){console.error(this.TAG,e)}}async setItem(e,t){try{const s=await this.getDB();return this.put(s,e,t)}catch(e){return e}}async getItem(e){try{const t=await this.getDB();return this.get(t,e)}catch(e){return e}}},I=new class{constructor(){this.SESSION="indigitall.session.storage",this.session=this.isSessionStorageAvailable()?window.sessionStorage:null}isSessionStorageAvailable(){try{const e=window.sessionStorage,t="__storage_test__";if(e)return e.setItem(t,t),e.removeItem(t),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==I.length}return!1}getItem(e){return null!=this.session?this.session.getItem(e):null}setItem(e,t){return null!=this.session&&(this.session.setItem(e,t),!0)}clearMessages(){this.session&&this.session.removeItem("messages")}},l=I,d=class{constructor(){this.storage=E,this.db=h,this.BASE_TIME=60,this.REPOSITORY="indigitall.repository",this.APP_KEY=this.REPOSITORY+".APP_KEY",this.VAPID_PUBLIC=this.REPOSITORY+".VAPID_PUBLIC",this.ENABLED=this.REPOSITORY+".ENABLED",this.DEVICE_ID=this.REPOSITORY+".DEVICE_ID",this.SERVICE_SYNC_TIME=this.REPOSITORY+".SERVICE_SYNC_TIME",this.LOCATION_ENABLED=this.REPOSITORY+".LOCATION_ENABLED",this.LOCATION_UPDATE_MINUTES=this.REPOSITORY+".LOCATION_UPDATE_MINUTES",this.REQUEST_LOCATION=this.REPOSITORY+".REQUEST_LOCATION",this.BROWSER_PUBLIC_KEY=this.REPOSITORY+".BROWSER_PUBLIC_KEY",this.BROWSER_PRIVATE_KEY=this.REPOSITORY+".BROWSER_PRIVATE_KEY",this.PLATFORM=this.REPOSITORY+".PLATFORM",this.BROWSER_NAME=this.REPOSITORY+".BROWSER_NAME",this.BROWSER_VERSION=this.REPOSITORY+".BROWSER_VERSION",this.OS_NAME=this.REPOSITORY+".OS_NAME",this.OS_VERSION=this.REPOSITORY+".OS_VERSION",this.DEVICE_TYPE=this.REPOSITORY+".DEVICE_TYPE",this.SUPPORTED=this.REPOSITORY+".SUPPORTED",this.SERVICE_TIMESTAMP=this.REPOSITORY+".SERVICE_TIMESTAMP",this.LOCATION_TIMESTAMP=this.REPOSITORY+".LOCATION_TIMESTAMP",this.PERMISSION_LOCATION=this.REPOSITORY+".PERMISSION_LOCATION",this.SET_LOG_DEBUG=this.REPOSITORY+".SET_LOG_DEBUG",this.NEW_USER_TIMESTAMP=this.REPOSITORY+".NEW_USER_TIMESTAMP",this.EXTERNAL_ID=this.REPOSITORY+".EXTERNAL_ID",this.REGISTERED_BY_COOKIE=this.REPOSITORY+".REGISTERED_BY_COOKIE",this.LOG_LEVEL=this.REPOSITORY+".LOG_LEVEL",this.LATITUDE=this.REPOSITORY+".LATITUDE",this.LONGITUDE=this.REPOSITORY+".LONGITUDE",this.TOPIC_LIST=this.REPOSITORY+".TOPIC_LIST",this.INAPP_ENABLED=this.REPOSITORY+".INAPP_ENABLED",this.URL_INAPP_API=this.REPOSITORY+".URL_INAPP_API",this.INAPP_TOPICS=this.REPOSITORY+".INAPP_TOPICS"}setItemSessionStorage(e,t){l.setItem(e,t)}getItemSessionStorage(e){return l.getItem(e)}clearSessionStorage(){l.clearMessages()}setStorage(e,t){E.setItem(e,t)}getStorage(e){return E.getItem(e)}clearStorage(){E.clear()}setBrowserPublicKey(e){E.setItem(this.BROWSER_PUBLIC_KEY,e)}getBrowserPublicKey(){return E.getItem(this.BROWSER_PUBLIC_KEY)}setBrowserPrivateKey(e){E.setItem(this.BROWSER_PRIVATE_KEY,e)}getBrowserPrivateKey(){return E.getItem(this.BROWSER_PRIVATE_KEY)}async setAppKey(e){E.setItem(this.APP_KEY,e),h&&h.IDB&&await h.setItem(this.APP_KEY,e)}getAppKey(){return E.getItem(this.APP_KEY)}async getAppKeySync(){if(h&&h.IDB)return await h.getItem(this.APP_KEY)}setVAPID(e){E.setItem(this.VAPID_PUBLIC,e)}getVAPID(){return E.getItem(this.VAPID_PUBLIC)}setEnabled(e){E.setItem(this.ENABLED,e)}getEnabled(){return E.getItem(this.ENABLED)}setServiceSyncTime(e){E.setItem(this.SERVICE_SYNC_TIME,e*this.BASE_TIME)}getServiceSyncTime(){return E.getItem(this.SERVICE_SYNC_TIME)||1*this.BASE_TIME}setLocationEnabled(e){E.setItem(this.LOCATION_ENABLED,e)}getLocationEnabled(){return E.getItem(this.LOCATION_ENABLED)}setLocationUpdateMinutes(e){E.setItem(this.LOCATION_UPDATE_MINUTES,e)}getLocationUpdateMinutes(){return E.getItem(this.LOCATION_UPDATE_MINUTES)||30}async setRequestLocation(e){E.setItem(this.REQUEST_LOCATION,e)}getRequestLocation(){return!!E&&E.getItem(this.REQUEST_LOCATION)}async setPlatform(e){E.setItem(this.PLATFORM,e)}getPlatform(){return E&&E.getItem(this.PLATFORM)||a.platform}getVersion(){return a.version}async setBrowserName(e){E.setItem(this.BROWSER_NAME,e)}getBrowserName(){return E.getItem(this.BROWSER_NAME)}setBrowserVersion(e){E.setItem(this.BROWSER_VERSION,e)}getBrowserVersion(){return E.getItem(this.BROWSER_VERSION)}async setOsName(e){E.setItem(this.OS_NAME,e)}getOsName(){return E.getItem(this.OS_NAME)}setOsVersion(e){E.setItem(this.OS_VERSION,e)}getOsVersion(){return E.getItem(this.OS_VERSION)}setDeviceType(e){E.setItem(this.DEVICE_TYPE,e)}getDeviceType(){return E.getItem(this.DEVICE_TYPE)}setSupported(e){E.setItem(this.SUPPORTED,e)}getSupported(){return E.getItem(this.SUPPORTED)}setServiceTimestamp(e){E.setItem(this.SERVICE_TIMESTAMP,e)}getServiceTimestamp(){return E.getItem(this.SERVICE_TIMESTAMP)}setLocationTimestamp(e){E.setItem(this.LOCATION_TIMESTAMP,e)}getLocationTimestamp(){return E.getItem(this.LOCATION_TIMESTAMP)}setPermissionLocation(e){E.setItem(this.PERMISSION_LOCATION,e)}getPermissionLocation(){return E.getItem(this.PERMISSION_LOCATION)}setDebugLog(e){E.setItem(this.SET_LOG_DEBUG,e)}getDebugLog(){return"false"!==E.getItem(this.SET_LOG_DEBUG)}setLogLevel(e){E.setItem(this.LOG_LEVEL,e)}getLogLevel(){return E.getItem(this.LOG_LEVEL)}setNewUserTimestamp(e){E.setItem(this.NEW_USER_TIMESTAMP,e)}getNewUserTimestamp(){return E.getItem(this.NEW_USER_TIMESTAMP)}async setExternalIdRequest(e){E&&E.isLocalStorageAvailable()&&E.setItem(this.EXTERNAL_ID,e),h&&h.IDB&&await h.setItem(this.EXTERNAL_ID,e)}async getExternalIdRequest(){let e;try{E&&E.isLocalStorageAvailable()?e=E.getItem(this.EXTERNAL_ID):h&&h.IDB&&(e=await h.getItem(this.EXTERNAL_ID))}catch(e){}return e}setExternalId(e){E.setItem(this.EXTERNAL_ID,e)}getExternalId(){return E.getItem(this.EXTERNAL_ID)}async getRegisteredByCookie(){return E.getItem(this.REGISTERED_BY_COOKIE)}async setRegisteredByCookie(e){E.setItem(this.REGISTERED_BY_COOKIE,e)}setLatitude(e){E.setItem(this.LATITUDE,e)}getLatitude(){return E.getItem(this.LATITUDE)}setLongitude(e){E.setItem(this.LONGITUDE,e)}getLongitude(){return E.getItem(this.LONGITUDE)}async setInAppTopicList(e){this.db&&this.db.IDB&&await this.db.setItem(this.INAPP_TOPICS,e)}async getInAppTopicList(){let e;try{this.db&&this.db.IDB&&(e=await this.db.getItem(this.INAPP_TOPICS))}catch(e){}return e}async setTopicList(e){this.db&&this.db.IDB&&await this.db.setItem(this.TOPIC_LIST,e)}async getTopicList(){let e;try{this.db&&this.db.IDB&&(e=await this.db.getItem(this.TOPIC_LIST))}catch(e){}return e}getUrlInappApi(){return this.getStorage(this.URL_INAPP_API)}setUrlInappApi(e){this.setStorage(this.URL_INAPP_API,e)}setInAppEnabled(e){this.setStorage(this.INAPP_ENABLED,e)}isInAppEnabled(){return this.getStorage(this.INAPP_ENABLED)}},R=Object.freeze({DEBUG:1,INFO:2,WARNING:3,ERROR:4}),T=R;class u{constructor(e){this.tag="[IND]",e&&(this.tag=e),this.level=T.INFO,this.setLogLevel((new d).getLogLevel()),this.log=[]}setLogLevel(e){e&&e>=T.DEBUG&&e<=T.ERROR&&(this.level=e)}static addedAsString(e){return"string"==typeof e?e:JSON.stringify(e,null,2)}d(){if(this.level<=T.DEBUG)for(let e=0;e<arguments.length;e++)this.log+=u.addedAsString(arguments[e]);return this}i(){if(this.level<=T.INFO)for(let e=0;e<arguments.length;e++)this.log+=u.addedAsString(arguments[e]);return this}w(){if(this.level<=T.WARNING)for(let e=0;e<arguments.length;e++)this.log+=u.addedAsString(arguments[e]);return this}e(){if(this.level<=T.ERROR)if(1==arguments.length&&arguments.errorCode)this.log+=`${error.errorCode}: ${error.errorMessage}`;else for(let e=0;e<arguments.length;e++)this.log+=u.addedAsString(arguments[e]);return this}writeLog(){this.log.length>0&&this.tag&&this.log&&console.log(this.tag,this.log),this.log=[]}}const _=u,S=class{constructor(e,t,s){this.errorCode=e,this.errorMessage=t,null!=s&&(this.exceptionMessage=s)}},g=new class{constructor(){}showError(e,t,s){if(null!=e){const i=Object.values(e.ErrorCode).indexOf(t);return i>=0?new S(Object.keys(e.ErrorCode)[i],Object.keys(e.ErrorMessage)[i],s):new S(GENERAL_ERROR,"general error",s)}}},p={ErrorCode:{GENERAL_ERROR:600,API_SERVER_ERROR:500,API_PARAMETER_MISSING:400,API_APPKEY_NOT_VALID:401,API_FORBIDDEN_REQUEST:403,API_DEVICE_NOT_FOUND:404,API_TOPICS_ARE_INSERTED:409,BAD_REQUEST_SERVER_ERROR:410},ErrorMessage:{GENERAL_ERROR:"General Error",API_SERVER_ERROR:"Error server response",API_PARAMETER_MISSING:"Api parameter missing",API_APPKEY_NOT_VALID:"appKey is not valid",API_FORBIDDEN_REQUEST:"forbidden request",API_DEVICE_NOT_FOUND:"device not found",API_TOPICS_ARE_INSERTED:"topics are inserted",BAD_REQUEST_SERVER_ERROR:"bad request"}},P=class{constructor(){this.URL_BASE="",this.GET="GET",this.POST="POST",this.PUT="PUT",this.DELETE="DELETE"}async getURL(){return this.URL_BASE}async call(e,t,s,i){const r=new _("[IND]BaseClient: ");s.isServiceWorkerRequest()&&r.setLogLevel(T.DEBUG);let o=await this.getURL()+s.getPath(t)+s.getParams();s.isJourneyRequest()&&(o=o.replace("v1","v2"));const n={method:e,headers:s.addHeaders()};e!==this.GET&&(n.body=JSON.stringify(s.getBody())),i&&(n.credentials=i);try{const t=await fetch(o,n),i=await t.json();return t.ok?(r.d("Method: "+e+"\nURL: "+o+"\n"+(e!==this.GET?"Request Body: "+JSON.stringify(s.getBody(),null,"\t")+"\n":"")+"Response Code: "+i.statusCode+"\nResponse Message: "+i.message+"\nResponse Body:",JSON.stringify(i.data,null,"\t")).writeLog(),i):(r.d("Method: "+e+"\nURL: "+o+"\n"+(e!==this.GET?"Request Body: "+JSON.stringify(s.getBody(),null,"\t")+"\n":"")+"Response Code: "+i.statusCode+"\nResponse Message: "+i.message+"\n").writeLog(),new S(i.statusCode,i.message))}catch(t){return r.d("Method: "+e+"\nURL: "+o+"\n"+(e!==this.GET?"Request Body: "+JSON.stringify(s.getBody(),null,"\t")+"\n":"")+"Error: "+t).writeLog(),g.showError(p,p.ErrorCode.GENERAL_ERROR,t)}}async get(e,t){return await this.call(this.GET,e,t)}async post(e,t,s){return await this.call(this.POST,e,t,s)}async put(e,t,s){return await this.call(this.PUT,e,t,s)}async delete(e,t){return await this.call(this.DELETE,e,t)}},O=class{constructor(){this.PARAM_APP_KEY="appKey",this.PARAM_DEVICE_ID="deviceId",this.PARAM_PUSH_TOKEN="pushToken",this.PARAM_ENABLED="enabled",this.PARAM_PLATFORM="platform",this.PARAM_VERSION="version",this.PARAM_TOPICS="topics",this.PARAM_EVENT_TYPE="eventType",this.PARAM_PUSH_ID="pushId",this.PARAM_CLICKED_BUTTON="clickedButton",this.PARAM_PERMISSION_TYPE="permissionType",this.PARAM_LATITUDE="latitude",this.PARAM_LONGITUDE="longitude",this.PARAM_INAPP_ID="inAppId",this.PARAM_INAPP_EVENT_TYPE="eventType",this.PARAM_INAPP_CLICKED_BUTTON="clickedButton",this.PARAM_INAPP_LAST_VERSION_ID="lastVersionId",this.PARAM_INBOX_EXTERNALID="externalId",this.PARAM_INBOX_PAGE="page",this.PARAM_INBOX_PAGE_SIZE="pageSize",this.PARAM_INBOX_DATE_FROM="dateFrom",this.PARAM_INBOX_DATE_TO="dateTo",this.PARAM_INBOX_STATUS="status",this.PARAM_INBOX_SENDER_IDS="sendingIds",this.PARAM_CUSTOMER_ID="customerId",this.PARAM_CUSTOMER_FIELD_NAMES="fieldNames",this.PARAM_CUSTOMER_FIELDS="fields",this.PARAM_CUSTOMER_LINK="link",this.PARAM_CUSTOMER_CHANNEL="channel",this.appKey=(new d).getAppKey(),this.params=null,this.pathParams={},this.headers={}}getParams(){return"?"+this.PARAM_APP_KEY+"="+this.appKey+(this.params?"&"+this.params:"")}getBody(){return this.body?this.body:""}getPath(e){let t=e;return Object.keys(this.pathParams).forEach((e=>{t=t.replace(e,this.pathParams[e])})),t}addHeaders(){const e=new Headers({"Content-Type":"application/json"});return Object.keys(this.headers).forEach((t=>{e.append(t,this.headers[t])})),e}isServiceWorkerRequest(){return this.serviceWorkerRequest}setServiceWorkerRequest(e){this.serviceWorkerRequest=e}isJourneyRequest(){return this.journeyRequest}setJourneyRequest(e){this.journeyRequest=e}},A=Object.freeze({PUSH:"push",INAPP:"inapp",CHAT:"chat"}),m=class{constructor(e=null,t){null==e?(this.browserPublicKey=(new d).getBrowserPublicKey(),this.browserPrivateKey=(new d).getBrowserPrivateKey(),this.platform=(new d).getPlatform(),this.version=(new d).getVersion(),this.browserName=(new d).getBrowserName(),this.browserVersion=(new d).getBrowserVersion(),this.osName=(new d).getOsName(),this.osVersion=(new d).getOsVersion(),this.deviceType=(new d).getDeviceType(),(new d).getEnabled()&&(this.enabled="true"===(new d).getEnabled()),(new d).getExternalId()&&(this.externalCode=(new d).getExternalId())):t?(e.enabled&&(this.enabled=e.enabled,(new d).setEnabled(this.enabled)),e.registeredByCookie&&(this.registeredByCookie=e.registeredByCookie,(new d).setRegisteredByCookie(this.registeredByCookie))):(e.browserPublicKey&&(this.browserPublicKey=e.browserPublicKey),e.browserPrivateKey&&(this.browserPrivateKey=e.browserPrivateKey),e.platform&&(this.platform=e.platform),e.version&&(this.version=e.version),e.osVersion&&(this.osVersion=e.osVersion),e.browserName&&(this.browserName=e.browserName),e.browserVersion&&(this.browserVersion=e.browserVersion),e.osName&&(this.osName=e.osName),e.deviceType&&(this.deviceType=e.deviceType),e.enabled&&(this.enabled=e.enabled),e.externalCode&&(this.externalCode=e.externalCode)),this.platform&&(this.productName=this.platform),this.version&&(this.productVersion=this.version),navigator&&"language"in navigator&&(this.locale=navigator.language),Intl&&"DateTimeFormat"in Intl&&(this.timeZone=Intl.DateTimeFormat().resolvedOptions().timeZone),this.timeOffset=-(new Date).getTimezoneOffset()}getDeviceId(){return this.deviceId}setDeviceId(e){this.deviceId=e}setExternalCode(e){this.externalCode=e}toJSON(){const e={};return this.platform&&(e.platform=this.platform),this.version&&(e.version=this.version),this.productName&&(e.productName=this.productName),this.productVersion&&(e.productVersion=this.productVersion),this.browserName&&(e.browserName=this.browserName),this.browserVersion&&(e.browserVersion=this.browserVersion),this.osName&&(e.osName=this.osName),this.osVersion&&(e.osVersion=this.osVersion),this.deviceType&&(e.deviceType=this.deviceType),this.locale&&(e.locale=this.locale),this.timeZone&&(e.timeZome=this.timeZone),this.timeOffset&&(e.timeOffset=this.timeOffset),this.enabled&&(e.enabled=this.enabled),this.browserPublicKey&&(e.browserPublicKey=this.browserPublicKey),this.browserPrivateKey&&(e.browserPrivateKey=this.browserPrivateKey),this.externalCode&&(e.externalCode=this.externalCode),e}},N=Object.freeze({DEFAULT:-1,ENABLE:1,DISABLE:0}),y=Object.freeze({EVENT_TYPE_CLICK:"click",EVENT_TYPE_RECEIVE:"receive",EVENT_TYPE_UPDATE:"update",EVENT_TYPE_ACCEPT:"accept",EVENT_TYPE_REJECT:"reject",EVENT_TYPE_ASK:"ask"}),C=Object.freeze({SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe"}),D=class{static isServiceTimestampExceed(){return!(new d).getServiceTimestamp()||(new d).getServiceSyncTime()<=(Date.now()-(new d).getServiceTimestamp())/6e4}static isFunction(e){return!(!e||"function"!=typeof e)}},v=class{static async getPermissions(){const e=await this.getPermission("geolocation"),t={};return e&&(t.location=e.state),t}static async getPermission(e){try{if(navigator&&navigator.permissions&&navigator.permissions.query&&e)return await navigator.permissions.query({name:e,userVisibleOnly:!0})}catch(e){return null}return null}static async setPermissionsCallback(){await this.setCallback("geolocation",navigator.indigitallRequestLocationPermission)}static async setCallback(e,t){const s=await this.getPermission(e);if(s){let i=s.state;"onchange"in s&&(s.onchange=()=>{new _("[IND]CorePermissions: ").d(e+" permission state has changed from "+i+" to "+s.state).writeLog(),i=s.state,t&&t({name:e,state:s.state})})}}},L=new _("[IND]Crypto"),w=new TextEncoder("utf-8"),b="HMAC",B=class{static async createHmac(e,t){try{const s=window?.crypto?.subtle;if(!s)return;const i=await s.importKey("raw",w.encode(e),{name:b,hash:{name:"SHA-256"}},!1,["sign","verify"]),r=await s.sign(b,i,w.encode(t)),o=new Uint8Array(r),n=Array.prototype.map.call(o,(e=>("00"+e.toString(16)).slice(-2))).join("");return L.d("hmac: ",n).writeLog(),n}catch(e){return void L.e("error:",e).writeLog()}}},U=class{static compareJSON(e,t){const s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!1;for(const i of s)if(e[i]!==t[i]){if("object"!=typeof e[i]||"object"!=typeof t[i])return!1;if(!isEqual(e[i],t[i]))return!1}return!0}},f=class{static isValidFormat(e){return null!=e&&""!=e&&"null"!=e&&e.length>8}},M=class{static setTopicChannel(e,t){const s=[];for(let i=0;i<e.length;i++){const r=e[i];r.channel=t,s.push(r)}return s}},V={Repository:d,Config:a,Api:e,Models:t,Utils:r}})(),i})(),e.exports=t()},916:(e,t,s)=>{"use strict";s.d(t,{Core:()=>K});var i={};s.r(i),s.d(i,{BaseClient:()=>A,BaseRequest:()=>m});var r={};s.r(r),s.d(r,{Channel:()=>N,Device:()=>y,DeviceStatus:()=>C,ErrorDictionary:()=>O,ErrorModel:()=>g,EventType:()=>D,TopicSubscribeType:()=>v});var o={};s.r(o),s.d(o,{CommonUtils:()=>L,CorePermissions:()=>w,CryptoUtils:()=>f,ErrorUtils:()=>p,JsonUtils:()=>M,Log:()=>S,LogLevel:()=>T,TopicUtils:()=>Y,Validations:()=>V});s(923);var n={platform:"webpush",version:"0.0.1"};const a=s(391);n.version=a.version;const c=n=Object.assign(n,{client:{URL_BASE:"https://device-api.indigitall.com/v1",URL_DEVICE_V2:"https://device-api.indigitall.com/v2",INAPP_URL_BASE:"https://inapp-api.indigitall.com/v1",INBOX_URL_BASE:"https://inbox-api.indigitall.com/v1",CUSTOMER_URL_BASE:"https://device-api.indigitall.com/v2"}});const E=new class{constructor(){this.storage=this.isLocalStorageAvailable()?window.localStorage:null}isLocalStorageAvailable(){try{const e=window.localStorage,t="__storage_test__";if(e)return e.setItem(t,t),e.removeItem(t),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==E.length}return!1}setItem(e,t){return null!=this.storage&&(this.storage.setItem(e,t),!0)}getItem(e){return null!=this.storage?this.storage.getItem(e):null}deleteItem(e){return!!this.storage&&(this.storage.setItem(e,value),!0)}clear(){this.storage&&this.storage.clear()}},h=E;const I=new class{constructor(){this.TAG="[IND]IndexedDB: ",this.DB_NAME="indigitall.indexedDB",this.DB_VERSION=1,this.DB_STORE_NAME="indigitallStore",this.DB_STORE_MODE="readwrite",this.DB_KEY_PATH="id",this.DB_STORE_INDEX="storeIndex",this.IDB=indexedDB||mozzIndexedDB||webkitIndexedDB||msIndexedDB}async getDB(){return new Promise(((e,t)=>{const s=this.IDB;if(s){const i=s.open("indigitall.indexedDB",1);i.onupgradeneeded=function(){i.result.createObjectStore("indigitallStore").createIndex("storeIndex","store.key")},i.onsuccess=function(){const t=i.result,s=t.transaction("indigitallStore","readwrite"),r=s.objectStore("indigitallStore"),o=r.index("storeIndex");e({db:t,tx:s,store:r,index:o})},i.onerror=function(e){t(e)}}else t(!1)}))}async get(e,t){return new Promise(((s,i)=>{e||i(!1),e.index.get(t).onsuccess=t=>{t.target.result&&(this.close(e),s(t.target.result.store.value)),i(!1)}}))}async put(e,t,s){return new Promise(((i,r)=>{e||r(!1),e.store.put({store:{key:t,value:s}},t).onsuccess=t=>{this.close(e),i(s)}}))}close(e){if(e.tx)try{e.tx.oncomplete=()=>{e.db.close()}}catch(e){console.error(this.TAG,e)}}async setItem(e,t){try{const s=await this.getDB();return this.put(s,e,t)}catch(e){return e}}async getItem(e){try{const t=await this.getDB();return this.get(t,e)}catch(e){return e}}};const l=new class{constructor(){this.SESSION="indigitall.session.storage",this.session=this.isSessionStorageAvailable()?window.sessionStorage:null}isSessionStorageAvailable(){try{const e=window.sessionStorage,t="__storage_test__";if(e)return e.setItem(t,t),e.removeItem(t),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==l.length}return!1}getItem(e){return null!=this.session?this.session.getItem(e):null}setItem(e,t){return null!=this.session&&(this.session.setItem(e,t),!0)}clearMessages(){this.session&&this.session.removeItem("messages")}},d=l;const R=class{constructor(){this.storage=h,this.db=I,this.BASE_TIME=60,this.REPOSITORY="indigitall.repository",this.APP_KEY=this.REPOSITORY+".APP_KEY",this.VAPID_PUBLIC=this.REPOSITORY+".VAPID_PUBLIC",this.ENABLED=this.REPOSITORY+".ENABLED",this.DEVICE_ID=this.REPOSITORY+".DEVICE_ID",this.SERVICE_SYNC_TIME=this.REPOSITORY+".SERVICE_SYNC_TIME",this.LOCATION_ENABLED=this.REPOSITORY+".LOCATION_ENABLED",this.LOCATION_UPDATE_MINUTES=this.REPOSITORY+".LOCATION_UPDATE_MINUTES",this.REQUEST_LOCATION=this.REPOSITORY+".REQUEST_LOCATION",this.BROWSER_PUBLIC_KEY=this.REPOSITORY+".BROWSER_PUBLIC_KEY",this.BROWSER_PRIVATE_KEY=this.REPOSITORY+".BROWSER_PRIVATE_KEY",this.PLATFORM=this.REPOSITORY+".PLATFORM",this.BROWSER_NAME=this.REPOSITORY+".BROWSER_NAME",this.BROWSER_VERSION=this.REPOSITORY+".BROWSER_VERSION",this.OS_NAME=this.REPOSITORY+".OS_NAME",this.OS_VERSION=this.REPOSITORY+".OS_VERSION",this.DEVICE_TYPE=this.REPOSITORY+".DEVICE_TYPE",this.SUPPORTED=this.REPOSITORY+".SUPPORTED",this.SERVICE_TIMESTAMP=this.REPOSITORY+".SERVICE_TIMESTAMP",this.LOCATION_TIMESTAMP=this.REPOSITORY+".LOCATION_TIMESTAMP",this.PERMISSION_LOCATION=this.REPOSITORY+".PERMISSION_LOCATION",this.SET_LOG_DEBUG=this.REPOSITORY+".SET_LOG_DEBUG",this.NEW_USER_TIMESTAMP=this.REPOSITORY+".NEW_USER_TIMESTAMP",this.EXTERNAL_ID=this.REPOSITORY+".EXTERNAL_ID",this.REGISTERED_BY_COOKIE=this.REPOSITORY+".REGISTERED_BY_COOKIE",this.LOG_LEVEL=this.REPOSITORY+".LOG_LEVEL",this.LATITUDE=this.REPOSITORY+".LATITUDE",this.LONGITUDE=this.REPOSITORY+".LONGITUDE",this.TOPIC_LIST=this.REPOSITORY+".TOPIC_LIST",this.INAPP_ENABLED=this.REPOSITORY+".INAPP_ENABLED",this.URL_INAPP_API=this.REPOSITORY+".URL_INAPP_API",this.INAPP_TOPICS=this.REPOSITORY+".INAPP_TOPICS"}setItemSessionStorage(e,t){d.setItem(e,t)}getItemSessionStorage(e){return d.getItem(e)}clearSessionStorage(){d.clearMessages()}setStorage(e,t){h.setItem(e,t)}getStorage(e){return h.getItem(e)}clearStorage(){h.clear()}setBrowserPublicKey(e){h.setItem(this.BROWSER_PUBLIC_KEY,e)}getBrowserPublicKey(){return h.getItem(this.BROWSER_PUBLIC_KEY)}setBrowserPrivateKey(e){h.setItem(this.BROWSER_PRIVATE_KEY,e)}getBrowserPrivateKey(){return h.getItem(this.BROWSER_PRIVATE_KEY)}async setAppKey(e){h.setItem(this.APP_KEY,e),I&&I.IDB&&await I.setItem(this.APP_KEY,e)}getAppKey(){return h.getItem(this.APP_KEY)}async getAppKeySync(){if(I&&I.IDB)return await I.getItem(this.APP_KEY)}setVAPID(e){h.setItem(this.VAPID_PUBLIC,e)}getVAPID(){return h.getItem(this.VAPID_PUBLIC)}setEnabled(e){h.setItem(this.ENABLED,e)}getEnabled(){return h.getItem(this.ENABLED)}setServiceSyncTime(e){h.setItem(this.SERVICE_SYNC_TIME,e*this.BASE_TIME)}getServiceSyncTime(){const e=h.getItem(this.SERVICE_SYNC_TIME);return e||1*this.BASE_TIME}setLocationEnabled(e){h.setItem(this.LOCATION_ENABLED,e)}getLocationEnabled(){return h.getItem(this.LOCATION_ENABLED)}setLocationUpdateMinutes(e){h.setItem(this.LOCATION_UPDATE_MINUTES,e)}getLocationUpdateMinutes(){const e=h.getItem(this.LOCATION_UPDATE_MINUTES);return e||30}async setRequestLocation(e){h.setItem(this.REQUEST_LOCATION,e)}getRequestLocation(){return!!h&&h.getItem(this.REQUEST_LOCATION)}async setPlatform(e){h.setItem(this.PLATFORM,e)}getPlatform(){return h&&h.getItem(this.PLATFORM)||c.platform}getVersion(){return c.version}async setBrowserName(e){h.setItem(this.BROWSER_NAME,e)}getBrowserName(){return h.getItem(this.BROWSER_NAME)}setBrowserVersion(e){h.setItem(this.BROWSER_VERSION,e)}getBrowserVersion(){return h.getItem(this.BROWSER_VERSION)}async setOsName(e){h.setItem(this.OS_NAME,e)}getOsName(){return h.getItem(this.OS_NAME)}setOsVersion(e){h.setItem(this.OS_VERSION,e)}getOsVersion(){return h.getItem(this.OS_VERSION)}setDeviceType(e){h.setItem(this.DEVICE_TYPE,e)}getDeviceType(){return h.getItem(this.DEVICE_TYPE)}setSupported(e){h.setItem(this.SUPPORTED,e)}getSupported(){return h.getItem(this.SUPPORTED)}setServiceTimestamp(e){h.setItem(this.SERVICE_TIMESTAMP,e)}getServiceTimestamp(){return h.getItem(this.SERVICE_TIMESTAMP)}setLocationTimestamp(e){h.setItem(this.LOCATION_TIMESTAMP,e)}getLocationTimestamp(){return h.getItem(this.LOCATION_TIMESTAMP)}setPermissionLocation(e){h.setItem(this.PERMISSION_LOCATION,e)}getPermissionLocation(){return h.getItem(this.PERMISSION_LOCATION)}setDebugLog(e){h.setItem(this.SET_LOG_DEBUG,e)}getDebugLog(){return"false"!==h.getItem(this.SET_LOG_DEBUG)}setLogLevel(e){h.setItem(this.LOG_LEVEL,e)}getLogLevel(){return h.getItem(this.LOG_LEVEL)}setNewUserTimestamp(e){h.setItem(this.NEW_USER_TIMESTAMP,e)}getNewUserTimestamp(){return h.getItem(this.NEW_USER_TIMESTAMP)}async setExternalIdRequest(e){h&&h.isLocalStorageAvailable()&&h.setItem(this.EXTERNAL_ID,e),I&&I.IDB&&await I.setItem(this.EXTERNAL_ID,e)}async getExternalIdRequest(){let e;try{h&&h.isLocalStorageAvailable()?e=h.getItem(this.EXTERNAL_ID):I&&I.IDB&&(e=await I.getItem(this.EXTERNAL_ID))}catch(e){}return e}setExternalId(e){h.setItem(this.EXTERNAL_ID,e)}getExternalId(){return h.getItem(this.EXTERNAL_ID)}async getRegisteredByCookie(){return h.getItem(this.REGISTERED_BY_COOKIE)}async setRegisteredByCookie(e){h.setItem(this.REGISTERED_BY_COOKIE,e)}setLatitude(e){h.setItem(this.LATITUDE,e)}getLatitude(){return h.getItem(this.LATITUDE)}setLongitude(e){h.setItem(this.LONGITUDE,e)}getLongitude(){return h.getItem(this.LONGITUDE)}async setInAppTopicList(e){this.db&&this.db.IDB&&await this.db.setItem(this.INAPP_TOPICS,e)}async getInAppTopicList(){let e;try{this.db&&this.db.IDB&&(e=await this.db.getItem(this.INAPP_TOPICS))}catch(e){}return e}async setTopicList(e){this.db&&this.db.IDB&&await this.db.setItem(this.TOPIC_LIST,e)}async getTopicList(){let e;try{this.db&&this.db.IDB&&(e=await this.db.getItem(this.TOPIC_LIST))}catch(e){}return e}getUrlInappApi(){return this.getStorage(this.URL_INAPP_API)}setUrlInappApi(e){this.setStorage(this.URL_INAPP_API,e)}setInAppEnabled(e){this.setStorage(this.INAPP_ENABLED,e)}isInAppEnabled(){return this.getStorage(this.INAPP_ENABLED)}},T=Object.freeze({DEBUG:1,INFO:2,WARNING:3,ERROR:4}),u=T;class _{constructor(e){this.tag="[IND]",e&&(this.tag=e),this.level=u.INFO,this.setLogLevel((new R).getLogLevel()),this.log=[]}setLogLevel(e){e&&e>=u.DEBUG&&e<=u.ERROR&&(this.level=e)}static addedAsString(e){return"string"==typeof e?e:JSON.stringify(e,null,2)}d(){if(this.level<=u.DEBUG)for(let e=0;e<arguments.length;e++)this.log+=_.addedAsString(arguments[e]);return this}i(){if(this.level<=u.INFO)for(let e=0;e<arguments.length;e++)this.log+=_.addedAsString(arguments[e]);return this}w(){if(this.level<=u.WARNING)for(let e=0;e<arguments.length;e++)this.log+=_.addedAsString(arguments[e]);return this}e(){if(this.level<=u.ERROR)if(1==arguments.length&&arguments.errorCode)this.log+=`${error.errorCode}: ${error.errorMessage}`;else for(let e=0;e<arguments.length;e++)this.log+=_.addedAsString(arguments[e]);return this}writeLog(){this.log.length>0&&this.tag&&this.log&&console.log(this.tag,this.log),this.log=[]}}const S=_;const g=class{constructor(e,t,s){this.errorCode=e,this.errorMessage=t,null!=s&&(this.exceptionMessage=s)}};const p=new class{constructor(){}showError(e,t,s){if(null!=e){const i=Object.values(e.ErrorCode).indexOf(t);return i>=0?new g(Object.keys(e.ErrorCode)[i],Object.keys(e.ErrorMessage)[i],s):new g(GENERAL_ERROR,"general error",s)}}},P={GENERAL_ERROR:600,API_SERVER_ERROR:500,API_PARAMETER_MISSING:400,API_APPKEY_NOT_VALID:401,API_FORBIDDEN_REQUEST:403,API_DEVICE_NOT_FOUND:404,API_TOPICS_ARE_INSERTED:409,BAD_REQUEST_SERVER_ERROR:410};const O={ErrorCode:P,ErrorMessage:{GENERAL_ERROR:"General Error",API_SERVER_ERROR:"Error server response",API_PARAMETER_MISSING:"Api parameter missing",API_APPKEY_NOT_VALID:"appKey is not valid",API_FORBIDDEN_REQUEST:"forbidden request",API_DEVICE_NOT_FOUND:"device not found",API_TOPICS_ARE_INSERTED:"topics are inserted",BAD_REQUEST_SERVER_ERROR:"bad request"}};const A=class{constructor(){this.URL_BASE="",this.GET="GET",this.POST="POST",this.PUT="PUT",this.DELETE="DELETE"}async getURL(){return this.URL_BASE}async call(e,t,s,i){const r=new S("[IND]BaseClient: ");s.isServiceWorkerRequest()&&r.setLogLevel(u.DEBUG);let o=await this.getURL()+s.getPath(t)+s.getParams();s.isJourneyRequest()&&(o=o.replace("v1","v2"));const n={method:e,headers:s.addHeaders()};e!==this.GET&&(n.body=JSON.stringify(s.getBody())),i&&(n.credentials=i);try{const t=await fetch(o,n),i=await t.json();return t.ok?(r.d("Method: "+e+"\nURL: "+o+"\n"+(e!==this.GET?"Request Body: "+JSON.stringify(s.getBody(),null,"\t")+"\n":"")+"Response Code: "+i.statusCode+"\nResponse Message: "+i.message+"\nResponse Body:",JSON.stringify(i.data,null,"\t")).writeLog(),i):(r.d("Method: "+e+"\nURL: "+o+"\n"+(e!==this.GET?"Request Body: "+JSON.stringify(s.getBody(),null,"\t")+"\n":"")+"Response Code: "+i.statusCode+"\nResponse Message: "+i.message+"\n").writeLog(),new g(i.statusCode,i.message))}catch(t){return r.d("Method: "+e+"\nURL: "+o+"\n"+(e!==this.GET?"Request Body: "+JSON.stringify(s.getBody(),null,"\t")+"\n":"")+"Error: "+t).writeLog(),p.showError(O,O.ErrorCode.GENERAL_ERROR,t)}}async get(e,t){return await this.call(this.GET,e,t)}async post(e,t,s){return await this.call(this.POST,e,t,s)}async put(e,t,s){return await this.call(this.PUT,e,t,s)}async delete(e,t){return await this.call(this.DELETE,e,t)}};const m=class{constructor(){this.PARAM_APP_KEY="appKey",this.PARAM_DEVICE_ID="deviceId",this.PARAM_PUSH_TOKEN="pushToken",this.PARAM_ENABLED="enabled",this.PARAM_PLATFORM="platform",this.PARAM_VERSION="version",this.PARAM_TOPICS="topics",this.PARAM_EVENT_TYPE="eventType",this.PARAM_PUSH_ID="pushId",this.PARAM_CLICKED_BUTTON="clickedButton",this.PARAM_PERMISSION_TYPE="permissionType",this.PARAM_LATITUDE="latitude",this.PARAM_LONGITUDE="longitude",this.PARAM_INAPP_ID="inAppId",this.PARAM_INAPP_EVENT_TYPE="eventType",this.PARAM_INAPP_CLICKED_BUTTON="clickedButton",this.PARAM_INAPP_LAST_VERSION_ID="lastVersionId",this.PARAM_INBOX_EXTERNALID="externalId",this.PARAM_INBOX_PAGE="page",this.PARAM_INBOX_PAGE_SIZE="pageSize",this.PARAM_INBOX_DATE_FROM="dateFrom",this.PARAM_INBOX_DATE_TO="dateTo",this.PARAM_INBOX_STATUS="status",this.PARAM_INBOX_SENDER_IDS="sendingIds",this.PARAM_CUSTOMER_ID="customerId",this.PARAM_CUSTOMER_FIELD_NAMES="fieldNames",this.PARAM_CUSTOMER_FIELDS="fields",this.PARAM_CUSTOMER_LINK="link",this.PARAM_CUSTOMER_CHANNEL="channel",this.appKey=(new R).getAppKey(),this.params=null,this.pathParams={},this.headers={}}getParams(){return"?"+this.PARAM_APP_KEY+"="+this.appKey+(this.params?"&"+this.params:"")}getBody(){return this.body?this.body:""}getPath(e){let t=e;return Object.keys(this.pathParams).forEach((e=>{t=t.replace(e,this.pathParams[e])})),t}addHeaders(){const e=new Headers({"Content-Type":"application/json"});return Object.keys(this.headers).forEach((t=>{e.append(t,this.headers[t])})),e}isServiceWorkerRequest(){return this.serviceWorkerRequest}setServiceWorkerRequest(e){this.serviceWorkerRequest=e}isJourneyRequest(){return this.journeyRequest}setJourneyRequest(e){this.journeyRequest=e}},N=Object.freeze({PUSH:"push",INAPP:"inapp",CHAT:"chat"});const y=class{constructor(e=null,t){null==e?(this.browserPublicKey=(new R).getBrowserPublicKey(),this.browserPrivateKey=(new R).getBrowserPrivateKey(),this.platform=(new R).getPlatform(),this.version=(new R).getVersion(),this.browserName=(new R).getBrowserName(),this.browserVersion=(new R).getBrowserVersion(),this.osName=(new R).getOsName(),this.osVersion=(new R).getOsVersion(),this.deviceType=(new R).getDeviceType(),(new R).getEnabled()&&(this.enabled="true"===(new R).getEnabled()),(new R).getExternalId()&&(this.externalCode=(new R).getExternalId())):t?(e.enabled&&(this.enabled=e.enabled,(new R).setEnabled(this.enabled)),e.registeredByCookie&&(this.registeredByCookie=e.registeredByCookie,(new R).setRegisteredByCookie(this.registeredByCookie))):(e.browserPublicKey&&(this.browserPublicKey=e.browserPublicKey),e.browserPrivateKey&&(this.browserPrivateKey=e.browserPrivateKey),e.platform&&(this.platform=e.platform),e.version&&(this.version=e.version),e.osVersion&&(this.osVersion=e.osVersion),e.browserName&&(this.browserName=e.browserName),e.browserVersion&&(this.browserVersion=e.browserVersion),e.osName&&(this.osName=e.osName),e.deviceType&&(this.deviceType=e.deviceType),e.enabled&&(this.enabled=e.enabled),e.externalCode&&(this.externalCode=e.externalCode)),this.platform&&(this.productName=this.platform),this.version&&(this.productVersion=this.version),navigator&&"language"in navigator&&(this.locale=navigator.language),Intl&&"DateTimeFormat"in Intl&&(this.timeZone=Intl.DateTimeFormat().resolvedOptions().timeZone),this.timeOffset=-(new Date).getTimezoneOffset()}getDeviceId(){return this.deviceId}setDeviceId(e){this.deviceId=e}setExternalCode(e){this.externalCode=e}toJSON(){const e={};return this.platform&&(e.platform=this.platform),this.version&&(e.version=this.version),this.productName&&(e.productName=this.productName),this.productVersion&&(e.productVersion=this.productVersion),this.browserName&&(e.browserName=this.browserName),this.browserVersion&&(e.browserVersion=this.browserVersion),this.osName&&(e.osName=this.osName),this.osVersion&&(e.osVersion=this.osVersion),this.deviceType&&(e.deviceType=this.deviceType),this.locale&&(e.locale=this.locale),this.timeZone&&(e.timeZome=this.timeZone),this.timeOffset&&(e.timeOffset=this.timeOffset),this.enabled&&(e.enabled=this.enabled),this.browserPublicKey&&(e.browserPublicKey=this.browserPublicKey),this.browserPrivateKey&&(e.browserPrivateKey=this.browserPrivateKey),this.externalCode&&(e.externalCode=this.externalCode),e}},C=Object.freeze({DEFAULT:-1,ENABLE:1,DISABLE:0}),D=Object.freeze({EVENT_TYPE_CLICK:"click",EVENT_TYPE_RECEIVE:"receive",EVENT_TYPE_UPDATE:"update",EVENT_TYPE_ACCEPT:"accept",EVENT_TYPE_REJECT:"reject",EVENT_TYPE_ASK:"ask"}),v=Object.freeze({SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe"});const L=class{static isServiceTimestampExceed(){return!(new R).getServiceTimestamp()||(new R).getServiceSyncTime()<=(Date.now()-(new R).getServiceTimestamp())/6e4}static isFunction(e){return!(!e||"function"!=typeof e)}};const w=class{static async getPermissions(){const e=await this.getPermission("geolocation"),t={};return e&&(t.location=e.state),t}static async getPermission(e){try{if(navigator&&navigator.permissions&&navigator.permissions.query&&e)return await navigator.permissions.query({name:e,userVisibleOnly:!0})}catch(e){return null}return null}static async setPermissionsCallback(){await this.setCallback("geolocation",navigator.indigitallRequestLocationPermission)}static async setCallback(e,t){const s=await this.getPermission(e);if(s){let i=s.state;"onchange"in s&&(s.onchange=()=>{new S("[IND]CorePermissions: ").d(e+" permission state has changed from "+i+" to "+s.state).writeLog(),i=s.state,t&&t({name:e,state:s.state})})}}},b=new S("[IND]Crypto"),B=new TextEncoder("utf-8"),U="HMAC";const f=class{static async createHmac(e,t){try{const s=window?.crypto?.subtle;if(!s)return;const i=await s.importKey("raw",B.encode(e),{name:U,hash:{name:"SHA-256"}},!1,["sign","verify"]),r=await s.sign(U,i,B.encode(t)),o=new Uint8Array(r),n=Array.prototype.map.call(o,(e=>("00"+e.toString(16)).slice(-2))).join("");return b.d("hmac: ",n).writeLog(),n}catch(e){return void b.e("error:",e).writeLog()}}};const M=class{static compareJSON(e,t){const s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!1;for(const i of s)if(e[i]!==t[i]){if("object"!=typeof e[i]||"object"!=typeof t[i])return!1;if(!isEqual(e[i],t[i]))return!1}return!0}};const V=class{static isValidFormat(e){return null!=e&&""!=e&&"null"!=e&&e.length>8}};const Y=class{static setTopicChannel(e,t){const s=[];for(let i=0;i<e.length;i++){const r=e[i];r.channel=t,s.push(r)}return s}},K={Repository:R,Config:c,Api:i,Models:r,Utils:o}},391:e=>{"use strict";e.exports=JSON.parse('{"name":"indigitall-web-core","description":"indigitall web core","version":"4.3.1","main":"index.js","author":"Smart2me S.L.","homepage":"https://indigitall.com","devDependencies":{"@babel/preset-env":"^7.18.10","babel-loader":"^8.2.5","filemanager-webpack-plugin":"^7.0.0","idempotent-babel-polyfill":"^7.4.4","script-loader":"^0.7.2","webpack":"^5.74.0","webpack-bundle-analyzer":"^4.6.1","webpack-cli":"^4.10.0"},"scripts":{"test":"echo \'There are not tests\'","public":"ws --directory ./public --port 80 --log.format dev","build":"webpack --config webpack.config.js --mode=production","build-dev":"webpack --config webpack.config.js --watch --mode=development","delete-node-modules":"rm -rf node_modules/ && rm -f package-lock.json","install-core":"npm install && npm run build"}}')}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,s),o.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{"use strict";s.r(i);const e=new class{constructor(){this.TOPIC_SYNC_TIMESTAMP=3e4,this.TOPIC_SYNC_TAG="syncTopics",this.TOPIC_SYNC_SUBSCRIBE_CALLBACK="indigitallSyncTopicSubscribeOnSuccess",this.TOPIC_SYNC_SUBSCRIBE_ERROR_CALLBACK="indigitallSyncTopicSubscribeOnError",this.TOPIC_SYNC_UNSUBSCRIBE_CALLBACK="indigitallSyncTopicUnsubscribeOnSuccess",this.TOPIC_SYNC_UNSUBSCRIBE_ERROR_CALLBACK="indigitallSyncTopicUnsubscribeOnError"}},{Repository:t}=s(916).Core;const r=new class extends t{constructor(){super(),this.SAFARI_WEBSITE_PUSH_ID=this.REPOSITORY+".SAFARI_WEBSITE_PUSH_ID",this.PUSH_TOKEN=this.REPOSITORY+".PUSH_TOKEN",this.PERMISSION_PUSH=this.REPOSITORY+".PERMISSION_PUSH",this.URL_DEVICE_API=this.REPOSITORY+".URL_DEVICE_API",this.DEVICE_JSON=this.REPOSITORY+".DEVICE_JSON",this.PUT_REQUEST_TIMESTAMP=this.REPOSITORY+".PUT_REQUEST_TIMESTAMP",this.WORKER_PATH=this.REPOSITORY+".WORKER_PATH",this.TEST=this.REPOSITORY+".TEST",this.SAFARI_GESTURE_REQUEST_PERMISSION=this.REPOSITORY+".SAFARI_GESTURE_REQUEST_PERMISSION",this.UPDATE_TOPIC_SUBSCRIBE=this.REPOSITORY+".UPDATE_TOPIC_SUBSCRIBE",this.TOPIC_SYNC_TIMESTAMP=this.REPOSITORY+".TOPIC_SYNC_TIMESTAMP",this.TOPIC_SEMAPHORE=this.REPOSITORY+".TOPIC_SEMAPHORE",this.TOPIC_SYNC_IS_PROCESSING=this.REPOSITORY+".TOPIC_SYNC_IS_PROCESSING"}async setDeviceId(e){this.storage&&this.storage.isLocalStorageAvailable()&&this.setStorage(this.DEVICE_ID,e),this.db&&this.db.IDB&&await this.db.setItem(this.DEVICE_ID,e)}getDeviceId(){return this.getStorage(this.DEVICE_ID)}async getDeviceIdSync(){if(this.db&&this.db.IDB)return await this.db.getItem(this.DEVICE_ID)}setPushToken(e){this.setStorage(this.PUSH_TOKEN,e)}getPushToken(){return this.getStorage(this.PUSH_TOKEN)}setSafariWebsitePushId(e){this.setStorage(this.SAFARI_WEBSITE_PUSH_ID,e)}getSafariWebsitePushId(){return this.getStorage(this.SAFARI_WEBSITE_PUSH_ID)}setPermissionPush(e){this.setStorage(this.PERMISSION_PUSH,e)}getPermissionPush(){return this.getStorage(this.PERMISSION_PUSH)}async getUrlDeviceApi(){let e;try{this.storage&&this.storage.isLocalStorageAvailable()?e=this.getStorage(this.URL_DEVICE_API):this.db&&this.db.IDB&&(e=await this.db.getItem(this.URL_DEVICE_API))}catch(e){}return e}async setUrlDeviceApi(e){this.storage&&this.storage.isLocalStorageAvailable()&&this.setStorage(this.URL_DEVICE_API,e),this.db&&this.db.IDB&&await this.db.setItem(this.URL_DEVICE_API,e)}async getDeviceJson(){return this.getStorage(this.DEVICE_JSON)}async setDeviceJson(e){this.setStorage(this.DEVICE_JSON,e)}async getPutRequestTimestamp(){return this.getStorage(this.PUT_REQUEST_TIMESTAMP)}async setPutRequestTimestamp(e){this.setStorage(this.PUT_REQUEST_TIMESTAMP,e)}setWorkerPath(e){this.setStorage(this.WORKER_PATH,e)}getWorkerPath(){return this.getStorage(this.WORKER_PATH)}setTestValue(e){this.setStorage(this.TEST,e)}getTestValue(){return this.getStorage(this.TEST)}setSafariGestureRequestPermission(e){this.setStorage(this.SAFARI_GESTURE_REQUEST_PERMISSION,e)}getSafariGestureRequestPermission(){return this.getStorage(this.SAFARI_GESTURE_REQUEST_PERMISSION)}async setUpdateTopicSubscribe(e){this.db&&this.db.IDB&&await this.db.setItem(this.UPDATE_TOPIC_SUBSCRIBE,e)}async getUpdateTopicSubscribe(){let e;try{this.db&&this.db.IDB&&(e=await this.db.getItem(this.UPDATE_TOPIC_SUBSCRIBE))}catch(e){}return e}async setTopicSyncTimestamp(e){this.db&&this.db.IDB&&await this.db.setItem(this.TOPIC_SYNC_TIMESTAMP,e)}async getTopicSyncTimestamp(){let e;try{this.db&&this.db.IDB&&(e=await this.db.getItem(this.TOPIC_SYNC_TIMESTAMP))}catch(e){}return e}async setTopicSemaphore(e){this.db&&this.db.IDB&&await this.db.setItem(this.TOPIC_SEMAPHORE,e)}async getTopicSemaphore(){let e;try{this.db&&this.db.IDB&&(e=await this.db.getItem(this.TOPIC_SEMAPHORE))}catch(e){}return e}async setTopicSyncIsProcessing(e){this.db&&this.db.IDB&&await this.db.setItem(this.TOPIC_SYNC_IS_PROCESSING,e)}async getTopicSyncIsProcessing(){let e;try{this.db&&this.db.IDB&&(e=await this.db.getItem(this.TOPIC_SYNC_IS_PROCESSING))}catch(e){}return e}},{ErrorDictionary:o}=s(916).Core.Models,n=o.ErrorCode;Object.assign(n,{GENERAL_ERROR_BAD_REQUEST:601,GENERAL_ERROR_APPKEY_BAD_REQUEST:602,PUSH_INITIALIZATION_ERROR:1e3,PUSH_RECEPTION_ERROR:1200,PUSH_TOPICS_ERROR:1400,PUSH_DEVICE_ERROR:1500,PUSH_EVENT_ERROR:1600,API_APPKEY_NOT_VALID:1601});const a=o.ErrorMessage;Object.assign(a,{GENERAL_ERROR_BAD_REQUEST:"AppKey or DeviceId are null or empty",GENERAL_ERROR_APPKEY_BAD_REQUEST:"AppKey is null or empty",PUSH_INITIALIZATION_ERROR:"initialization error",PUSH_RECEPTION_ERROR:"push reception error",PUSH_TOPICS_ERROR:"push topics error",PUSH_DEVICE_ERROR:"device error",PUSH_EVENT_ERROR:"event error",API_APPKEY_NOT_VALID:"appKey is missing'"});const c={ErrorCode:n,ErrorMessage:a},{BaseRequest:E}=s(916).Core.Api,{EventType:h}=s(916).Core.Models;const I=class extends E{constructor(){super()}setEventType(e){this.eventType=e}setPushId(e){this.pushId=e}setClickedButton(e){this.clickedButton=e}setSendingId(e){this.sendingId=e}setPermissionType(e){this.permissionType=e}setLocation(e,t){this.latitude=e,this.longitude=t}setDeviceId(e){this.deviceId=e}setPlatform(e){this.platform=e}setAppKey(e){this.appKey=e}setCustomData(e){this.customData=e}async setExternalCodeRequest(){this.externalCode=await r.getExternalIdRequest()}setExternalCode(e){this.externalCode=e}setCampaingId(e){this.campaignId=e}setJourneyStateId(e){this.journeyStateId=e}setJourneyExecution(e){this.journeyExecution=e}setCjCurrentStateId(e){this.cjCurrentStateId=e}postEventPushRequest(){const e={};return e.deviceId=this.deviceId,e.platform=this.platform,this.eventType&&(e.eventType=this.eventType),this.pushId&&(e.pushId=this.pushId),e.clickedButton=this.clickedButton,null!=this.externalCode&&(e.externalCode=this.externalCode),this.sendingId&&"undefined"!=this.sendingId&&(e.sendingId=this.sendingId),this.journeyStateId&&(e.journeyStateId=this.journeyStateId),this.journeyExecution&&(e.journeyExecution=this.journeyExecution),this.cjCurrentStateId&&(e.cjCurrentStateId=this.cjCurrentStateId),this.campaignId&&(e.campaignId=this.campaignId),this.body=e,this}postEventVisitRequest(){const e={};return e.deviceId=r.getDeviceId(),e.eventType=h.EVENT_TYPE_UPDATE,this.body=e,this}postEventPermissionRequest(){const e={};return e.deviceId=r.getDeviceId(),this.eventType&&(e.eventType=this.eventType),this.permissionType&&(e.permissionType=this.permissionType),this.body=e,this}postEventLocationRequest(){const e={};return e.deviceId=r.getDeviceId(),e.eventType=h.EVENT_TYPE_UPDATE,this.latitude&&(e.latitude=this.latitude),this.longitude&&(e.longitude=this.longitude),this.body=e,this}postEventCustomRequest(){const e={};return this.deviceId&&(e.deviceId=this.deviceId),this.eventType&&(e.eventType=this.eventType),this.customData&&(e.customData=this.customData),this.externalCode&&(e.externalCode=this.externalCode),this.body=e,this}};const l=class{static urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(t),i=new Uint8Array(s.length);for(let e=0;e<s.length;++e)i[e]=s.charCodeAt(e);return i}static callEventPermission(e,t){const s=new I;s.setAppKey(r.getAppKey()),s.setDeviceId(r.getDeviceId()),s.setPermissionType(e),s.setEventType(t),y.postEventPermission(s)}static async getPutRequestTimestamp(){return await r.getPutRequestTimestamp()?r.getPutRequestTimestamp():Date.now()+6048e5}},{Validations:d,Log:R}=s(916).Core.Utils;const T=class extends d{static isAppKeyFormat(){const e=r.getAppKey();return null!=e&&""!=e&&"null"!=e&&e.length>3}static isValidFormatRequest(){const e=new R("[IND]PushValidations: "),t=r.getDeviceId();let s=!0;return this.isAppKeyFormat()||(s=!1,e.w("appKey is null or empty").writeLog()),this.isValidFormat(t)||(s=!1,e.w("deviceId is null or empty").writeLog()),s}static async isPutRequestExceed(){return await l.getPutRequestTimestamp()<=Date.now()}static isSafariBrowserDevice(){const e=window.navigator.userAgent,t=!!e.match(/iPad/i)||!!e.match(/iPhone/i),s=!!e.match(/WebKit/i);return t&&s&&!e.match(/CriOS/i)&&!e.match(/OPiOS/i)}},{Device:u}=s(916).Core.Models;const _=class extends u{constructor(e=null,t){super(e,t),null==e?(null!=r.getDeviceId()&&(this.deviceId=r.getDeviceId()),null!=r.getPushToken()&&(this.pushToken=r.getPushToken())):t?e.deviceId&&(this.deviceId=e.deviceId,r.setDeviceId(this.deviceId)):(e.deviceId&&(this.deviceId=e.deviceId),e.pushToken&&(this.pushToken=e.pushToken))}static setDeviceJson(e){r.setDeviceJson(JSON.stringify(e.toJSON()))}getDeviceId(){return this.deviceId}getPushToken(){return this.pushToken}toJSON(){const e=super.toJSON();return this.deviceId&&(e.deviceId=this.deviceId),this.pushToken&&(e.pushToken=this.pushToken),e}},{Config:S}=s(916).Core,{BaseClient:g}=s(916).Core.Api,{ErrorModel:p,Channel:P}=s(916).Core.Models,{TopicUtils:O,Log:A,CommonUtils:m,ErrorUtils:N}=s(916).Core.Utils;const y=new class extends g{constructor(){super(),this.URL_BASE=S.client.URL_BASE,this.ENDPOINT_APPLICATION="/application",this.ENDPOINT_APPLICATION_ALL=this.ENDPOINT_APPLICATION+"/all",this.ENDPOINT_DEVICE="/device",this.ENDPOINT_DEVICE_TOPICS=this.ENDPOINT_DEVICE+"/topics",this.ENDPOINT_PUSH="/push",this.ENDPOINT_EVENT="/event",this.ENDPOINT_EVENT_PUSH=this.ENDPOINT_EVENT+"/push",this.ENDPOINT_EVENT_VISIT=this.ENDPOINT_EVENT+"/visit",this.ENDPOINT_EVENT_PERMISSION=this.ENDPOINT_EVENT+"/permission",this.ENDPOINT_EVENT_LOCATION=this.ENDPOINT_EVENT+"/location",this.ENDPOINT_EVENT_CUSTOM=this.ENDPOINT_EVENT+"/custom",this.ENDPOINT_EVENT_CUSTOM_BEACON=this.ENDPOINT_EVENT_CUSTOM+"/beacon",this.ENDPOINT_BROWSER="/browser",this.log=new A("[IND]Client: ")}async getURL(){const e=await r.getUrlDeviceApi();return e||this.URL_BASE}async getApplicationAll(e,t,s){if(T.isAppKeyFormat()){const i=await this.get(this.ENDPOINT_APPLICATION_ALL,e.getApplicationRequest());!i||i instanceof p?i?m.isFunction(s)&&s(i):m.isFunction(s)&&s():m.isFunction(t)&&t(i)}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.BAD_REQUEST_SERVER_ERROR));return!0}async postDevice(e,t,s){if(T.isAppKeyFormat()){const i=await this.post(this.ENDPOINT_DEVICE,e.postDeviceRequest(),"include");if(!i||i instanceof p)i?m.isFunction(s)&&s(i):m.isFunction(s)&&s();else{const e={enabled:i.data.enabled,deviceId:i.data.deviceId,registeredByCookie:i.data.registeredByCookie};await r.setDeviceId(e.deviceId),m.isFunction(t)&&t(new _(e,!0))}}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_APPKEY_BAD_REQUEST));return!0}async putDevice(e,t,s){const i=new _,o=await T.isPutRequestExceed();if(e.deviceUpdate||null==await r.getPutRequestTimestamp()||o)if(T.isValidFormatRequest()){r.setPutRequestTimestamp(await l.getPutRequestTimestamp());const o=await this.put(this.ENDPOINT_DEVICE,e.putDeviceRequest(i),"include");if(!o||o instanceof p)o?m.isFunction(s)&&s(o):m.isFunction(s)&&s();else{const e={enabled:o.data.enabled,deviceId:o.data.deviceId,registeredByCookie:o.data.registeredByCookie};m.isFunction(t)&&t(new _(e,!0))}}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST));else m.isFunction(t)&&t(i)}async getDevice(e,t,s){if(T.isValidFormatRequest()){const i=await this.get(this.ENDPOINT_DEVICE,e.getDeviceRequest());if(!i||i instanceof p)i?m.isFunction(s)&&s(i):m.isFunction(s)&&s();else{const e={enabled:i.data.enabled,deviceId:i.data.deviceId};m.isFunction(t)&&t(new _(e,!0))}}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST));return!0}async getDeviceTopics(e,t,s){if(T.isValidFormatRequest()){const i=await this.get(this.ENDPOINT_DEVICE_TOPICS,e.getDeviceTopicsRequest());!i||i instanceof p?i?m.isFunction(s)&&s(i):m.isFunction(s)&&s():m.isFunction(t)&&t(O.setTopicChannel(i.data.topics,P.PUSH))}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST));return!0}async postDeviceTopics(e,t,s){return T.isValidFormatRequest()?await this.postDeviceTopicsRequest(e,t,s):m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST)),!0}async postDeviceTopicsRequest(e,t,s){const i=await this.post(this.ENDPOINT_DEVICE_TOPICS,e.postDeviceTopicsRequest());if(!i||i instanceof p)i?m.isFunction(s)&&s(i):m.isFunction(s)&&s();else{const e=i.data.topics;m.isFunction(t)&&t(e)}}async deleteDeviceTopics(e,t,s){return T.isValidFormatRequest()?this.deleteDeviceTopicsRequest(e,t,s):m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST)),!0}async deleteDeviceTopicsRequest(e,t,s){const i=await this.delete(this.ENDPOINT_DEVICE_TOPICS,e.deleteDeviceTopicsRequest());if(!i||i instanceof p)i?m.isFunction(s)&&s(i):m.isFunction(s)&&s();else{const e=i.data.topics;m.isFunction(t)&&t(e)}}async postEventPush(e){T.isValidFormatRequest()&&await this.post(this.ENDPOINT_EVENT_PUSH,e.postEventPushRequest())}postEventVisit(e){T.isValidFormatRequest()&&this.post(this.ENDPOINT_EVENT_VISIT,e.postEventVisitRequest())}postEventPermission(e){T.isValidFormatRequest()&&this.post(this.ENDPOINT_EVENT_PERMISSION,e.postEventPermissionRequest())}postEventLocation(e){T.isValidFormatRequest()&&this.post(this.ENDPOINT_EVENT_LOCATION,e.postEventLocationRequest())}async getBrowser(e,t,s){if(T.isAppKeyFormat()){const i=await this.get(this.ENDPOINT_BROWSER,e);if(!i||i instanceof p)i?m.isFunction(s)&&s(i):m.isFunction(s)&&s();else{const e={browserName:i.data.browserName,browserVersion:i.data.browserVersion,deviceType:i.data.deviceType,osName:i.data.osName,osVersion:i.data.osVersion,supported:i.data.supported,platform:i.data.platform};await r.setBrowserName(e.browserName),r.setBrowserVersion(e.browserVersion),await r.setOsName(e.osName),r.setOsVersion(e.osVersion),r.setDeviceType(e.deviceType),r.setSupported(e.supported),T.isSafariBrowserDevice()?await r.setPlatform("webpush"):await r.setPlatform(e.platform),m.isFunction(t)&&t(e)}}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST));return!0}async postEventCustom(e,t,s){if(T.isValidFormatRequest()){const i=await this.post(this.ENDPOINT_EVENT_CUSTOM,e.postEventCustomRequest());!i||i instanceof p?i?m.isFunction(s)&&s(i):m.isFunction(s)&&s():m.isFunction(t)&&t(i)}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST));return!0}async postEventCustomSync(e,t,s){if(T.isValidFormatRequest()){e=e.postEventCustomRequest();try{if(navigator&&"sendBeacon"in navigator){const s=await this.getURL()+this.ENDPOINT_EVENT_CUSTOM_BEACON+e.getParams();navigator.sendBeacon(s,JSON.stringify(e.getBody())),m.isFunction(t)&&t()}else{const i=await this.getURL()+this.ENDPOINT_EVENT_CUSTOM+e.getParams(),r=new XMLHttpRequest;r.open("POST",i,!1),r.setRequestHeader("Content-Type","application/json"),r.onreadystatechange=()=>{r.readyState===XMLHttpRequest.DONE&&(r.status>=200||r.status<300)?m.isFunction(t)&&t():m.isFunction(s)&&s()},r.send(JSON.stringify(e.getBody()))}}catch(e){m.isFunction(s)&&s(N.showError(c,c.ErrorCode.PUSH_EVENT_ERROR,e))}}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST));return!0}async postEventJourney(e,t,s){if(T.isValidFormatRequest()){const i=await this.post(this.ENDPOINT_PUSH+this.ENDPOINT_EVENT_CUSTOM,e.postEventCustomRequest());!i||i instanceof p?i?m.isFunction(s)&&s(i):m.isFunction(s)&&s():m.isFunction(t)&&t(i)}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST));return!0}async postEventJourneySync(e,t,s){if(T.isValidFormatRequest()){e=e.postEventCustomRequest();try{let i=await this.getURL();if(i=i.replace("v1","v2"),navigator&&"sendBeacon"in navigator){const s=i+this.ENDPOINT_PUSH+this.ENDPOINT_EVENT_CUSTOM+e.getParams();navigator.sendBeacon(s,JSON.stringify(e.getBody())),m.isFunction(t)&&t()}else{const i=await this.getURL().replace("v1","v2")+this.ENDPOINT_PUSH+this.ENDPOINT_EVENT_CUSTOM+e.getParams(),r=new XMLHttpRequest;r.open("POST",i,!1),r.setRequestHeader("Content-Type","application/json"),r.onreadystatechange=()=>{r.readyState===XMLHttpRequest.DONE&&(r.status>=200||r.status<300)?m.isFunction(t)&&t():m.isFunction(s)&&s()},r.send(JSON.stringify(e.getBody()))}}catch(e){m.isFunction(s)&&s(N.showError(c,c.ErrorCode.PUSH_EVENT_ERROR,e))}}else m.isFunction(s)&&s(N.showError(c,c.ErrorCode.GENERAL_ERROR_BAD_REQUEST));return!0}async postEventPushClick(e){let t="/event/push";e.journeyStateId&&(e.setJourneyRequest(!0),t=URL_PUSH+URL_EVENT_CLICK),e.setServiceWorkerRequest(!0),await this.post(t,e.postEventPushRequest())}},{EventType:C}=s(916).Core.Models,{Config:D}=s(916).Core;const v=class{static async requestBackgroundSync(){const e=await navigator.serviceWorker.getRegistration(r.getWorkerPath());return null!=e?e:null}static findIndigitallSW(e){for(let t=0;t<e.length;t++)if(void 0!==e[t]&&e[t].active&&e[t].active.scriptURL&&e[t].active.scriptURL.includes("worker.min.js"))return e[t];return null}static async sendEventRequest(e,t){const s=new I;s.setAppKey(e.appKey),s.setDeviceId(e.deviceId),s.setPlatform(D.platform),s.setPushId(""+e.id),s.setSendingId(""+e.sendingId),e.campaignId&&s.setCampaingId(""+e.campaignId),e.journeyStateId&&s.setJourneyStateId(e.journeyStateId),e.journeyExecution&&s.setJourneyExecution(e.journeyExecution),e.cjCurrentStateId&&s.setCjCurrentStateId(e.cjCurrentStateId),s.setEventType(C.EVENT_TYPE_CLICK),await s.setExternalCodeRequest(),"action-1"==t.action?s.setClickedButton(1):"action-2"==t.action?s.setClickedButton(2):s.setClickedButton(0),s.setServiceWorkerRequest(!0),await y.postEventPushClick(s)}};const L=class{constructor(e,t){this.code=e,this.type=t}static getAllCodes(e){const t=[];for(let s=0;s<e.length;s++)t.push(e[s].code);return t}toJSON(){const e={};return this.code&&(e.code=this.code),this.type&&(e.type=this.type),e}},{DeviceStatus:w}=s(916).Core.Models,{BaseRequest:b}=s(916).Core.Api;const B=class extends b{constructor(e=w.DEFAULT){super(),this.device=new _,this.status=e,this.notToUpdate=!1,this.deviceUpdate=!1}isDeviceUpdated(e){this.deviceUpdate=e}setDeviceId(e){this.device&&(this.device.deviceId=e)}setAppKey(e){this.appKey=e}getDeviceRequest(){return this.params=this.createQueryString(),this}postDeviceRequest(){return this.body=this.createDeviceJson(),this.status!==w.DEFAULT&&(this.body.enabled=1===this.status),this}putDeviceRequest(e){return this.params=this.createQueryString(),this.body=this.createPUTDeviceJson(e),this.status!==w.DEFAULT&&(this.body.enabled=1===this.status),this}getDeviceTopicsRequest(){return this.params=this.createQueryString(),this}postDeviceTopicsRequest(){return this.params=this.createQueryString(),this.body=this.createTopicsJson(),this}deleteDeviceTopicsRequest(){return this.params=this.createQueryString(),this.body=this.createTopicsJson(),this}createQueryString(){return this.PARAM_DEVICE_ID+"="+this.device.deviceId}createDeviceJson(){let e={};try{e=this.device.toJSON()}catch(e){}return e}createPUTDeviceJson(e){let t={};try{_.setDeviceJson(e),t=e.toJSON()}catch(e){}return t}createTopicsJson(){const e={};return this.topics&&(e.topics=this.topics),e}getDeviceId(){return this.device.getDeviceId()}setTopics(e){this.topics=e}setExternalCode(e){this.device.setExternalCode(e)}},U=Object.freeze({GREEN:"green",RED:"red"}),{TopicSubscribeType:f}=s(916).Core.Models,{CommonUtils:M}=s(916).Core.Utils;class V{static async updateTopic(t,s,i,o){V.checkTopicSemaphore().then((async()=>{await r.setTopicSemaphore(U.RED),await x.getTopicsList((async r=>{await this.setTopicCallbacks(t,i,o),await this.requestTopicBackground(e.TOPIC_SYNC_TAG),await W.updateTopicAction(s,t)}),o)}))}static async checkTopicSemaphore(){if(await r.getTopicSemaphore()!=U.RED)return!0;this.topicSemaphoreWaitTime((()=>!0))}static async topicSemaphoreWaitTime(e){const t=setInterval((async function(){await r.getTopicSemaphore()==U.GREEN&&(clearInterval(t),e())}),1e3)}static async setTopicCallbacks(t,s,i){let r=e.TOPIC_SYNC_SUBSCRIBE_CALLBACK,o=e.TOPIC_SYNC_SUBSCRIBE_ERROR_CALLBACK;t===f.UNSUBSCRIBE&&(r=e.TOPIC_SYNC_UNSUBSCRIBE_CALLBACK,o=e.TOPIC_SYNC_UNSUBSCRIBE_ERROR_CALLBACK);const n=new BroadcastChannel(r);n.onmessage=e=>{M.isFunction(s)&&s(e.data),n.close()};const a=new BroadcastChannel(o);a.onmessage=e=>{M.isFunction(i)&&i(e.data),a.close()}}static async requestTopicBackground(e){const t=await v.requestBackgroundSync();null!=t&&await t.sync.register(e)}static async isTopicTimestampExceed(){const e=await r.getTopicSyncTimestamp();return!(e&&e>Date.now())&&void 0!==e}static async setTopicTimestamp(){const t=Date.now()+e.TOPIC_SYNC_TIMESTAMP;await r.setTopicSyncTimestamp(t)}static indigitallSyncTopicEvent(e,t){new BroadcastChannel(e).postMessage(t)}static topicFilter(e,t){const s=[];if(e)for(let i=0;i<e.length;i++)e[i].type===t&&s.push(e[i].code);return s}static async filterTopicExistingOnIDB(){const e=await r.getUpdateTopicSubscribe(),t=await r.getTopicList(),s=[];for(let i=0;i<e.length;i++)for(let r=0;r<t.length;r++)e[i]&&t[r]&&e[i].code==t[r].code&&(!0===t[r].subscribed&&e[i].type==f.UNSUBSCRIBE||!1===t[r].subscribed&&e[i].type==f.SUBSCRIBE)&&s.push(e[i]);return s}}const Y=V,{CommonUtils:K}=s(916).Core.Utils;const x=class{static async setTopicRequest(e){const t=new B;return t.setAppKey(await r.getAppKeySync()),t.setDeviceId(await r.getDeviceIdSync()),t.setServiceWorkerRequest(!0),t.setTopics(e),t}static async getTopicsList(e,t){try{const s=await r.getTopicList();s&&s.length>0?await Y.isTopicTimestampExceed()?this.getDeviceTopicClient(e,t):(await r.setTopicSemaphore(U.GREEN),K.isFunction(e)&&e(s)):this.getDeviceTopicClient(e,t)}catch(e){await r.setTopicSemaphore(U.GREEN)}}static async getDeviceTopicClient(e,t){try{y.getDeviceTopics(new B,(async t=>{await Y.setTopicTimestamp(),await r.setTopicList(t),await r.setTopicSemaphore(U.GREEN),K.isFunction(e)&&e(t)}),(async e=>{await Y.setTopicTimestamp(),await r.setTopicSemaphore(U.GREEN),K.isFunction(t)&&t(e)}))}catch(e){await r.setTopicSemaphore(U.GREEN),K.isFunction(t)&&t(e)}}},{Channel:q,TopicSubscribeType:F}=s(916).Core.Models,{ErrorUtils:k,Log:G}=s(916).Core.Utils;class j{static async syncTopics(){if(!await r.getTopicSyncIsProcessing()){await r.setTopicSyncIsProcessing(!0);const t=setTimeout((async function(){try{await j.sendTopicSync()}catch(e){}await r.setTopicSyncIsProcessing(!1),clearTimeout(t)}),e.TOPIC_SYNC_TIMESTAMP)}}static async sendTopicSync(){const t=await Y.filterTopicExistingOnIDB(),s=Y.topicFilter(t,F.SUBSCRIBE),i=Y.topicFilter(t,F.UNSUBSCRIBE);if(s&&s.length>0)y.postDeviceTopicsRequest(await x.setTopicRequest(s),(async t=>{await Y.setTopicTimestamp(),t.channel=q.PUSH,await r.setTopicList(t),Y.indigitallSyncTopicEvent(e.TOPIC_SYNC_SUBSCRIBE_CALLBACK,t)}),(async t=>{Y.indigitallSyncTopicEvent(e.TOPIC_SYNC_SUBSCRIBE_ERROR_CALLBACK,t)}));else if(i&&i.length>0)y.deleteDeviceTopicsRequest(await x.setTopicRequest(i),(async t=>{await Y.setTopicTimestamp(),await r.setTopicList(t),Y.indigitallSyncTopicEvent(e.TOPIC_SYNC_UNSUBSCRIBE_CALLBACK,t)}),(async t=>{Y.indigitallSyncTopicEvent(e.TOPIC_SYNC_UNSUBSCRIBE_ERROR_CALLBACK,t)}));else{const t=k.showError(c,c.ErrorCode.PUSH_TOPICS_ERROR,"there is no topic with one of the codes in the push topic list");Y.indigitallSyncTopicEvent(e.TOPIC_SYNC_SUBSCRIBE_ERROR_CALLBACK,t),Y.indigitallSyncTopicEvent(e.TOPIC_SYNC_UNSUBSCRIBE_ERROR_CALLBACK,t)}await r.setUpdateTopicSubscribe([])}static async updateTopicAction(e,t){const s=await r.getUpdateTopicSubscribe();if(s&&s.length>0){const i=new G("[IND]TopicSyncUtils: ");try{const i=[],o=s.filter((t=>e.includes(t.code))),n=e.filter((e=>!L.getAllCodes(s).includes(e)));if(n&&n.length>0)for(let e=0;e<n.length;e++)null!==n[e]&&i.push(new L(n[e],t).toJSON());if(o&&o.length>0)for(let e=0;e<o.length;e++){const i=s.findIndex((t=>t.code===o[e].code)),r=new L(o[e].code,t);s[i]=r.toJSON()}i.length>0&&await r.setUpdateTopicSubscribe(i.concat(s))}catch(e){i.e("updateTopicAction: "+e).writeLog()}}else{const s=[];for(let i=0;i<e.length;i++){const r=e[i];s.push({code:r,type:t})}await r.setUpdateTopicSubscribe(s)}}}const W=j,{TopicSubscribeType:H}=s(916).Core.Models,{Log:J,LogLevel:Q}=s(916).Core.Utils,X="[IND]service-worker";async function z(e){await Y.updateTopic(H.SUBSCRIBE,e)}self.addEventListener("push",(async function(e){const t=new J(X);t.setLogLevel(Q.DEBUG),t.d("Received a push message ",e.data.json()).writeLog();const s=e.data.json(),i=s.title,r={};s.body&&(r.body=s.body);s.icon&&(r.icon=s.icon);s.image&&("image"in Notification.prototype?r.image=s.image:s.imageSquare?r.icon=s.imageSquare:r.icon=s.image);s.monochrome&&(r.badge=s.monochrome);const o={};o.appKey=s.appKey||"",o.deviceId=s.deviceId||"",o.id=s.id||0,o.sendingId=s.sendingId,o.campaignId=s.campaignId,s.journeyStateId&&(o.journeyStateId=s.journeyStateId);s.journeyExecution&&(o.journeyExecution=s.journeyExecution);s.cjCurrentStateId&&(o.cjCurrentStateId=s.cjCurrentStateId);if(s.action){const e=s.action;t.d("action: ",e).writeLog(),e.url&&(o.url=e.url),e.topics&&(o.topics=e.topics)}if(Array.isArray(s.buttons)){if(!navigator.userAgent.match(/opr\//i)){const e=[],i=[],n=[];t.d("buttons: ",s.buttons).writeLog();for(let t=0;t<s.buttons.length;t++){const r=s.buttons[t];e.push({action:"action-"+(t+1),title:r.label}),r.action&&r.action.url&&i.push(r.action.url),r.action&&r.action.topics&&n.push(r.action.topics)}e.length>0&&(r.actions=e),i.length>0&&(o.actions=i),n.length>0&&(o.buttonTopics=n)}}r.data=o,s.requireInteraction&&(r.requireInteraction=s.requireInteraction);if(s.extraFields&&"object"==typeof s.extraFields){const e={};Object.keys(s.extraFields).forEach((t=>{const i=s.extraFields[t];e[i]=s[t]})),Object.assign(r,e)}e.waitUntil(self.registration.showNotification(i,r))})),self.addEventListener("notificationclick",(async function(e){e.notification.close(),console.log(`${X} On notification click: `,e.notification);const t=e.notification.data;e.waitUntil(clients.matchAll({type:"window"}).then((function(s){for(let e=0;e<s.length;e++){const t=s[e];if("/"===t.url&&"focus"in t)return t.focus()}if(clients.openWindow)return"action-1"==e.action?(t.buttonTopics&&t.buttonTopics.length>0&&void 0!==t.buttonTopics[0]&&z(t.buttonTopics[0]),clients.openWindow(t.actions[0])):"action-2"==e.action?(t.buttonTopics&&t.buttonTopics.length>0&&void 0!==t.buttonTopics[1]&&z(t.buttonTopics[1]),clients.openWindow(t.actions[1])):(t.topics&&t.topics.length>0&&z(t.topics),clients.openWindow(t.url))}))),e.preventDefault(),await v.sendEventRequest(t,e)})),self.addEventListener("sync",(async function(t){if(t.tag)if(t.tag===e.TOPIC_SYNC_TAG)t.waitUntil(async function(){await W.syncTopics()}());else console.log(`"${t.tag}" command is not implemented yet`)})),self.addEventListener("message",(async function(e){console.log("didReceiveMessageListener data: ",e.data)}))})(),i})()));
"use strict";var chatRegex=/\/chat\/channel\/(\d+)\//,inlineReplyIcon="https://dub2.discourse-cdn.com/tappara/images/push-notifications/inline_reply.png";function showNotification(t,e,n,i,o,s,a){var c={body:e,icon:n,badge:i,data:{url:a,baseUrl:s},tag:o};return chatRegex.test(a)&&(c.actions=[{action:"reply",title:"Reply",placeholder:"reply",type:"text",icon:inlineReplyIcon}]),self.registration.showNotification(t,c)}self.addEventListener("push",(function(t){var e=t.data.json();t.waitUntil(showNotification(e.title,e.body,e.icon,e.badge,e.tag,e.base_url,e.url))})),self.addEventListener("notificationclick",(function(t){t.notification.close();var e=t.notification.data.url,n=t.notification.data.baseUrl;if("reply"===t.action){let i;fetch("/session/csrf",{credentials:"include",headers:{Accept:"application/json"}}).then((t=>{if(!t.ok)throw new Error("Network response was not OK");return t.json()})).then((o=>{i=o.csrf;let s=e.match(chatRegex);if(s.length>0){let e=s[1];fetch(`${n}/chat/${e}.json`,{credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-CSRF-Token":i},body:`message=${t.reply}`,method:"POST",mode:"cors"})}}))}else t.waitUntil(clients.matchAll({type:"window"}).then((function(t){if(!t.some((function(t){return t.url===n+e&&"focus"in t?(t.focus(),!0):"postMessage"in t&&"focus"in t&&(t.focus(),t.postMessage({url:e}),!0)}))&&clients.openWindow)return clients.openWindow(n+e)})))})),self.addEventListener("pushsubscriptionchange",(function(t){t.waitUntil(Promise.all(fetch("https://tappara.co/push_notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({"subscription[endpoint]":t.newSubscription.endpoint,"subscription[keys][auth]":t.newSubscription.toJSON().keys.auth,"subscription[keys][p256dh]":t.newSubscription.toJSON().keys.p256dh,send_confirmation:!1})}),fetch("https://tappara.co/push_notifications/unsubscribe",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({"subscription[endpoint]":t.oldSubscription.endpoint,"subscription[keys][auth]":t.oldSubscription.toJSON().keys.auth,"subscription[keys][p256dh]":t.oldSubscription.toJSON().keys.p256dh})})))})),self.addEventListener("message",(function(t){"primaryTab"===t.data?.action&&t.waitUntil(self.clients.matchAll().then((function(t){const e=t.find((t=>t.focused))||t.find((t=>"visible"===t.visibilityState));t.forEach((function(t){t.postMessage({primaryTab:t.id===e?.id})}))})))}));
//# sourceMappingURL=https://europe1.discourse-cdn.com/tappara/assets/service-worker-93677d247781d22be4beb6700a0e2bc101fb7a34f0d1373e227b426de7755192.js.map
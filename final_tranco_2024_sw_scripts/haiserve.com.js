const E="http(://localhost:6175|s://((test.)?seatalkweb.(com|cn)|web.haiserve.com))",C={WEB_STATIC:/^https:\/\/(web\.haiserve\.com|(test\.|)seatalkweb\.com|seatalkweb\.cn)(:1\d443|)(|\/beta|\/alpha)\/static\//,CDN_STATIC:/^https:\/\/(|static\.)cdn\.haiserve\.com\/seatalk\/(static|fe)\//,FILE_SERVER:/^https:\/\/(f(-\d{2})?\.haiserve\.com|(f|file(-\d{2})?)\.test\.haiserve\.com)\/download\//,SEATALK_OA:/^https:\/\/seatalkhr\.sp-cdn\.shopee\.com/,INDEX_HTML:new RegExp(`^${E}((|/|(/beta|/alpha))/?)?(index-.+\\.html)?((\\?|#).*)?$`),MEDIA_VIEWER_HTML:new RegExp(`^${E}/((beta/)|(alpha/))?mediaViewer(.*?).html/?((\\?|#).*)?$`),CALL_HTML:new RegExp(`^${E}/((beta/)|(alpha/))?call/video/(.*?).html/?((\\?|#).*)?$`)},b={INDEX_HTML:C.INDEX_HTML},N=[{find:/^https:\/\/f(-\d{2})?\.haiserve\.com\/download\//,replacement:"https://f.haiserve.com/download/"},{find:/^https:\/\/(f|file(-\d{2})?)\.test\.haiserve\.com\/download\//,replacement:"https://f.test.haiserve.com/download/"}],I=class{};let o=I;o.withoutParams=s=>{const e=s.indexOf("?");return e<0?s:s.substr(0,e)};o.isLocalUrl=s=>s.startsWith("file://")||s.startsWith("blob://");o.isFileServerUrl=s=>s.match(C.FILE_SERVER);o.isExact=s=>new URL(s).searchParams.get("exact")!==null;o.isSWR=s=>new URL(s).searchParams.has("_swr");o.fileServerUrlToFilename=s=>{const[,e]=s.match(/\/download\/([A-Za-z0-9]+)/)||[];return e};o.getFileServerOriginalImageUrl=s=>{const e=s.replace(/_(\d|\.)+/,"");return e===s?"":e};o.getFileOtherSizeImageUrl=(s,e=0)=>{const t=s.replace(/_(\d|\.)+/,e?`_${e}`:"");return t===s?"":t};o.getFileName=s=>{const[,e=""]=s.match(/\/([^/]*?)(\?|$)/)||[];return e};o.getFileSize=s=>{const e=I.withoutParams(s),t=e.lastIndexOf("_");return t<0?"":e.slice(t+1)};const v=class{};let c=v;c.sendMessageToMainPage=async s=>{(await self.clients.matchAll({})).forEach(t=>{t.frameType==="top-level"&&t.postMessage(s)})};c.log=(...s)=>{v.sendMessageToMainPage({type:"LOG",data:{content:s}})};c.logError=(...s)=>{v.sendMessageToMainPage({type:"LOG_ERROR",data:{content:s}})};c.logWarn=(...s)=>{v.sendMessageToMainPage({type:"LOG_WARN",data:{content:s}})};class g{}g.getId=s=>{let e=s.url;return o.isFileServerUrl(s.url)&&(e=`GFS/${o.fileServerUrlToFilename(s.url)}`),`[${s.method} ${e}]`};g.modifyUrl=async(s,e,t=!1)=>{const{method:r,headers:a,mode:i,credentials:n,cache:h,redirect:f,referrer:S}=s;let l=i;i==="navigate"&&(l="cors");let w;return(r==="POST"||r==="PUT")&&t&&(w=await s.clone().blob()),new Request(e,{method:r,headers:a,body:w,mode:l,credentials:n,cache:h,redirect:f,referrer:S})};var u=(s=>(s.OA="oa",s.SOP="sop",s.FILE="fileServer",s.WEBSOCKET="websocket",s.CALL="call",s))(u||{});const A=["fileServer"];class T{constructor(e,t,r,a,i){this.name=e,this.hosts=t,this.selectedIndex=r,this.configVersion=a,this.whiteListConfigVersion=i,this.lastSyncedSelectedIndex=r}get selectedHost(){return this.hosts[this.selectedIndex]}canHandleUrl(e){return this.hosts.some(t=>e.startsWith(t))}genUrlWithHost(e,t){const{pathname:r,search:a}=new URL(e);return`${t}${r}${a}`}modifyRequest(e,t){const r=this.genUrlWithHost(e.url,t);return g.modifyUrl(e,r,!0)}syncCurrentSelectedIndex(){this.lastSyncedSelectedIndex!==this.selectedIndex&&(c.sendMessageToMainPage({type:"SYNC_CURRENT_SELECTED_INDEX",data:{server:this.name,index:this.selectedIndex,configVersion:this.configVersion,whiteListConfigVersion:this.whiteListConfigVersion}}),this.lastSyncedSelectedIndex=this.selectedIndex)}async request(e,t){return await t(e)}selectNextHost(e){if(e!=null&&(e<0||e>=this.hosts.length)){c.logWarn(`fail to select next host, cuz this server only has ${this.hosts}, but select index=${e}`);return}const t=this.selectedIndex,r=e??(this.selectedIndex+1)%this.hosts.length;r!==t&&(this.selectedIndex=r,c.logWarn(`select next host! prev host: ${this.hosts[t]}, current host: ${this.hosts[r]}`))}}class W extends T{async tryRequest(e,t){const r=[...this.hosts.slice(this.selectedIndex),...this.hosts.slice(0,this.selectedIndex)];for(const a of r){const i=await this.modifyRequest(e,a);try{const n=await this.request(i,t);return this.selectNextHost(this.hosts.findIndex(h=>h===a)),this.syncCurrentSelectedIndex(),n}catch(n){if(n instanceof TypeError){if(a===r[r.length-1])throw c.logError(g.getId(e),"all hosts failed"),n;continue}else throw n}}}}class $ extends T{async tryRequest(e,t){const r=this.selectedIndex,a=await this.modifyRequest(e,this.selectedHost);try{const i=await this.request(a,t);return this.syncCurrentSelectedIndex(),i}catch(i){throw i instanceof TypeError&&r===this.selectedIndex&&this.selectNextHost(),i}}}function D(s,e,t,r,a){const i=A.includes(s)?W:$;return new i(s,e,t,r,a)}const V=[u.OA,u.SOP,u.FILE],q={configVersion:Number.MIN_SAFE_INTEGER,whiteListConfigVersion:Number.MIN_SAFE_INTEGER,servers:[{name:u.OA,hosts:["https://oa.haiserve.com","https://oa-01.haiserve.com","https://oa-02.haiserve.com"],selectedIndex:0,alternateSwitchTime:0},{name:u.SOP,hosts:["https://api.haiserve.com","https://api-01.haiserve.com","https://api-02.haiserve.com"],selectedIndex:0,alternateSwitchTime:0},{name:u.FILE,hosts:["https://f.haiserve.com","https://f-01.haiserve.com","https://f-02.haiserve.com"],selectedIndex:0,alternateSwitchTime:0}]};class z{constructor(){this.serverHosts=[],this.updateHosts=e=>{c.log("ServerHostsManager","updateHosts",JSON.stringify(e));const{configVersion:t,whiteListConfigVersion:r,servers:a}=e;this.serverHosts=a.filter(({name:i})=>V.includes(i)).map(({name:i,hosts:n,selectedIndex:h})=>D(i,n,h,t,r))},this.findServerHostsForUrl=e=>this.serverHosts.find(t=>t.canHandleUrl(e)),this.updateHosts(q)}}class K{constructor(e){this.shouldInterceptRequest=t=>!!this.serverHostsManager.findServerHostsForUrl(t.url),this.send=t=>{const r=i=>fetch(i,{mode:"cors",credentials:"same-origin"}),a=this.serverHostsManager.findServerHostsForUrl(t.url);return a?a.tryRequest(t,r):r(t)},this.serverHostsManager=e}}class U{}U.preprocess=async s=>{let e=s;if(s.headers.get("Content-Type").indexOf("video/")>=0){const t=new Headers;for(const r of s.headers.entries())t.append(r[0],r[1]);t.append("Accept-Ranges","bytes"),e=new Response(new DataView(await s.arrayBuffer()),{status:200,statusText:"OK",headers:t})}return e};class B{constructor(){this._devicePixelRatio=2}get devicePixelRatio(){return this._devicePixelRatio}updateDevicePixelRatio(e){c.log(`updateDevicePixelRatio: DPR changed to ${e}`),this._devicePixelRatio=e}}const _=new B,m=class{constructor(s){this.getCache=async()=>this.cache?this.cache:caches.open(self.location.origin).then(e=>(this.cache=e,e)),this.getCachedResponse=async e=>{const t=await this.resolveCacheRequest(e);let r=null,a=!1;const i=o.isSWR(t.url);if(r=await this.getCachedResponseForUrlWithoutParams(t),!r&&o.isFileServerUrl(t.url)){const n=o.getFileSize(t.url),h=_.devicePixelRatio,f=o.isExact(t.url);if(n===""||f)return{cachedResponse:r,isFallback:a,updateCache:i};a=!0;const S=o.withoutParams(t.url),l=300,w=h*l*2,P=h*l,H=h*l/2,p=Number(n)/2,M=h*p*2,k=h*p,L=h*p/2,F=[0,l*2,l,p*2,p,k,M,L,w,P,H].filter(R=>Number(R)!==Number(n));for(let R=0;R<F.length;R++){const O=F[R],x=o.getFileOtherSizeImageUrl(S,O);if(x&&(r=await this.getCachedResponseForRequest(x)),r)break}}return{cachedResponse:r,isFallback:a,updateCache:i}},this.resolveCacheRequest=e=>{const{url:t}=e;if(o.isFileServerUrl(t)){const r=N.find(({find:a})=>a.test(t));if(r)return g.modifyUrl(e,t.replace(r.find,r.replacement))}return e},this.getCachedResponseForRequest=async e=>{const r=await(await this.getCache()).match(e);return!r||["error","opaque","opaqueredirect"].indexOf(r.type)!==-1?null:U.preprocess(r)},this.getCachedResponseForUrlWithoutParams=async e=>{const t=o.withoutParams(e.url);return this.getCachedResponseForRequest(t)},this.getCachedResponseForOriginalSizeFileServerImage=async e=>{if(o.isFileServerUrl(e.url)){if(o.getFileSize(e.url)!==""&&o.isExact(e.url))return null;const t=o.withoutParams(e.url),r=o.getFileServerOriginalImageUrl(t);if(r)return this.getCachedResponseForRequest(r)}return null},this.saveResponseToCache=async(e,t)=>{if(t.status===200){const r=o.withoutParams(e.url),a=await g.modifyUrl(e,r),i=await this.resolveCacheRequest(a),n=t.clone();return(await this.getCache()).put(i,n)}},this.deleteFromCache=async(e,t)=>(await this.getCache()).delete(e,t),this.cache=s}static testUrl(s,e){if(s.method==="GET"){for(const t of e)if(s.url.match(t))return!0}return!1}};let d=m;d.cachePatterns=Object.values(C);d.cachePatternsForNetworkFirst=Object.values(b);d.shouldCacheRequest=s=>m.testUrl(s,m.cachePatterns);d.shouldNetworkFirst=s=>m.testUrl(s,m.cachePatternsForNetworkFirst);class G{constructor(){this.keys="0123456789abcdef_".split(""),this.defaultKey="_",this.cacheServiceMap={},this.migration=async()=>{},this.urlToCacheKey=e=>{const t=(o.getFileName(e)[0]||this.defaultKey).toLowerCase();return this.keys.indexOf(t)===-1?this.defaultKey:t},this.getCacheService=async e=>{const t=this.urlToCacheKey(e);if(!this.cacheServiceMap[t]){const r=await caches.open(`split-${t}`);this.cacheServiceMap[t]=new d(r)}return this.cacheServiceMap[t]}}}const j=s=>{const{request:e,response:t,error:r,fetchStart:a}=s,i=Date.now()-a;let n=`Response not ok, method: ${e.method} | status: ${t==null?void 0:t.status} | status text: ${t==null?void 0:t.statusText}`,h=e.headers.get("Content-Type"),f=e.headers.get("Content-Length");return r&&(n+=` | request error: ${r.message}`),t&&e.method.toLowerCase()==="get"&&(h=t.headers.get("Content-Type"),f=t.headers.get("Content-Length")),{url:e.url,latency_ms:i,error_code:t==null?void 0:t.status,message:n,content_type:h,content_length:f}},X=async(s={})=>{const{request:e}=s;c.sendMessageToMainPage({type:"BEFORE_REQUEST",data:{url:e.url,startTime:Date.now()}})},y=async(s={})=>{const e=j(s);c.sendMessageToMainPage({type:"ON_HTTP_ERROR",data:e})};class Y{constructor(){this.shouldHandleFetchEvent=e=>d.shouldCacheRequest(e.request)||this.sendService.shouldInterceptRequest(e.request),this.getResponseForRequestByCacheFirst=async e=>{try{const{cachedResponse:t,isFallback:r,updateCache:a}=await this.getResponseFromCache(e);return t?((r||a)&&this.getResponseFromNetwork(e),t):await this.getResponseFromNetwork(e)}catch(t){const r=t.toString();return r.includes("Response not ok")?c.logError(`fail to get response for ${e.url}`,r):c.logError(`fail to get response for ${e.url}`,t,t.stack),fetch(e)}},this.getResponseForRequestByNetworkFirst=async e=>{let t;try{return t=await this.getResponseFromNetwork(e),t}catch(r){c.logError(`fail to get response for ${e.url} from network`,r,r.stack)}try{const{cachedResponse:r}=await this.getResponseFromCache(e);if(r)return r}catch(r){c.logError(`fail to get response for ${e.url} from cache`,r,r.stack)}return t},this.getResponseFromCache=async e=>{if(e.method==="GET"){const t=await this.multipleCacheStorages.getCacheService(e.url),{cachedResponse:r,isFallback:a,updateCache:i}=await t.getCachedResponse(e);if(r)return{cachedResponse:r,isFallback:a,updateCache:i}}return{}},this.getResponseFromNetwork=async e=>{let t=e;if(e.url.includes("/download/")){const a=new URL(e.url),i=a.searchParams.get("token");a.searchParams.delete("token");const n=new Headers(e.headers);n.set("token",i),t=new Request(a.toString(),{body:e.body,cache:e.cache,credentials:"same-origin",keepalive:e.keepalive,method:e.method,mode:"cors",redirect:e.redirect,referrer:e.referrer,referrerPolicy:e.referrerPolicy,headers:n})}const r=Date.now();try{X({request:t});const a=await this.sendService.send(t);if(a.ok)return y({request:t,response:a,fetchStart:r}),d.shouldCacheRequest(e)&&(await this.multipleCacheStorages.getCacheService(e.url)).saveResponseToCache(e,a),a;throw y({request:t,response:a,fetchStart:r}),new Error(`Response not ok, status=${a.status}`)}catch(a){throw y({request:t,error:a,fetchStart:r}),a}},this.onInstall=e=>{e.waitUntil(this.multipleCacheStorages.migration().then(()=>self.skipWaiting()))},this.onActivate=e=>{e.waitUntil(self.clients.claim()),c.sendMessageToMainPage({type:"ON_ACTIVATE"})},this.onFetch=async e=>{o.isLocalUrl(e.request.url)||this.shouldHandleFetchEvent(e)&&(d.shouldNetworkFirst(e.request)?e.respondWith(this.getResponseForRequestByNetworkFirst(e.request)):e.respondWith(this.getResponseForRequestByCacheFirst(e.request)))},this.onMessage=({data:{type:e,data:t}={}})=>{switch(e){case"UPDATE_SERVER_HOSTS":{this.serverHostsManager.updateHosts(t);break}case"UPDATE_DEVICE_PIXEL_RATIO":_.updateDevicePixelRatio(t)}},this.serverHostsManager=new z,this.sendService=new K(this.serverHostsManager),this.multipleCacheStorages=new G,self.addEventListener("install",this.onInstall),self.addEventListener("activate",this.onActivate),self.addEventListener("fetch",this.onFetch),self.addEventListener("message",this.onMessage)}}new Y;

(()=>{var Ze=Object.create;var x=Object.defineProperty;var et=Object.getOwnPropertyDescriptor;var tt=Object.getOwnPropertyNames,ce=Object.getOwnPropertySymbols,nt=Object.getPrototypeOf,ae=Object.prototype.hasOwnProperty,st=Object.prototype.propertyIsEnumerable;var ue=(s,e,t)=>e in s?x(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,he=(s,e)=>{for(var t in e||(e={}))ae.call(e,t)&&ue(s,t,e[t]);if(ce)for(var t of ce(e))st.call(e,t)&&ue(s,t,e[t]);return s};var it=s=>x(s,"__esModule",{value:!0});var rt=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var ot=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of tt(e))!ae.call(s,i)&&(t||i!=="default")&&x(s,i,{get:()=>e[i],enumerable:!(n=et(e,i))||n.enumerable});return s},ct=(s,e)=>ot(it(x(s!=null?Ze(nt(s)):{},"default",!e&&s&&s.__esModule?{get:()=>s.default,enumerable:!0}:{value:s,enumerable:!0})),s);var qe=rt((Xt,Y)=>{"use strict";var R=typeof Reflect=="object"?Reflect:null,Me=R&&typeof R.apply=="function"?R.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},j;R&&typeof R.ownKeys=="function"?j=R.ownKeys:Object.getOwnPropertySymbols?j=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:j=function(e){return Object.getOwnPropertyNames(e)};function Ct(s){console&&console.warn&&console.warn(s)}var Ae=Number.isNaN||function(e){return e!==e};function h(){h.init.call(this)}Y.exports=h;Y.exports.once=Rt;h.EventEmitter=h;h.prototype._events=void 0;h.prototype._eventsCount=0;h.prototype._maxListeners=void 0;var Ne=10;function K(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(h,"defaultMaxListeners",{enumerable:!0,get:function(){return Ne},set:function(s){if(typeof s!="number"||s<0||Ae(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");Ne=s}});h.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};h.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Ae(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Ue(s){return s._maxListeners===void 0?h.defaultMaxListeners:s._maxListeners}h.prototype.getMaxListeners=function(){return Ue(this)};h.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",r=this._events;if(r!==void 0)i=i&&r.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var c=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw c.context=o,c}var a=r[e];if(a===void 0)return!1;if(typeof a=="function")Me(a,this,t);else for(var l=a.length,g=Be(a,l),n=0;n<l;++n)Me(g[n],this,t);return!0};function We(s,e,t,n){var i,r,o;if(K(t),r=s._events,r===void 0?(r=s._events=Object.create(null),s._eventsCount=0):(r.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),r=s._events),o=r[e]),o===void 0)o=r[e]=t,++s._eventsCount;else if(typeof o=="function"?o=r[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),i=Ue(s),i>0&&o.length>i&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=s,c.type=e,c.count=o.length,Ct(c)}return s}h.prototype.addListener=function(e,t){return We(this,e,t,!1)};h.prototype.on=h.prototype.addListener;h.prototype.prependListener=function(e,t){return We(this,e,t,!0)};function Tt(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Fe(s,e,t){var n={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},i=Tt.bind(n);return i.listener=t,n.wrapFn=i,i}h.prototype.once=function(e,t){return K(t),this.on(e,Fe(this,e,t)),this};h.prototype.prependOnceListener=function(e,t){return K(t),this.prependListener(e,Fe(this,e,t)),this};h.prototype.removeListener=function(e,t){var n,i,r,o,c;if(K(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(r=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){c=n[o].listener,r=o;break}if(r<0)return this;r===0?n.shift():It(n,r),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,c||t)}return this};h.prototype.off=h.prototype.removeListener;h.prototype.removeAllListeners=function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var r=Object.keys(n),o;for(i=0;i<r.length;++i)o=r[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function je(s,e,t){var n=s._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?wt(i):Be(i,i.length)}h.prototype.listeners=function(e){return je(this,e,!0)};h.prototype.rawListeners=function(e){return je(this,e,!1)};h.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):Ke.call(s,e)};h.prototype.listenerCount=Ke;function Ke(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}h.prototype.eventNames=function(){return this._eventsCount>0?j(this._events):[]};function Be(s,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=s[n];return t}function It(s,e){for(;e+1<s.length;e++)s[e]=s[e+1];s.pop()}function wt(s){for(var e=new Array(s.length),t=0;t<e.length;++t)e[t]=s[t].listener||s[t];return e}function Rt(s,e){return new Promise(function(t,n){function i(o){s.removeListener(e,r),n(o)}function r(){typeof s.removeListener=="function"&&s.removeListener("error",i),t([].slice.call(arguments))}ze(s,e,r,{once:!0}),e!=="error"&&kt(s,i,{once:!0})})}function kt(s,e,t){typeof s.on=="function"&&ze(s,"error",e,t)}function ze(s,e,t,n){if(typeof s.on=="function")n.once?s.once(e,t):s.on(e,t);else if(typeof s.addEventListener=="function")s.addEventListener(e,function i(r){n.once&&s.removeEventListener(e,i),t(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}});var at="v1",ut="1733375003417",O=`${at}::${ut}::cache`;var L=106,le=105,fe=103;var T={LIMIT_EXCEEDED_SERVER:"LIMIT_EXCEEDED_SERVER",LIMIT_EXCEEDED_TAB:"LIMIT_EXCEEDED_TAB",NO_SPACE_FOR_TAB:"NO_SPACE_FOR_TAB",WORKER_TABS_LIMIT_REACHED:"WORKER_TABS_LIMIT_REACHED"};var pe={pingPong:!0,centrifugoWorker:{isEnabled:!0,version:1}},de="FEATURES_WORKER_REQUEST",_e="FEATURES_WORKER_RESPONSE",be="FEATURES_WORKER_UPDATE_FEATURES_CONFIG";function ht(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var J={exports:{}},I=typeof Reflect=="object"?Reflect:null,ge=I&&typeof I.apply=="function"?I.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},D;I&&typeof I.ownKeys=="function"?D=I.ownKeys:Object.getOwnPropertySymbols?D=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:D=function(e){return Object.getOwnPropertyNames(e)};function lt(s){console&&console.warn&&console.warn(s)}var me=Number.isNaN||function(e){return e!==e};function u(){u.init.call(this)}J.exports=u;J.exports.once=_t;u.EventEmitter=u;u.prototype._events=void 0;u.prototype._eventsCount=0;u.prototype._maxListeners=void 0;var Se=10;function M(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(u,"defaultMaxListeners",{enumerable:!0,get:function(){return Se},set:function(s){if(typeof s!="number"||s<0||me(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");Se=s}});u.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};u.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||me(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function ve(s){return s._maxListeners===void 0?u.defaultMaxListeners:s._maxListeners}u.prototype.getMaxListeners=function(){return ve(this)};u.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",r=this._events;if(r!==void 0)i=i&&r.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var c=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw c.context=o,c}var a=r[e];if(a===void 0)return!1;if(typeof a=="function")ge(a,this,t);else for(var l=a.length,g=Ie(a,l),n=0;n<l;++n)ge(g[n],this,t);return!0};function Ee(s,e,t,n){var i,r,o;if(M(t),r=s._events,r===void 0?(r=s._events=Object.create(null),s._eventsCount=0):(r.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),r=s._events),o=r[e]),o===void 0)o=r[e]=t,++s._eventsCount;else if(typeof o=="function"?o=r[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),i=ve(s),i>0&&o.length>i&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=s,c.type=e,c.count=o.length,lt(c)}return s}u.prototype.addListener=function(e,t){return Ee(this,e,t,!1)};u.prototype.on=u.prototype.addListener;u.prototype.prependListener=function(e,t){return Ee(this,e,t,!0)};function ft(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function ye(s,e,t){var n={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},i=ft.bind(n);return i.listener=t,n.wrapFn=i,i}u.prototype.once=function(e,t){return M(t),this.on(e,ye(this,e,t)),this};u.prototype.prependOnceListener=function(e,t){return M(t),this.prependListener(e,ye(this,e,t)),this};u.prototype.removeListener=function(e,t){var n,i,r,o,c;if(M(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(r=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){c=n[o].listener,r=o;break}if(r<0)return this;r===0?n.shift():pt(n,r),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,c||t)}return this};u.prototype.off=u.prototype.removeListener;u.prototype.removeAllListeners=function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var r=Object.keys(n),o;for(i=0;i<r.length;++i)o=r[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function Ce(s,e,t){var n=s._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?dt(i):Ie(i,i.length)}u.prototype.listeners=function(e){return Ce(this,e,!0)};u.prototype.rawListeners=function(e){return Ce(this,e,!1)};u.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):Te.call(s,e)};u.prototype.listenerCount=Te;function Te(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}u.prototype.eventNames=function(){return this._eventsCount>0?D(this._events):[]};function Ie(s,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=s[n];return t}function pt(s,e){for(;e+1<s.length;e++)s[e]=s[e+1];s.pop()}function dt(s){for(var e=new Array(s.length),t=0;t<e.length;++t)e[t]=s[t].listener||s[t];return e}function _t(s,e){return new Promise(function(t,n){function i(o){s.removeListener(e,r),n(o)}function r(){typeof s.removeListener=="function"&&s.removeListener("error",i),t([].slice.call(arguments))}we(s,e,r,{once:!0}),e!=="error"&&bt(s,i,{once:!0})})}function bt(s,e,t){typeof s.on=="function"&&we(s,"error",e,t)}function we(s,e,t,n){if(typeof s.on=="function")n.once?s.once(e,t):s.on(e,t);else if(typeof s.addEventListener=="function")s.addEventListener(e,function i(r){n.once&&s.removeEventListener(e,i),t(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var gt=J.exports,Re=ht(gt),p;(function(s){s[s.timeout=1]="timeout",s[s.transportClosed=2]="transportClosed",s[s.clientDisconnected=3]="clientDisconnected",s[s.clientClosed=4]="clientClosed",s[s.clientConnectToken=5]="clientConnectToken",s[s.clientRefreshToken=6]="clientRefreshToken",s[s.subscriptionUnsubscribed=7]="subscriptionUnsubscribed",s[s.subscriptionSubscribeToken=8]="subscriptionSubscribeToken",s[s.subscriptionRefreshToken=9]="subscriptionRefreshToken",s[s.transportWriteError=10]="transportWriteError",s[s.connectionClosed=11]="connectionClosed",s[s.badConfiguration=12]="badConfiguration"})(p||(p={}));var y;(function(s){s[s.connectCalled=0]="connectCalled",s[s.transportClosed=1]="transportClosed",s[s.noPing=2]="noPing",s[s.subscribeTimeout=3]="subscribeTimeout",s[s.unsubscribeError=4]="unsubscribeError"})(y||(y={}));var P;(function(s){s[s.disconnectCalled=0]="disconnectCalled",s[s.unauthorized=1]="unauthorized",s[s.badProtocol=2]="badProtocol",s[s.messageSizeLimit=3]="messageSizeLimit"})(P||(P={}));var A;(function(s){s[s.subscribeCalled=0]="subscribeCalled",s[s.transportClosed=1]="transportClosed"})(A||(A={}));var N;(function(s){s[s.unsubscribeCalled=0]="unsubscribeCalled",s[s.unauthorized=1]="unauthorized",s[s.clientClosed=2]="clientClosed"})(N||(N={}));var _;(function(s){s.Disconnected="disconnected",s.Connecting="connecting",s.Connected="connected"})(_||(_={}));var m;(function(s){s.Unsubscribed="unsubscribed",s.Subscribing="subscribing",s.Subscribed="subscribed"})(m||(m={}));function mt(s,e){return s.lastIndexOf(e,0)===0}function ke(s){return s==null?!1:typeof s=="function"}function St(s,e){if(globalThis.console){let t=globalThis.console[s];ke(t)&&t.apply(globalThis.console,e)}}function vt(s,e){return Math.floor(Math.random()*(e-s+1)+s)}function U(s,e,t){s>31&&(s=31);let n=vt(0,Math.min(t,e*Math.pow(2,s)));return Math.min(t,e+n)}function Et(s){return"error"in s&&s.error!==null}function W(s){return Math.min(s*1e3,2147483647)}var Oe=class extends Re{constructor(e,t,n){super();this._resubscribeTimeout=null,this._refreshTimeout=null,this.channel=t,this.state=m.Unsubscribed,this._centrifuge=e,this._token="",this._getToken=null,this._data=null,this._getData=null,this._recover=!1,this._offset=null,this._epoch=null,this._recoverable=!1,this._positioned=!1,this._joinLeave=!1,this._minResubscribeDelay=500,this._maxResubscribeDelay=2e4,this._resubscribeTimeout=null,this._resubscribeAttempts=0,this._promises={},this._promiseId=0,this._inflight=!1,this._refreshTimeout=null,this._setOptions(n),this._centrifuge._debugEnabled?(this.on("state",i=>{this._centrifuge._debug("subscription state",t,i.oldState,"->",i.newState)}),this.on("error",i=>{this._centrifuge._debug("subscription error",t,i)})):this.on("error",function(){Function.prototype()})}ready(e){return this.state===m.Unsubscribed?Promise.reject({code:p.subscriptionUnsubscribed,message:this.state}):this.state===m.Subscribed?Promise.resolve():new Promise((t,n)=>{let i={resolve:t,reject:n};e&&(i.timeout=setTimeout(function(){n({code:p.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=i})}subscribe(){this._isSubscribed()||(this._resubscribeAttempts=0,this._setSubscribing(A.subscribeCalled,"subscribe called"))}unsubscribe(){this._setUnsubscribed(N.unsubscribeCalled,"unsubscribe called",!0)}publish(e){let t=this;return this._methodCall().then(function(){return t._centrifuge.publish(t.channel,e)})}presence(){let e=this;return this._methodCall().then(function(){return e._centrifuge.presence(e.channel)})}presenceStats(){let e=this;return this._methodCall().then(function(){return e._centrifuge.presenceStats(e.channel)})}history(e){let t=this;return this._methodCall().then(function(){return t._centrifuge.history(t.channel,e)})}_methodCall(){return this._isSubscribed()?Promise.resolve():this._isUnsubscribed()?Promise.reject({code:p.subscriptionUnsubscribed,message:this.state}):new Promise((e,t)=>{let n=setTimeout(function(){t({code:p.timeout,message:"timeout"})},this._centrifuge._config.timeout);this._promises[this._nextPromiseId()]={timeout:n,resolve:e,reject:t}})}_nextPromiseId(){return++this._promiseId}_needRecover(){return this._recover===!0}_isUnsubscribed(){return this.state===m.Unsubscribed}_isSubscribing(){return this.state===m.Subscribing}_isSubscribed(){return this.state===m.Subscribed}_setState(e){if(this.state!==e){let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t,channel:this.channel}),!0}return!1}_usesToken(){return this._token!==""||this._getToken!==null}_clearSubscribingState(){this._resubscribeAttempts=0,this._clearResubscribeTimeout()}_clearSubscribedState(){this._clearRefreshTimeout()}_setSubscribed(e){if(!this._isSubscribing())return;this._clearSubscribingState(),e.recoverable&&(this._recover=!0,this._offset=e.offset||0,this._epoch=e.epoch||""),this._setState(m.Subscribed);let t=this._centrifuge._getSubscribeContext(this.channel,e);this.emit("subscribed",t),this._resolvePromises();let n=e.publications;if(n&&n.length>0)for(let i in n)!n.hasOwnProperty(i)||this._handlePublication(n[i]);e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),W(e.ttl)))}_setSubscribing(e,t){this._isSubscribing()||(this._isSubscribed()&&this._clearSubscribedState(),this._setState(m.Subscribing)&&this.emit("subscribing",{channel:this.channel,code:e,reason:t}),this._subscribe())}_subscribe(){if(this._centrifuge._debug("subscribing on",this.channel),!this._centrifuge._transportIsOpen)return this._centrifuge._debug("delay subscribe on",this.channel,"till connected"),null;let e=this,t={channel:e.channel};return!this._usesToken()||this._token?e._getData?(e._getData(t).then(function(n){!e._isSubscribing()||(e._data=n,e._sendSubscribe(e._token))}),null):e._sendSubscribe(e._token):(this._getSubscriptionToken().then(function(n){if(!!e._isSubscribing()){if(!n){e._failUnauthorized();return}e._token=n,e._getData?e._getData(t).then(function(i){!e._isSubscribing()||(e._data=i,e._sendSubscribe(n))}):e._sendSubscribe(n)}}).catch(function(n){if(!!e._isSubscribing()){if(n instanceof C){e._failUnauthorized();return}e.emit("error",{type:"subscribeToken",channel:e.channel,error:{code:p.subscriptionSubscribeToken,message:n!==void 0?n.toString():""}}),e._scheduleResubscribe()}}),null)}_sendSubscribe(e){if(!this._centrifuge._transportIsOpen)return null;let n={channel:this.channel};if(e&&(n.token=e),this._data&&(n.data=this._data),this._positioned&&(n.positioned=!0),this._recoverable&&(n.recoverable=!0),this._joinLeave&&(n.join_leave=!0),this._needRecover()){n.recover=!0;let r=this._getOffset();r&&(n.offset=r);let o=this._getEpoch();o&&(n.epoch=o)}let i={subscribe:n};return this._inflight=!0,this._centrifuge._call(i).then(r=>{this._inflight=!1;let o=r.reply.subscribe;this._handleSubscribeResponse(o),r.next&&r.next()},r=>{this._inflight=!1,this._handleSubscribeError(r.error),r.next&&r.next()}),i}_handleSubscribeError(e){if(!!this._isSubscribing()){if(e.code===p.timeout){this._centrifuge._disconnect(y.subscribeTimeout,"subscribe timeout",!0);return}this._subscribeError(e)}}_handleSubscribeResponse(e){!this._isSubscribing()||this._setSubscribed(e)}_setUnsubscribed(e,t,n){this._isUnsubscribed()||(this._isSubscribed()&&(n&&this._centrifuge._unsubscribe(this),this._clearSubscribedState()),this._isSubscribing()&&(this._inflight&&n&&this._centrifuge._unsubscribe(this),this._clearSubscribingState()),this._setState(m.Unsubscribed)&&this.emit("unsubscribed",{channel:this.channel,code:e,reason:t}),this._rejectPromises({code:p.subscriptionUnsubscribed,message:this.state}))}_handlePublication(e){let t=this._centrifuge._getPublicationContext(this.channel,e);this.emit("publication",t),e.offset&&(this._offset=e.offset)}_handleJoin(e){let t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("join",{channel:this.channel,info:t})}_handleLeave(e){let t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("leave",{channel:this.channel,info:t})}_resolvePromises(){for(let e in this._promises)!this._promises.hasOwnProperty(e)||(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(let t in this._promises)!this._promises.hasOwnProperty(t)||(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}_scheduleResubscribe(){let e=this,t=this._getResubscribeDelay();this._resubscribeTimeout=setTimeout(function(){e._isSubscribing()&&e._subscribe()},t)}_subscribeError(e){if(!!this._isSubscribing())if(e.code<100||e.code===109||e.temporary===!0){e.code===109&&(this._token="");let t={channel:this.channel,type:"subscribe",error:e};this._centrifuge.state===_.Connected&&this.emit("error",t),this._scheduleResubscribe()}else this._setUnsubscribed(e.code,e.message,!1)}_getResubscribeDelay(){let e=U(this._resubscribeAttempts,this._minResubscribeDelay,this._maxResubscribeDelay);return this._resubscribeAttempts++,e}_setOptions(e){!e||(e.since&&(this._offset=e.since.offset,this._epoch=e.since.epoch,this._recover=!0),e.data&&(this._data=e.data),e.getData&&(this._getData=e.getData),e.minResubscribeDelay!==void 0&&(this._minResubscribeDelay=e.minResubscribeDelay),e.maxResubscribeDelay!==void 0&&(this._maxResubscribeDelay=e.maxResubscribeDelay),e.token&&(this._token=e.token),e.getToken&&(this._getToken=e.getToken),e.positioned===!0&&(this._positioned=!0),e.recoverable===!0&&(this._recoverable=!0),e.joinLeave===!0&&(this._joinLeave=!0))}_getOffset(){let e=this._offset;return e!==null?e:0}_getEpoch(){let e=this._epoch;return e!==null?e:""}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearResubscribeTimeout(){this._resubscribeTimeout!==null&&(clearTimeout(this._resubscribeTimeout),this._resubscribeTimeout=null)}_getSubscriptionToken(){this._centrifuge._debug("get subscription token for channel",this.channel);let e={channel:this.channel},t=this._getToken;if(t===null)throw this.emit("error",{type:"configuration",channel:this.channel,error:{code:p.badConfiguration,message:"provide a function to get channel subscription token"}}),new C("");return t(e)}_refresh(){this._clearRefreshTimeout();let e=this;this._getSubscriptionToken().then(function(t){if(!e._isSubscribed())return;if(!t){e._failUnauthorized();return}e._token=t;let i={sub_refresh:{channel:e.channel,token:t}};e._centrifuge._call(i).then(r=>{let o=r.reply.sub_refresh;e._refreshResponse(o),r.next&&r.next()},r=>{e._refreshError(r.error),r.next&&r.next()})}).catch(function(t){if(t instanceof C){e._failUnauthorized();return}e.emit("error",{type:"refreshToken",channel:e.channel,error:{code:p.subscriptionRefreshToken,message:t!==void 0?t.toString():""}}),e._refreshTimeout=setTimeout(()=>e._refresh(),e._getRefreshRetryDelay())})}_refreshResponse(e){!this._isSubscribed()||(this._centrifuge._debug("subscription token refreshed, channel",this.channel),this._clearRefreshTimeout(),e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),W(e.ttl))))}_refreshError(e){!this._isSubscribed()||(e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",channel:this.channel,error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._setUnsubscribed(e.code,e.message,!0))}_getRefreshRetryDelay(){return U(0,1e4,2e4)}_failUnauthorized(){this._setUnsubscribed(N.unauthorized,"unauthorized",!0)}},Pe=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"sockjs"}subName(){return"sockjs-"+this._transport.transport}emulation(){return!1}supported(){return this.options.sockjs!==null}initialize(e,t){this._transport=new this.options.sockjs(this.endpoint,null,this.options.sockjsOptions),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=n=>{t.onError(n)},this._transport.onclose=n=>{t.onClose(n)},this._transport.onmessage=n=>{t.onMessage(n.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}},G=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"websocket"}subName(){return"websocket"}emulation(){return!1}supported(){return this.options.websocket!==void 0&&this.options.websocket!==null}initialize(e,t){let n="";e==="protobuf"&&(n="centrifuge-protobuf"),n!==""?this._transport=new this.options.websocket(this.endpoint,n):this._transport=new this.options.websocket(this.endpoint),e==="protobuf"&&(this._transport.binaryType="arraybuffer"),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=i=>{t.onError(i)},this._transport.onclose=i=>{t.onClose(i)},this._transport.onmessage=i=>{t.onMessage(i.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}},xe=class{constructor(e,t){this.endpoint=e,this.options=t,this._abortController=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"http_stream"}subName(){return"http_stream"}emulation(){return!0}_handleErrors(e){if(!e.ok)throw new Error(e.status);return e}_fetchEventTarget(e,t,n){let i=new EventTarget;return e.options.fetch(t,n).then(e._handleErrors).then(o=>{i.dispatchEvent(new Event("open"));let c="",a=0,l=new Uint8Array,g=o.body.getReader();return new e.options.readableStream({start(E){function v(){return g.read().then(({done:f,value:S})=>{if(f){i.dispatchEvent(new Event("close")),E.close();return}try{if(e._protocol==="json")for(c+=e._utf8decoder.decode(S);a<c.length;)if(c[a]===`
`){let b=c.substring(0,a);i.dispatchEvent(new MessageEvent("message",{data:b})),c=c.substring(a+1),a=0}else++a;else{let b=new Uint8Array(l.length+S.length);for(b.set(l),b.set(S,l.length),l=b;;){let d=e.options.decoder.decodeReply(l);if(d.ok){let k=l.slice(0,d.pos);i.dispatchEvent(new MessageEvent("message",{data:k})),l=l.slice(d.pos);continue}break}}}catch(b){i.dispatchEvent(new Event("error",{detail:b})),i.dispatchEvent(new Event("close")),E.close();return}v()}).catch(function(f){i.dispatchEvent(new Event("error",{detail:f})),i.dispatchEvent(new Event("close")),E.close()})}return v()}})}).catch(o=>{i.dispatchEvent(new Event("error",{detail:o})),i.dispatchEvent(new Event("close"))}),i}supported(){return this.options.fetch!==null&&this.options.readableStream!==null&&typeof TextDecoder!="undefined"&&typeof AbortController!="undefined"&&typeof EventTarget!="undefined"&&typeof Event!="undefined"&&typeof MessageEvent!="undefined"&&typeof Error!="undefined"}initialize(e,t,n){this._protocol=e,this._abortController=new AbortController;let i,r;e==="json"?(i={Accept:"application/json","Content-Type":"application/json"},r=n):(i={Accept:"application/octet-stream","Content-Type":"application/octet-stream"},r=n);let o={method:"POST",headers:i,body:r,mode:"cors",credentials:"same-origin",cache:"no-cache",signal:this._abortController.signal},c=this._fetchEventTarget(this,this.endpoint,o);c.addEventListener("open",()=>{t.onOpen()}),c.addEventListener("error",a=>{this._abortController.abort(),t.onError(a)}),c.addEventListener("close",()=>{this._abortController.abort(),t.onClose({code:4,reason:"connection closed"})}),c.addEventListener("message",a=>{t.onMessage(a.data)})}close(){this._abortController.abort()}send(e,t,n){let i,r,o={session:t,node:n,data:e};this._protocol==="json"?(i={"Content-Type":"application/json"},r=JSON.stringify(o)):(i={"Content-Type":"application/octet-stream"},r=this.options.encoder.encodeEmulationRequest(o));let c=this.options.fetch,a={method:"POST",headers:i,body:r,mode:"cors",credentials:"same-origin",cache:"no-cache"};c(this.options.emulationEndpoint,a)}},Le=class{constructor(e,t){this.endpoint=e,this.options=t,this._protocol="json",this._transport=null,this._onClose=null}name(){return"sse"}subName(){return"sse"}emulation(){return!0}supported(){return this.options.eventsource!==null&&this.options.fetch!==null}initialize(e,t,n){let i;globalThis&&globalThis.document&&globalThis.document.baseURI?i=new URL(this.endpoint,globalThis.document.baseURI):i=new URL(this.endpoint),i.searchParams.append("cf_connect",n);let r={},o=new this.options.eventsource(i.toString(),r);this._transport=o;let c=this;o.onopen=function(){t.onOpen()},o.onerror=function(a){o.close(),t.onError(a),t.onClose({code:4,reason:"connection closed"})},o.onmessage=function(a){t.onMessage(a.data)},c._onClose=function(){t.onClose({code:4,reason:"connection closed"})}}close(){this._transport.close(),this._onClose!==null&&this._onClose()}send(e,t,n){let i={session:t,node:n,data:e},r={"Content-Type":"application/json"},o=JSON.stringify(i),c=this.options.fetch,a={method:"POST",headers:r,body:o,mode:"cors",credentials:"same-origin",cache:"no-cache"};c(this.options.emulationEndpoint,a)}};function F(s,e,t,n){function i(r){return r instanceof t?r:new t(function(o){o(r)})}return new(t||(t=Promise))(function(r,o){function c(g){try{l(n.next(g))}catch(E){o(E)}}function a(g){try{l(n.throw(g))}catch(E){o(E)}}function l(g){g.done?r(g.value):i(g.value).then(c,a)}l((n=n.apply(s,e||[])).next())})}var De=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null,this._stream=null,this._writer=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"webtransport"}subName(){return"webtransport"}emulation(){return!1}supported(){return this.options.webtransport!==void 0&&this.options.webtransport!==null}initialize(e,t){return F(this,void 0,void 0,function*(){let n;globalThis&&globalThis.document&&globalThis.document.baseURI?n=new URL(this.endpoint,globalThis.document.baseURI):n=new URL(this.endpoint),e==="protobuf"&&n.searchParams.append("cf_protocol","protobuf"),this._protocol=e;let i=new EventTarget;this._transport=new this.options.webtransport(n.toString()),this._transport.closed.then(()=>{t.onClose({code:4,reason:"connection closed"})}).catch(()=>{t.onClose({code:4,reason:"connection closed"})});try{yield this._transport.ready}catch{this.close();return}let r;try{r=yield this._transport.createBidirectionalStream()}catch{this.close();return}this._stream=r,this._writer=this._stream.writable.getWriter(),i.addEventListener("close",()=>{t.onClose({code:4,reason:"connection closed"})}),i.addEventListener("message",o=>{t.onMessage(o.data)}),this._startReading(i),t.onOpen()})}_startReading(e){return F(this,void 0,void 0,function*(){let t=this._stream.readable.getReader(),n="",i=0,r=new Uint8Array;try{for(;;){let{done:o,value:c}=yield t.read();if(c.length>0)if(this._protocol==="json")for(n+=this._utf8decoder.decode(c);i<n.length;)if(n[i]===`
`){let a=n.substring(0,i);e.dispatchEvent(new MessageEvent("message",{data:a})),n=n.substring(i+1),i=0}else++i;else{let a=new Uint8Array(r.length+c.length);for(a.set(r),a.set(c,r.length),r=a;;){let l=this.options.decoder.decodeReply(r);if(l.ok){let g=r.slice(0,l.pos);e.dispatchEvent(new MessageEvent("message",{data:g})),r=r.slice(l.pos);continue}break}}if(o)break}}catch{e.dispatchEvent(new Event("close"))}})}close(){return F(this,void 0,void 0,function*(){try{this._writer&&(yield this._writer.close()),this._transport.close()}catch{}})}send(e){return F(this,void 0,void 0,function*(){let t;this._protocol==="json"?t=new TextEncoder().encode(e+`
`):t=e;try{yield this._writer.write(t)}catch{this.close()}})}},X=class{name(){return"json"}encodeCommands(e){return e.map(t=>JSON.stringify(t)).join(`
`)}decodeReplies(e){return e.trim().split(`
`).map(t=>JSON.parse(t))}},yt={token:"",getToken:null,data:null,getData:null,debug:!1,name:"js",version:"",fetch:null,readableStream:null,websocket:null,eventsource:null,sockjs:null,sockjsOptions:{},emulationEndpoint:"/emulation",minReconnectDelay:500,maxReconnectDelay:2e4,timeout:5e3,maxServerPingDelay:1e4,networkEventTarget:null},C=class extends Error{constructor(e){super(e);this.name=this.constructor.name}},w=class extends Re{constructor(e,t){super();this._reconnectTimeout=null,this._refreshTimeout=null,this._serverPingTimeout=null,this.state=_.Disconnected,this._transportIsOpen=!1,this._endpoint=e,this._emulation=!1,this._transports=[],this._currentTransportIndex=0,this._triedAllTransports=!1,this._transportWasOpen=!1,this._transport=null,this._transportId=0,this._deviceWentOffline=!1,this._transportClosed=!0,this._codec=new X,this._reconnecting=!1,this._reconnectTimeout=null,this._reconnectAttempts=0,this._client=null,this._session="",this._node="",this._subs={},this._serverSubs={},this._commandId=0,this._commands=[],this._batching=!1,this._refreshRequired=!1,this._refreshTimeout=null,this._callbacks={},this._token="",this._data=null,this._dispatchPromise=Promise.resolve(),this._serverPing=0,this._serverPingTimeout=null,this._sendPong=!1,this._promises={},this._promiseId=0,this._debugEnabled=!1,this._networkEventsSet=!1,this._config=Object.assign(Object.assign({},yt),t),this._configure(),this._debugEnabled?(this.on("state",n=>{this._debug("client state",n.oldState,"->",n.newState)}),this.on("error",n=>{this._debug("client error",n)})):this.on("error",function(){Function.prototype()})}newSubscription(e,t){if(this.getSubscription(e)!==null)throw new Error("Subscription to the channel "+e+" already exists");let n=new Oe(this,e,t);return this._subs[e]=n,n}getSubscription(e){return this._getSub(e)}removeSubscription(e){!e||(e.state!==m.Unsubscribed&&e.unsubscribe(),this._removeSubscription(e))}subscriptions(){return this._subs}ready(e){return this.state===_.Disconnected?Promise.reject({code:p.clientDisconnected,message:"client disconnected"}):this.state===_.Connected?Promise.resolve():new Promise((t,n)=>{let i={resolve:t,reject:n};e&&(i.timeout=setTimeout(function(){n({code:p.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=i})}connect(){if(this._isConnected()){this._debug("connect called when already connected");return}if(this._isConnecting()){this._debug("connect called when already connecting");return}this._debug("connect called"),this._reconnectAttempts=0,this._startConnecting()}disconnect(){this._disconnect(P.disconnectCalled,"disconnect called",!1)}setToken(e){this._token=e}send(e){let t={send:{data:e}},n=this;return this._methodCall().then(function(){return n._transportSendCommands([t])?Promise.resolve():Promise.reject(n._createErrorObject(p.transportWriteError,"transport write error"))})}rpc(e,t){let n={rpc:{method:e,data:t}},i=this;return this._methodCall().then(function(){return i._callPromise(n,function(r){return{data:r.rpc.data}})})}publish(e,t){let n={publish:{channel:e,data:t}},i=this;return this._methodCall().then(function(){return i._callPromise(n,function(){return{}})})}history(e,t){let n={history:this._getHistoryRequest(e,t)},i=this;return this._methodCall().then(function(){return i._callPromise(n,function(r){let o=r.history,c=[];if(o.publications)for(let a=0;a<o.publications.length;a++)c.push(i._getPublicationContext(e,o.publications[a]));return{publications:c,epoch:o.epoch||"",offset:o.offset||0}})})}presence(e){let t={presence:{channel:e}},n=this;return this._methodCall().then(function(){return n._callPromise(t,function(i){let r=i.presence.presence;for(let o in r)if(r.hasOwnProperty(o)){let c=r[o].conn_info,a=r[o].chan_info;c&&(r[o].connInfo=c),a&&(r[o].chanInfo=a)}return{clients:r}})})}presenceStats(e){let t={presence_stats:{channel:e}},n=this;return this._methodCall().then(function(){return n._callPromise(t,function(i){let r=i.presence_stats;return{numUsers:r.num_users,numClients:r.num_clients}})})}startBatching(){this._batching=!0}stopBatching(){let e=this;Promise.resolve().then(function(){Promise.resolve().then(function(){e._batching=!1,e._flush()})})}_debug(...e){!this._debugEnabled||St("debug",e)}_formatOverride(){}_configure(){if(!("Promise"in globalThis))throw new Error("Promise polyfill required");if(!this._endpoint)throw new Error("endpoint configuration required");if(this._config.token!==null&&(this._token=this._config.token),this._config.data!==null&&(this._data=this._config.data),this._codec=new X,this._formatOverride(),(this._config.debug===!0||typeof localStorage!="undefined"&&localStorage.getItem("centrifuge.debug"))&&(this._debugEnabled=!0),this._debug("config",this._config),typeof this._endpoint!="string")if(typeof this._endpoint=="object"&&this._endpoint instanceof Array){this._transports=this._endpoint,this._emulation=!0;for(let e in this._transports)if(this._transports.hasOwnProperty(e)){let t=this._transports[e];if(!t.endpoint||!t.transport)throw new Error("malformed transport configuration");let n=t.transport;if(["websocket","http_stream","sse","sockjs","webtransport"].indexOf(n)<0)throw new Error("unsupported transport name: "+n)}}else throw new Error("unsupported url configuration type: only string or array of objects are supported")}_setState(e){if(this.state!==e){this._reconnecting=!1;let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t}),!0}return!1}_isDisconnected(){return this.state===_.Disconnected}_isConnecting(){return this.state===_.Connecting}_isConnected(){return this.state===_.Connected}_nextCommandId(){return++this._commandId}_setNetworkEvents(){if(this._networkEventsSet)return;let e=null;this._config.networkEventTarget!==null?e=this._config.networkEventTarget:typeof globalThis.addEventListener!="undefined"&&(e=globalThis),e&&(e.addEventListener("offline",()=>{this._debug("offline event triggered"),(this.state===_.Connected||this.state===_.Connecting)&&(this._disconnect(y.transportClosed,"transport closed",!0),this._deviceWentOffline=!0)}),e.addEventListener("online",()=>{this._debug("online event triggered"),this.state===_.Connecting&&(this._deviceWentOffline&&!this._transportClosed&&(this._deviceWentOffline=!1,this._transportClosed=!0),this._clearReconnectTimeout(),this._startReconnecting())}),this._networkEventsSet=!0)}_getReconnectDelay(){let e=U(this._reconnectAttempts,this._config.minReconnectDelay,this._config.maxReconnectDelay);return this._reconnectAttempts+=1,e}_clearOutgoingRequests(){for(let e in this._callbacks)if(this._callbacks.hasOwnProperty(e)){let t=this._callbacks[e];clearTimeout(t.timeout);let n=t.errback;if(!n)continue;n({error:this._createErrorObject(p.connectionClosed,"connection closed")})}this._callbacks={}}_clearConnectedState(){this._client=null,this._clearServerPingTimeout(),this._clearRefreshTimeout();for(let e in this._subs){if(!this._subs.hasOwnProperty(e))continue;let t=this._subs[e];t.state===m.Subscribed&&t._setSubscribing(A.transportClosed,"transport closed")}for(let e in this._serverSubs)this._serverSubs.hasOwnProperty(e)&&this.emit("subscribing",{channel:e})}_handleWriteError(e){for(let t of e){let n=t.id;if(!(n in this._callbacks))continue;let i=this._callbacks[n];clearTimeout(this._callbacks[n].timeout),delete this._callbacks[n],i.errback({error:this._createErrorObject(p.transportWriteError,"transport write error")})}}_transportSendCommands(e){if(!e.length)return!0;if(!this._transport)return!1;try{this._transport.send(this._codec.encodeCommands(e),this._session,this._node)}catch(t){return this._debug("error writing commands",t),this._handleWriteError(e),!1}return!0}_initializeTransport(){let e;this._config.websocket!==null?e=this._config.websocket:typeof globalThis.WebSocket!="function"&&typeof globalThis.WebSocket!="object"||(e=globalThis.WebSocket);let t=null;this._config.sockjs!==null?t=this._config.sockjs:typeof globalThis.SockJS!="undefined"&&(t=globalThis.SockJS);let n=null;this._config.eventsource!==null?n=this._config.eventsource:typeof globalThis.EventSource!="undefined"&&(n=globalThis.EventSource);let i=null;this._config.fetch!==null?i=this._config.fetch:typeof globalThis.fetch!="undefined"&&(i=globalThis.fetch);let r=null;if(this._config.readableStream!==null?r=this._config.readableStream:typeof globalThis.ReadableStream!="undefined"&&(r=globalThis.ReadableStream),this._emulation){this._currentTransportIndex>=this._transports.length&&(this._triedAllTransports=!0,this._currentTransportIndex=0);let f=0;for(;;){if(f>=this._transports.length)throw new Error("no supported transport found");let S=this._transports[this._currentTransportIndex],b=S.transport,d=S.endpoint;if(b==="websocket"){if(this._debug("trying websocket transport"),this._transport=new G(d,{websocket:e}),!this._transport.supported()){this._debug("websocket transport not available"),this._currentTransportIndex++,f++;continue}}else if(b==="webtransport"){if(this._debug("trying webtransport transport"),this._transport=new De(d,{webtransport:globalThis.WebTransport,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("webtransport transport not available"),this._currentTransportIndex++,f++;continue}}else if(b==="http_stream"){if(this._debug("trying http_stream transport"),this._transport=new xe(d,{fetch:i,readableStream:r,emulationEndpoint:this._config.emulationEndpoint,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("http_stream transport not available"),this._currentTransportIndex++,f++;continue}}else if(b==="sse"){if(this._debug("trying sse transport"),this._transport=new Le(d,{eventsource:n,fetch:i,emulationEndpoint:this._config.emulationEndpoint}),!this._transport.supported()){this._debug("sse transport not available"),this._currentTransportIndex++,f++;continue}}else if(b==="sockjs"){if(this._debug("trying sockjs"),this._transport=new Pe(d,{sockjs:t,sockjsOptions:this._config.sockjsOptions}),!this._transport.supported()){this._debug("sockjs transport not available"),this._currentTransportIndex++,f++;continue}}else throw new Error("unknown transport "+b);break}}else{if(mt(this._endpoint,"http"))throw new Error("Provide explicit transport endpoints configuration in case of using HTTP (i.e. using array of TransportEndpoint instead of a single string), or use ws(s):// scheme in an endpoint if you aimed using WebSocket transport");if(this._debug("client will use websocket"),this._transport=new G(this._endpoint,{websocket:e}),!this._transport.supported())throw new Error("WebSocket not available")}let o=this,c=this._transport,a=this._nextTransportId();o._debug("id of transport",a);let l=!1,g=[];if(this._transport.emulation()){let f=o._sendConnect(!0);g.push(f)}this._setNetworkEvents();let E=this._codec.encodeCommands(g);this._transportClosed=!1;let v;v=setTimeout(function(){c.close()},this._config.timeout),this._transport.initialize(this._codec.name(),{onOpen:function(){if(v&&(clearTimeout(v),v=null),o._transportId!=a){o._debug("open callback from non-actual transport"),c.close();return}l=!0,o._debug(c.subName(),"transport open"),!c.emulation()&&(o._transportIsOpen=!0,o._transportWasOpen=!0,o.startBatching(),o._sendConnect(!1),o._sendSubscribeCommands(),o.stopBatching(),o.emit("__centrifuge_debug:connect_frame_sent",{}))},onError:function(f){if(o._transportId!=a){o._debug("error callback from non-actual transport");return}o._debug("transport level error",f)},onClose:function(f){if(v&&(clearTimeout(v),v=null),o._transportId!=a){o._debug("close callback from non-actual transport");return}o._debug(c.subName(),"transport closed"),o._transportClosed=!0,o._transportIsOpen=!1;let S="connection closed",b=!0,d=0;if(f&&"code"in f&&f.code&&(d=f.code),f&&f.reason)try{let k=JSON.parse(f.reason);S=k.reason,b=k.reconnect}catch{S=f.reason,(d>=3500&&d<4e3||d>=4500&&d<5e3)&&(b=!1)}d<3e3?(d===1009?(d=P.messageSizeLimit,S="message size limit exceeded",b=!1):(d=y.transportClosed,S="transport closed"),o._emulation&&!o._transportWasOpen&&(o._currentTransportIndex++,o._currentTransportIndex>=o._transports.length&&(o._triedAllTransports=!0,o._currentTransportIndex=0))):o._transportWasOpen=!0,o._isConnecting()&&!l&&o.emit("error",{type:"transport",error:{code:p.transportClosed,message:"transport closed"},transport:c.name()}),o._reconnecting=!1,o._disconnect(d,S,b)},onMessage:function(f){o._dataReceived(f)}},E),o.emit("__centrifuge_debug:transport_initialized",{})}_sendConnect(e){let t=this._constructConnectCommand(),n=this;return this._call(t,e).then(i=>{let r=i.reply.connect;n._connectResponse(r),i.next&&i.next()},i=>{n._connectError(i.error),i.next&&i.next()}),t}_startReconnecting(){if(this._debug("start reconnecting"),!this._isConnecting()){this._debug("stop reconnecting: client not in connecting state");return}if(this._reconnecting){this._debug("reconnect already in progress, return from reconnect routine");return}if(this._transportClosed===!1){this._debug("waiting for transport close");return}this._reconnecting=!0;let e=this,t=this._token==="";if(!(this._refreshRequired||t&&this._config.getToken!==null)){this._config.getData?this._config.getData().then(function(i){!e._isConnecting()||(e._data=i,e._initializeTransport())}):this._initializeTransport();return}this._getToken().then(function(i){if(!!e._isConnecting()){if(i==null||i==null){e._failUnauthorized();return}e._token=i,e._debug("connection token refreshed"),e._config.getData?e._config.getData().then(function(r){!e._isConnecting()||(e._data=r,e._initializeTransport())}):e._initializeTransport()}}).catch(function(i){if(!e._isConnecting())return;if(i instanceof C){e._failUnauthorized();return}e.emit("error",{type:"connectToken",error:{code:p.clientConnectToken,message:i!==void 0?i.toString():""}});let r=e._getReconnectDelay();e._debug("error on connection token refresh, reconnect after "+r+" milliseconds",i),e._reconnecting=!1,e._reconnectTimeout=setTimeout(()=>{e._startReconnecting()},r)})}_connectError(e){this.state===_.Connecting&&(e.code===109&&(this._refreshRequired=!0),e.code<100||e.temporary===!0||e.code===109?(this.emit("error",{type:"connect",error:e}),this._debug("closing transport due to connect error"),this._disconnect(e.code,e.message,!0)):this._disconnect(e.code,e.message,!1))}_scheduleReconnect(){if(!this._isConnecting())return;let e=!1;this._emulation&&!this._transportWasOpen&&!this._triedAllTransports&&(e=!0);let t=this._getReconnectDelay();e&&(t=0),this._debug("reconnect after "+t+" milliseconds"),this._clearReconnectTimeout(),this._reconnectTimeout=setTimeout(()=>{this._startReconnecting()},t)}_constructConnectCommand(){let e={};this._token&&(e.token=this._token),this._data&&(e.data=this._data),this._config.name&&(e.name=this._config.name),this._config.version&&(e.version=this._config.version);let t={},n=!1;for(let i in this._serverSubs)if(this._serverSubs.hasOwnProperty(i)&&this._serverSubs[i].recoverable){n=!0;let r={recover:!0};this._serverSubs[i].offset&&(r.offset=this._serverSubs[i].offset),this._serverSubs[i].epoch&&(r.epoch=this._serverSubs[i].epoch),t[i]=r}return n&&(e.subs=t),{connect:e}}_getHistoryRequest(e,t){let n={channel:e};return t!==void 0&&(t.since&&(n.since={offset:t.since.offset},t.since.epoch&&(n.since.epoch=t.since.epoch)),t.limit!==void 0&&(n.limit=t.limit),t.reverse===!0&&(n.reverse=!0)),n}_methodCall(){return this._isConnected()?Promise.resolve():new Promise((e,t)=>{let n=setTimeout(function(){t({code:p.timeout,message:"timeout"})},this._config.timeout);this._promises[this._nextPromiseId()]={timeout:n,resolve:e,reject:t}})}_callPromise(e,t){return new Promise((n,i)=>{this._call(e,!1).then(r=>{n(t(r.reply)),r.next&&r.next()},r=>{i(r.error),r.next&&r.next()})})}_dataReceived(e){this._serverPing>0&&this._waitServerPing();let t=this._codec.decodeReplies(e);this._dispatchPromise=this._dispatchPromise.then(()=>{let n;this._dispatchPromise=new Promise(i=>{n=i}),this._dispatchSynchronized(t,n)})}_dispatchSynchronized(e,t){let n=Promise.resolve();for(let i in e)e.hasOwnProperty(i)&&(n=n.then(()=>this._dispatchReply(e[i])));n=n.then(()=>{t()})}_dispatchReply(e){let t,n=new Promise(r=>{t=r});if(e==null)return this._debug("dispatch: got undefined or null reply"),t(),n;let i=e.id;return i&&i>0?this._handleReply(e,t):e.push?this._handlePush(e.push,t):this._handleServerPing(t),n}_call(e,t){return new Promise((n,i)=>{e.id=this._nextCommandId(),this._registerCall(e.id,n,i),t||this._addCommand(e)})}_startConnecting(){this._debug("start connecting"),this._setState(_.Connecting)&&this.emit("connecting",{code:y.connectCalled,reason:"connect called"}),this._client=null,this._startReconnecting()}_disconnect(e,t,n){if(this._isDisconnected())return;this._transportIsOpen=!1;let i=this.state;this._reconnecting=!1;let r={code:e,reason:t},o=!1;if(n?o=this._setState(_.Connecting):(o=this._setState(_.Disconnected),this._rejectPromises({code:p.clientDisconnected,message:"disconnected"})),this._clearOutgoingRequests(),i===_.Connecting&&this._clearReconnectTimeout(),i===_.Connected&&this._clearConnectedState(),o&&(this._isConnecting()?this.emit("connecting",r):this.emit("disconnected",r)),this._transport){this._debug("closing existing transport");let c=this._transport;this._transport=null,c.close(),this._transportClosed=!0,this._nextTransportId()}else this._debug("no transport to close");this._scheduleReconnect()}_failUnauthorized(){this._disconnect(P.unauthorized,"unauthorized",!1)}_getToken(){if(this._debug("get connection token"),!this._config.getToken)throw this.emit("error",{type:"configuration",error:{code:p.badConfiguration,message:"token expired but no getToken function set in the configuration"}}),new C("");return this._config.getToken({})}_refresh(){let e=this._client,t=this;this._getToken().then(function(n){if(e!==t._client)return;if(!n){t._failUnauthorized();return}if(t._token=n,t._debug("connection token refreshed"),!t._isConnected())return;let i={refresh:{token:t._token}};t._call(i,!1).then(r=>{let o=r.reply.refresh;t._refreshResponse(o),r.next&&r.next()},r=>{t._refreshError(r.error),r.next&&r.next()})}).catch(function(n){if(!!t._isConnected()){if(n instanceof C){t._failUnauthorized();return}t.emit("error",{type:"refreshToken",error:{code:p.clientRefreshToken,message:n!==void 0?n.toString():""}}),t._refreshTimeout=setTimeout(()=>t._refresh(),t._getRefreshRetryDelay())}})}_refreshError(e){e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._disconnect(e.code,e.message,!1)}_getRefreshRetryDelay(){return U(0,5e3,1e4)}_refreshResponse(e){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),e.expires&&(this._client=e.client,this._refreshTimeout=setTimeout(()=>this._refresh(),W(e.ttl)))}_removeSubscription(e){e!==null&&delete this._subs[e.channel]}_unsubscribe(e){if(!this._transportIsOpen)return;let n={unsubscribe:{channel:e.channel}},i=this;this._call(n,!1).then(r=>{r.next&&r.next()},r=>{r.next&&r.next(),i._disconnect(y.unsubscribeError,"unsubscribe error",!0)})}_getSub(e){let t=this._subs[e];return t||null}_isServerSub(e){return this._serverSubs[e]!==void 0}_sendSubscribeCommands(){let e=[];for(let t in this._subs){if(!this._subs.hasOwnProperty(t))continue;let n=this._subs[t];if(n._inflight!==!0&&n.state===m.Subscribing){let i=n._subscribe();i&&e.push(i)}}return e}_connectResponse(e){if(this._transportIsOpen=!0,this._transportWasOpen=!0,this._reconnectAttempts=0,this._refreshRequired=!1,this._isConnected())return;this._client=e.client,this._setState(_.Connected),this._refreshTimeout&&clearTimeout(this._refreshTimeout),e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),W(e.ttl))),this._session=e.session,this._node=e.node,this.startBatching(),this._sendSubscribeCommands(),this.stopBatching();let t={client:e.client,transport:this._transport.subName()};e.data&&(t.data=e.data),this.emit("connected",t),this._resolvePromises(),this._processServerSubs(e.subs||{}),e.ping&&e.ping>0?(this._serverPing=e.ping*1e3,this._sendPong=e.pong===!0,this._waitServerPing()):this._serverPing=0}_processServerSubs(e){for(let t in e){if(!e.hasOwnProperty(t))continue;let n=e[t];this._serverSubs[t]={offset:n.offset,epoch:n.epoch,recoverable:n.recoverable||!1};let i=this._getSubscribeContext(t,n);this.emit("subscribed",i)}for(let t in e){if(!e.hasOwnProperty(t))continue;let n=e[t];if(n.recovered){let i=n.publications;if(i&&i.length>0)for(let r in i)i.hasOwnProperty(r)&&this._handlePublication(t,i[r])}}for(let t in this._serverSubs)!this._serverSubs.hasOwnProperty(t)||e[t]||(this.emit("unsubscribed",{channel:t}),delete this._serverSubs[t])}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearReconnectTimeout(){this._reconnectTimeout!==null&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null)}_clearServerPingTimeout(){this._serverPingTimeout!==null&&(clearTimeout(this._serverPingTimeout),this._serverPingTimeout=null)}_waitServerPing(){this._config.maxServerPingDelay!==0&&(!this._isConnected()||(this._clearServerPingTimeout(),this._serverPingTimeout=setTimeout(()=>{!this._isConnected()||this._disconnect(y.noPing,"no ping",!0)},this._serverPing+this._config.maxServerPingDelay)))}_getSubscribeContext(e,t){let n={channel:e,positioned:!1,recoverable:!1,wasRecovering:!1,recovered:!1};t.recovered&&(n.recovered=!0),t.positioned&&(n.positioned=!0),t.recoverable&&(n.recoverable=!0),t.was_recovering&&(n.wasRecovering=!0);let i="";"epoch"in t&&(i=t.epoch);let r=0;return"offset"in t&&(r=t.offset),(n.positioned||n.recoverable)&&(n.streamPosition={offset:r,epoch:i}),t.data&&(n.data=t.data),n}_handleReply(e,t){let n=e.id;if(!(n in this._callbacks)){t();return}let i=this._callbacks[n];if(clearTimeout(this._callbacks[n].timeout),delete this._callbacks[n],Et(e)){let r=i.errback;if(!r){t();return}let o=e.error;r({error:o,next:t})}else{let r=i.callback;if(!r)return;r({reply:e,next:t})}}_handleJoin(e,t){let n=this._getSub(e);if(!n){if(this._isServerSub(e)){let i={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("join",i)}return}n._handleJoin(t)}_handleLeave(e,t){let n=this._getSub(e);if(!n){if(this._isServerSub(e)){let i={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("leave",i)}return}n._handleLeave(t)}_handleUnsubscribe(e,t){let n=this._getSub(e);if(!n){this._isServerSub(e)&&(delete this._serverSubs[e],this.emit("unsubscribed",{channel:e}));return}t.code<2500?n._setUnsubscribed(t.code,t.reason,!1):n._setSubscribing(t.code,t.reason)}_handleSubscribe(e,t){this._serverSubs[e]={offset:t.offset,epoch:t.epoch,recoverable:t.recoverable||!1},this.emit("subscribed",this._getSubscribeContext(e,t))}_handleDisconnect(e){let t=e.code,n=!0;(t>=3500&&t<4e3||t>=4500&&t<5e3)&&(n=!1),this._disconnect(t,e.reason,n)}_getPublicationContext(e,t){let n={channel:e,data:t.data};return t.offset&&(n.offset=t.offset),t.info&&(n.info=this._getJoinLeaveContext(t.info)),t.tags&&(n.tags=t.tags),n}_getJoinLeaveContext(e){let t={client:e.client,user:e.user};return e.conn_info&&(t.connInfo=e.conn_info),e.chan_info&&(t.chanInfo=e.chan_info),t}_handlePublication(e,t){let n=this._getSub(e);if(!n){if(this._isServerSub(e)){let i=this._getPublicationContext(e,t);this.emit("publication",i),t.offset!==void 0&&(this._serverSubs[e].offset=t.offset)}return}n._handlePublication(t)}_handleMessage(e){this.emit("message",{data:e.data})}_handleServerPing(e){if(this._sendPong){let t={};this._transportSendCommands([t])}e()}_handlePush(e,t){let n=e.channel;e.pub?this._handlePublication(n,e.pub):e.message?this._handleMessage(e.message):e.join?this._handleJoin(n,e.join):e.leave?this._handleLeave(n,e.leave):e.unsubscribe?this._handleUnsubscribe(n,e.unsubscribe):e.subscribe?this._handleSubscribe(n,e.subscribe):e.disconnect&&this._handleDisconnect(e.disconnect),t()}_flush(){let e=this._commands.slice(0);this._commands=[],this._transportSendCommands(e)}_createErrorObject(e,t,n){let i={code:e,message:t};return n&&(i.temporary=!0),i}_registerCall(e,t,n){this._callbacks[e]={callback:t,errback:n,timeout:null},this._callbacks[e].timeout=setTimeout(()=>{delete this._callbacks[e],ke(n)&&n({error:this._createErrorObject(p.timeout,"timeout")})},this._config.timeout)}_addCommand(e){this._batching?this._commands.push(e):this._transportSendCommands([e])}_nextPromiseId(){return++this._promiseId}_nextTransportId(){return++this._transportId}_resolvePromises(){for(let e in this._promises)!this._promises.hasOwnProperty(e)||(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(let t in this._promises)!this._promises.hasOwnProperty(t)||(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}};w.SubscriptionState=m;w.State=_;w.UnauthorizedError=C;var He=ct(qe()),$=class{constructor(){this.eventEmitter=new He.EventEmitter}getEventEmitter(){return this.eventEmitter}};var Q=class extends ${constructor(e){super();this.createCentrifugeSubscriptionProxy=(e,t)=>[e,(...n)=>this.eventEmitter.emit(t,...n)];this.centrifuge=e,this.centrifuge.on(...this.createCentrifugeSubscriptionProxy("connected","connect")),this.centrifuge.on(...this.createCentrifugeSubscriptionProxy("disconnected","disconnect")),this.centrifuge.on(...this.createCentrifugeSubscriptionProxy("error","error"))}connect(){this.centrifuge.connect()}subscribe(e){return new Promise(t=>{let n=this.centrifuge.getSubscription(e);n||(n=this.centrifuge.newSubscription(e),n.on("publication",({data:i})=>{this.eventEmitter.emit("message",e,i)}).on("error",({channel:i,error:r,type:o})=>{this.eventEmitter.emit("subscription-error",{type:o,channel:i,error:{code:r.code,message:r.message}})}).on("unsubscribed",i=>{if([L,le,fe].includes(i.code)){let r=Object.entries(this.centrifuge.subscriptions()).map(([c,a])=>[c,a.state]),o={type:"unsubscribe",channel:i.channel,error:{code:i.code,message:`${i.reason} - ${JSON.stringify(r)}`}};this.eventEmitter.emit("subscription-error",o)}}),n.subscribe()),n.state===m.Subscribed?t():n.on("subscribed",()=>{t()})})}disconnectBeforeReconnect(){this.centrifuge.disconnect()}disconnect(){this.centrifuge.disconnect()}destroy(){this.getEventEmitter().removeAllListeners(),this.centrifuge.removeAllListeners()}unsubscribe(e){let t=this.centrifuge.getSubscription(e);t&&this.centrifuge.removeSubscription(t)}};function Ot(s,e){return 2**e*Math.max(s,1e3)}function Ve(s){let{wsURL:e,token:t,reconnectConfig:n}=s,i=new w(e,{token:t,minReconnectDelay:n.initReconnectionDelay,maxReconnectDelay:Ot(n.initReconnectionDelay,n.maxReconnectionAttempts)});return new Q(i)}var Z=class{constructor(e){this.subscriptions=new Map;this.onFirstSubscriptionAdd=e.onFirstSubscriptionAdd,this.onLastSubscriptionRemove=e.onLastSubscriptionRemove}getAllSubscriptions(){return Array.from(this.subscriptions.values())}getAllSubscriptionsSnapshot(){return this.getAllSubscriptions().reduce((e,{clientIds:t,key:n})=>(t.forEach(i=>{e.push({clientId:i,subscriptionKey:n})}),e),[])}hasClient(e){return Array.from(this.subscriptions.values()).some(({clientIds:t})=>t.has(e))}hasSubscription(e){return this.subscriptions.has(e)}getOnSubscribePromise(e){var t;return((t=this.subscriptions.get(e))==null?void 0:t.onSubscribePromise)||null}clientHasSubscription(e,t){var n;return!!((n=this.subscriptions.get(t))==null?void 0:n.clientIds.has(e))}getClientSubscriptionKeys(e){return Array.from(this.subscriptions.values()).filter(({clientIds:t})=>t.has(e)).map(({key:t})=>t)}getClientsWithSubscription(e){var t;return Array.from(((t=this.subscriptions.get(e))==null?void 0:t.clientIds.values())||[])}createClientSubscription(e,t,n){if(this.clientHasSubscription(e,t))return;let i=!this.subscriptions.size;this.subscriptions.set(t,{clientIds:new Set([e]),key:t,onSubscribePromise:n}),i&&this.onFirstSubscriptionAdd&&this.onFirstSubscriptionAdd()}addClientToExistingSubscription(e,t){var n;(n=this.subscriptions.get(e))==null||n.clientIds.add(t)}removeClientSubscription(e,t){if(!this.clientHasSubscription(e,t))return;let n=this.subscriptions.get(t);if(!n)return;n.clientIds.delete(e),n.clientIds.size||this.subscriptions.delete(t),!this.subscriptions.size&&this.onLastSubscriptionRemove&&this.onLastSubscriptionRemove()}removeClient(e){!this.hasClient(e)||this.getClientSubscriptionKeys(e).forEach(t=>this.removeClientSubscription(e,t))}removeAllSubscriptions(){this.getAllSubscriptionsSnapshot().forEach(({clientId:e,subscriptionKey:t})=>this.removeClientSubscription(e,t))}};var Je=s=>typeof s=="object"&&s!==null,ee=(s,e)=>{if(!Je(s)||!Je(e))return s===e;let t=Object.keys(s),n=Object.keys(e);if(t.length!==n.length)return!1;for(let i of t)if(!ee(s[i],e[i]))return!1;return!0};var te=class{constructor(e){this.isConnected=!1;this.connection=null;this.subscriptionsConfig={maxSubscriptions:256,maxSubscriptionsPerTab:85};this.disconnectedClientIds=new Set;this.createSubscribedHandler=(e,t)=>{let n=!1;return()=>{let i=!this.subscriptions.clientHasSubscription(e,t);n||i||(n=!0,this.onSocketSubscribed(e,t))}};this.onMessage=(e,t)=>{this.subscriptions.getClientsWithSubscription(e).forEach(n=>{this.onSocketMessage(n,e,t)})};this.disconnect=()=>{!this.connection||(this.connection.getEventEmitter().removeAllListeners(),this.connection.disconnect(),this.connection=null,this.isConnected&&(this.isConnected=!1,this.onDisconnect({reason:"disconnect",reconnect:!1})))};this.handleSubscriptionError=e=>{e.error.code===L&&this.onForceDisconnect(T.LIMIT_EXCEEDED_SERVER),this.subscriptions.getClientsWithSubscription(e.channel).forEach(t=>{this.onSubscriptionError(t,e)})};this.onConnect=e.onConnect,this.onDisconnect=e.onDisconnect,this.onSocketSubscribed=e.onSocketSubscribed,this.onSocketMessage=e.onSocketMessage,this.onError=e.onError,this.onSubscriptionError=e.onSubscriptionError,this.onForceDisconnect=e.onForceDisconnect,this.subscriptions=new Z(e)}connectOrReconnect(e,t){this.connection?this.reconnect(this.connection,e,t):this.connect(e),this.config=e}connect(e){!e.wsURL||!e.token||(this.connection=Ve(e),this.connection.getEventEmitter().on("connect",t=>{this.isConnected=!0,this.onConnect(t)}).on("disconnect",t=>{this.onDisconnect(t)}).on("message",this.onMessage).on("error",this.onError).on("subscription-error",this.handleSubscriptionError),this.connection.connect())}reconnect(e,t,n){if(!ee(t,this.config)){e.getEventEmitter().removeAllListeners(),e.disconnect(),this.isConnected&&(this.isConnected=!1,this.onDisconnect({reason:"reconnect",reconnect:!0}));let i=this.subscriptions.getAllSubscriptionsSnapshot();this.subscriptions.removeAllSubscriptions(),this.connect(t),i.forEach(({clientId:r,subscriptionKey:o})=>this.subscribe(r,o));return}this.isConnected&&n()}forceDisconnect(e,t){t&&(this.disconnectedClientIds.add(t),this.unsubscribeClient(t)),this.onForceDisconnect(e,t)}subscribe(e,t){let{maxSubscriptions:n,maxSubscriptionsPerTab:i}=this.subscriptionsConfig;if(this.disconnectedClientIds.has(e))return;if(!this.subscriptions.hasClient(e)){let o=this.subscriptions.getAllSubscriptions().length;if(i>n-o){this.forceDisconnect(T.NO_SPACE_FOR_TAB,e);return}}if(!this.connection)return;let r=this.subscriptions.getOnSubscribePromise(t);if(r)this.subscriptions.addClientToExistingSubscription(t,e);else{if(this.subscriptions.getClientSubscriptionKeys(e).length>=this.subscriptionsConfig.maxSubscriptionsPerTab){this.forceDisconnect(T.LIMIT_EXCEEDED_TAB,e);return}r=this.connection.subscribe(t),this.subscriptions.createClientSubscription(e,t,r)}r.then(this.createSubscribedHandler(e,t))}unsubscribe(e,t){var n;!this.subscriptions.clientHasSubscription(e,t)||(this.subscriptions.removeClientSubscription(e,t),this.subscriptions.hasSubscription(t)||(n=this.connection)==null||n.unsubscribe(t))}unsubscribeClient(e){this.subscriptions.getClientSubscriptionKeys(e).forEach(t=>{this.unsubscribe(e,t)})}updateSocketSubscriptionsConfig(e){return e&&typeof e.maxSubscriptions=="number"&&typeof e.maxSubscriptionsPerTab=="number"?(this.subscriptionsConfig=e,this.subscriptionsConfig):null}};var Ge=self,Pt=5e3,ne=class{constructor(e){this.cancelFn=null;this.clientIds=new Set;this.deleteClient=e=>{this.clientIds.delete(e)};this.stopWatch=()=>{this.cancelFn&&(this.cancelFn(),this.cancelFn=null)};this.onDeleteClient=e.onDeleteClient}getClients(){return Ge.clients.matchAll({type:"window",includeUncontrolled:!0})}async getClient(e){return(await this.getClients()).find(({id:n})=>n===e)}async startWatch(){if(this.cancelFn)return;let e=0,t=!1;this.cancelFn=()=>{t=!0,clearInterval(e)},this.clientIds=new Set((await this.getClients()).map(({id:n})=>n)),!t&&(e=Ge.setInterval(async()=>{let n=new Set((await this.getClients()).map(({id:i})=>i));t||(this.clientIds.forEach(i=>{n.has(i)||this.onDeleteClient(i)}),this.clientIds=n)},Pt))}};var xt=1e4,Xe=3,B=class{constructor(){this.clientIds=new Set;this.maxClients=Xe;this.deleteClient=e=>{this.workerClients.deleteClient(e),this.onDeleteClient(e)};this.onDeleteClient=e=>{this.clientIds.delete(e),this.clientIds.size===0&&this.socket.disconnect(),this.socket.unsubscribeClient(e)};this.onConnect=e=>{this.clientIds.forEach(t=>{this.postMessage(t,{type:"connected",data:e})})};this.onDisconnect=e=>{this.clientIds.forEach(t=>{this.postMessage(t,{type:"disconnected",data:e})})};this.onError=e=>{this.clientIds.forEach(t=>{this.postMessage(t,{type:"error",data:e})})};this.onSubscriptionError=(e,t)=>{this.postMessage(e,{type:"subscription-error",data:t})};this.onSocketMessage=(e,t,n)=>{this.postMessage(e,{type:"message",subscriptionKey:t,data:n})};this.onSocketSubscribed=async(e,t)=>{this.postMessage(e,{type:"subscribed",subscriptionKey:t})};this.onFirstSubscriptionAdd=()=>{this.workerClients.startWatch()};this.onLastSubscriptionRemove=()=>{this.workerClients.stopWatch()};this.pingRandomClient=()=>{if(this.clientIds.size>0){let e=Array.from(this.clientIds),t=e[Math.floor(Math.random()*e.length)];this.postMessage(t,{type:"ping"})}};this.workerClients=new ne({onDeleteClient:this.onDeleteClient}),this.socket=new te({onConnect:this.onConnect,onDisconnect:this.onDisconnect,onSocketSubscribed:this.onSocketSubscribed,onSocketMessage:this.onSocketMessage,onFirstSubscriptionAdd:this.onFirstSubscriptionAdd,onLastSubscriptionRemove:this.onLastSubscriptionRemove,onError:this.onError,onSubscriptionError:this.onSubscriptionError,onForceDisconnect:this.onForceDisconnect}),setInterval(this.pingRandomClient,xt)}handleForceDisconnect(e,t){this.deleteClient(t),this.postMessage(t,{type:"force-disconnected",data:{reason:e}})}onForceDisconnect(e,t){t?this.handleForceDisconnect(e,t):e===T.LIMIT_EXCEEDED_SERVER&&this.clientIds.forEach(n=>{this.handleForceDisconnect(e,n)})}async postMessage(e,t){let n=await this.workerClients.getClient(e);if(!n){this.deleteClient(e);return}let i=he({source:"socket-worker"},t);n.postMessage(i)}onMessage({source:e,data:t={}}){if(!(e instanceof Client))return;let n=t,i=e.id,{type:r}=n;switch(r){case"connectOrReconnect":{if(this.clientIds.size===this.maxClients){this.onForceDisconnect(T.WORKER_TABS_LIMIT_REACHED,i);break}this.clientIds.add(i);let o=()=>this.postMessage(i,{type:"connected",data:{client:"",latency:0,transport:""}});this.socket.connectOrReconnect(n.config,o);break}case"disconnect":{this.deleteClient(i);break}case"subscribe":this.socket.subscribe(i,n.subscriptionKey);break;case"unsubscribe":this.socket.unsubscribe(i,n.subscriptionKey);break;case be:n.config.featuresConfig.centrifugoWorker&&this.socket.updateSocketSubscriptionsConfig(n.config.featuresConfig.centrifugoWorker);try{let{maxSubscriptions:o,maxSubscriptionsPerTab:c}=n.config.featuresConfig.centrifugoWorker;this.maxClients=Math.floor(o/c)}catch{this.maxClients=Xe}break;default:break}}};var se=class{constructor(){this.onMessage=({source:e,data:t})=>{if(e instanceof Client&&t===de){let n={type:_e,payload:pe};e.postMessage(n)}}}};var ie="ml-analytics-worker",z=class{constructor(){this.getSendOptions=e=>({method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async onMessage({source:e,data:t={}}){if(!(e instanceof Client))return;let{type:n,payload:i,url:r,fullEventName:o}=t;switch(n){case"MlAnalyticsEvent":{try{let c=await this.send(r,i),a={source:ie,type:o,payload:i,errorMessage:c.ok?null:await c.text()};e.postMessage(a)}catch(c){let a=c instanceof Error?c.message:String(c),l={source:ie,type:o,payload:i,errorMessage:a};e.postMessage(l)}break}default:break}}send(e,t){return fetch(e,this.getSendOptions(t))}};var q=class{constructor(){this.SENTRY_INTERCEPTED_URLS=[/https:\/\/sentry-public((.*)?)/,/https:\/\/sentry.stripchat.tech(.*)?/]}canIntercept(e){return this.SENTRY_INTERCEPTED_URLS.some(t=>e.request.url.match(t))}intercept(e){return e.respondWith(fetch(e.request).then(t=>{if(!t.ok)throw Error();return t}).catch(()=>new Response("A network error was intercepted.",{status:200,statusText:"OK"})))}};function Lt(s){if(Boolean(AbortSignal==null?void 0:AbortSignal.timeout))return AbortSignal.timeout(s);let t=new AbortController;return setTimeout(()=>{t.abort()},s),t.signal}var H=class{constructor({healthcheckTimeout:e,storage:t,respondWithCachedLoaderPage:n}){this.onSyncHealthCheckConfigMessageEvent=async e=>{if(!("pwaRedirectsMirrorsEnabled"in e&&e.pwaRedirectsMirrorsEnabled===void 0))try{await this.storage.setItem("pwaRedirectsMirrorsEnabled",e.pwaRedirectsMirrorsEnabled)}catch(t){console.error(t)}};this.respondWithDefault=async e=>fetch(e.request);this.respondWithMirrorDiscoveryPage=async e=>{try{let t=Lt(this.healthcheckTimeout),n=await fetch(e.request,{signal:t});return n.ok?n:this.respondWithCachedLoaderPage()}catch{return this.respondWithCachedLoaderPage()}};this.healthcheckTimeout=e,this.storage=t,this.respondWithCachedLoaderPage=n}async onMessage({source:e,data:t={}}){if(!(e instanceof Client))return;let{type:n,payload:i}=t;switch(n){case"HealthCheckSaveConfigEvent":this.onSyncHealthCheckConfigMessageEvent(i);break;default:break}}canIntercept(e){let t=/\/\?pwa=1$/;return e.request.method==="GET"&&e.request.destination==="document"&&t.test(e.request.url)}intercept(e){let t=async()=>await this.storage.getItem("pwaRedirectsMirrorsEnabled")?this.respondWithMirrorDiscoveryPage(e):this.respondWithDefault(e);e.respondWith(t())}};var Ye="ping-worker-event",$e="pong-worker-event";var re=class{constructor(){this.onMessage=({source:e,data:t})=>{e instanceof Client&&t===Ye&&e.postMessage($e)}}};var V=class{constructor(e,t,n=1){this.db=null;this.initializationPromise=null;this.dbName=e,this.storeName=t,this.dbVersion=n,this.init()}init(){let e=indexedDB.open(this.dbName,this.dbVersion);this.initializationPromise=new Promise((t,n)=>{e.onupgradeneeded=i=>{i.target.result.createObjectStore(this.storeName,{keyPath:"id"})},e.onsuccess=i=>{this.db=i.target.result,t()},e.onerror=i=>{let r=i.target.error;console.error("IndexedDB error:",r),n(r)}})}getStore(e="readonly"){if(!this.db)throw new Error("Database is not initialized");return this.db.transaction(this.storeName,e).objectStore(this.storeName)}async setItem(e,t){return await this.initializationPromise,new Promise((n,i)=>{let o=this.getStore("readwrite").put({id:e,value:t});o.onsuccess=()=>n(),o.onerror=c=>i(c.target.error)})}async getItem(e){return await this.initializationPromise,new Promise((t,n)=>{let r=this.getStore().get(e);r.onsuccess=()=>{r.result?t(r.result.value):t(null)},r.onerror=o=>n(o.target.error)})}async removeItem(e){return await this.initializationPromise,new Promise((t,n)=>{let r=this.getStore("readwrite").delete(e);r.onsuccess=()=>t(),r.onerror=o=>n(o.target.error)})}};var oe={pwaOffline:"/pwa-offline.html",pwaLoaderMirror:"/pwa-loader-mirror.html?h=564ed69e"},Dt=new B,Mt=new z,At=new re,Nt=new se,Ut=5e3,Wt=new V("PwaHealthcheckDB","PwaHealthcheckStore"),Qe=new H({healthcheckTimeout:Ut,storage:Wt,respondWithCachedLoaderPage:async()=>{try{let e=await(await caches.open(O)).match(oe.pwaLoaderMirror);return e||new Response("Redirect...",{status:200})}catch(s){return console.error(s),new Response(s.message,{status:500,statusText:s.message})}}}),Ft=[new q,Qe],jt=s=>{s.waitUntil(caches.open(O).then(e=>{let t=[e.add(oe.pwaOffline),e.add(oe.pwaLoaderMirror)].map(n=>n.catch(i=>{console.error(i)}));return Promise.all(t)}))},Kt=s=>{s.waitUntil(caches.keys().then(e=>Promise.all(e.filter(t=>!t.startsWith(O)).map(t=>caches.delete(t)))))},Bt=async s=>{if(navigator.onLine){for(let e of Ft)if(e.canIntercept(s)){e.intercept(s);return}return}s.respondWith(fetch(s.request).catch(e=>{if(s.request.destination==="document")return caches.open(O).then(t=>t.match("/pwa-offline.html"));throw e}))},zt=s=>{Nt.onMessage(s),At.onMessage(s),Dt.onMessage(s),Mt.onMessage(s),Qe.onMessage(s)};self.addEventListener("install",jt);self.addEventListener("fetch",Bt);self.addEventListener("activate",Kt);self.addEventListener("message",zt);})();

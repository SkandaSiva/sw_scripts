(()=>{var t={751:function(t,e,n){var i;t.exports=(i=i||function(t,e){var i;if("undefined"!=typeof window&&window.crypto&&(i=window.crypto),"undefined"!=typeof self&&self.crypto&&(i=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(i=globalThis.crypto),!i&&"undefined"!=typeof window&&window.msCrypto&&(i=window.msCrypto),!i&&void 0!==n.g&&n.g.crypto&&(i=n.g.crypto),!i)try{i=n(480)}catch(t){}var r=function(){if(i){if("function"==typeof i.getRandomValues)try{return i.getRandomValues(new Uint32Array(1))[0]}catch(t){}if("function"==typeof i.randomBytes)try{return i.randomBytes(4).readInt32LE()}catch(t){}}throw new Error("Native crypto module could not be used to get secure random number.")},o=Object.create||function(){function t(){}return function(e){var n;return t.prototype=e,n=new t,t.prototype=null,n}}(),s={},c=s.lib={},a=c.Base={extend:function(t){var e=o(this);return t&&e.mixIn(t),e.hasOwnProperty("init")&&this.init!==e.init||(e.init=function(){e.$super.init.apply(this,arguments)}),e.init.prototype=e,e.$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},u=c.WordArray=a.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=null!=e?e:4*t.length},toString:function(t){return(t||p).stringify(this)},concat:function(t){var e=this.words,n=t.words,i=this.sigBytes,r=t.sigBytes;if(this.clamp(),i%4)for(var o=0;o<r;o++){var s=n[o>>>2]>>>24-o%4*8&255;e[i+o>>>2]|=s<<24-(i+o)%4*8}else for(var c=0;c<r;c+=4)e[i+c>>>2]=n[c>>>2];return this.sigBytes+=r,this},clamp:function(){var e=this.words,n=this.sigBytes;e[n>>>2]&=4294967295<<32-n%4*8,e.length=t.ceil(n/4)},clone:function(){var t=a.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var e=[],n=0;n<t;n+=4)e.push(r());return new u.init(e,t)}}),d=s.enc={},p=d.Hex={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],r=0;r<n;r++){var o=e[r>>>2]>>>24-r%4*8&255;i.push((o>>>4).toString(16)),i.push((15&o).toString(16))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i+=2)n[i>>>3]|=parseInt(t.substr(i,2),16)<<24-i%8*4;return new u.init(n,e/2)}},f=d.Latin1={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],r=0;r<n;r++){var o=e[r>>>2]>>>24-r%4*8&255;i.push(String.fromCharCode(o))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i++)n[i>>>2]|=(255&t.charCodeAt(i))<<24-i%4*8;return new u.init(n,e)}},h=d.Utf8={stringify:function(t){try{return decodeURIComponent(escape(f.stringify(t)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(t){return f.parse(unescape(encodeURIComponent(t)))}},l=c.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new u.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=h.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var n,i=this._data,r=i.words,o=i.sigBytes,s=this.blockSize,c=o/(4*s),a=(c=e?t.ceil(c):t.max((0|c)-this._minBufferSize,0))*s,d=t.min(4*a,o);if(a){for(var p=0;p<a;p+=s)this._doProcessBlock(r,p);n=r.splice(0,a),i.sigBytes-=d}return new u.init(n,d)},clone:function(){var t=a.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0}),b=(c.Hasher=l.extend({cfg:a.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(e,n){return new t.init(n).finalize(e)}},_createHmacHelper:function(t){return function(e,n){return new b.HMAC.init(t,n).finalize(e)}}}),s.algo={});return s}(Math),i)},716:function(t,e,n){var i;t.exports=(i=n(751),function(t){var e=i,n=e.lib,r=n.WordArray,o=n.Hasher,s=e.algo,c=[];!function(){for(var e=0;e<64;e++)c[e]=4294967296*t.abs(t.sin(e+1))|0}();var a=s.MD5=o.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(t,e){for(var n=0;n<16;n++){var i=e+n,r=t[i];t[i]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8)}var o=this._hash.words,s=t[e+0],a=t[e+1],h=t[e+2],l=t[e+3],b=t[e+4],g=t[e+5],y=t[e+6],w=t[e+7],v=t[e+8],m=t[e+9],k=t[e+10],S=t[e+11],I=t[e+12],x=t[e+13],D=t[e+14],Z=t[e+15],A=o[0],B=o[1],C=o[2],P=o[3];A=u(A,B,C,P,s,7,c[0]),P=u(P,A,B,C,a,12,c[1]),C=u(C,P,A,B,h,17,c[2]),B=u(B,C,P,A,l,22,c[3]),A=u(A,B,C,P,b,7,c[4]),P=u(P,A,B,C,g,12,c[5]),C=u(C,P,A,B,y,17,c[6]),B=u(B,C,P,A,w,22,c[7]),A=u(A,B,C,P,v,7,c[8]),P=u(P,A,B,C,m,12,c[9]),C=u(C,P,A,B,k,17,c[10]),B=u(B,C,P,A,S,22,c[11]),A=u(A,B,C,P,I,7,c[12]),P=u(P,A,B,C,x,12,c[13]),C=u(C,P,A,B,D,17,c[14]),A=d(A,B=u(B,C,P,A,Z,22,c[15]),C,P,a,5,c[16]),P=d(P,A,B,C,y,9,c[17]),C=d(C,P,A,B,S,14,c[18]),B=d(B,C,P,A,s,20,c[19]),A=d(A,B,C,P,g,5,c[20]),P=d(P,A,B,C,k,9,c[21]),C=d(C,P,A,B,Z,14,c[22]),B=d(B,C,P,A,b,20,c[23]),A=d(A,B,C,P,m,5,c[24]),P=d(P,A,B,C,D,9,c[25]),C=d(C,P,A,B,l,14,c[26]),B=d(B,C,P,A,v,20,c[27]),A=d(A,B,C,P,x,5,c[28]),P=d(P,A,B,C,h,9,c[29]),C=d(C,P,A,B,w,14,c[30]),A=p(A,B=d(B,C,P,A,I,20,c[31]),C,P,g,4,c[32]),P=p(P,A,B,C,v,11,c[33]),C=p(C,P,A,B,S,16,c[34]),B=p(B,C,P,A,D,23,c[35]),A=p(A,B,C,P,a,4,c[36]),P=p(P,A,B,C,b,11,c[37]),C=p(C,P,A,B,w,16,c[38]),B=p(B,C,P,A,k,23,c[39]),A=p(A,B,C,P,x,4,c[40]),P=p(P,A,B,C,s,11,c[41]),C=p(C,P,A,B,l,16,c[42]),B=p(B,C,P,A,y,23,c[43]),A=p(A,B,C,P,m,4,c[44]),P=p(P,A,B,C,I,11,c[45]),C=p(C,P,A,B,Z,16,c[46]),A=f(A,B=p(B,C,P,A,h,23,c[47]),C,P,s,6,c[48]),P=f(P,A,B,C,w,10,c[49]),C=f(C,P,A,B,D,15,c[50]),B=f(B,C,P,A,g,21,c[51]),A=f(A,B,C,P,I,6,c[52]),P=f(P,A,B,C,l,10,c[53]),C=f(C,P,A,B,k,15,c[54]),B=f(B,C,P,A,a,21,c[55]),A=f(A,B,C,P,v,6,c[56]),P=f(P,A,B,C,Z,10,c[57]),C=f(C,P,A,B,y,15,c[58]),B=f(B,C,P,A,x,21,c[59]),A=f(A,B,C,P,b,6,c[60]),P=f(P,A,B,C,S,10,c[61]),C=f(C,P,A,B,h,15,c[62]),B=f(B,C,P,A,m,21,c[63]),o[0]=o[0]+A|0,o[1]=o[1]+B|0,o[2]=o[2]+C|0,o[3]=o[3]+P|0},_doFinalize:function(){var e=this._data,n=e.words,i=8*this._nDataBytes,r=8*e.sigBytes;n[r>>>5]|=128<<24-r%32;var o=t.floor(i/4294967296),s=i;n[15+(r+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),n[14+(r+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),e.sigBytes=4*(n.length+1),this._process();for(var c=this._hash,a=c.words,u=0;u<4;u++){var d=a[u];a[u]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8)}return c},clone:function(){var t=o.clone.call(this);return t._hash=this._hash.clone(),t}});function u(t,e,n,i,r,o,s){var c=t+(e&n|~e&i)+r+s;return(c<<o|c>>>32-o)+e}function d(t,e,n,i,r,o,s){var c=t+(e&i|n&~i)+r+s;return(c<<o|c>>>32-o)+e}function p(t,e,n,i,r,o,s){var c=t+(e^n^i)+r+s;return(c<<o|c>>>32-o)+e}function f(t,e,n,i,r,o,s){var c=t+(n^(e|~i))+r+s;return(c<<o|c>>>32-o)+e}e.MD5=o._createHelper(a),e.HmacMD5=o._createHmacHelper(a)}(Math),i.MD5)},54:(t,e,n)=>{"use strict";n.d(e,{Z:()=>i});const i=class{static error(t){console.error(...arguments)}static debug(t){}static warn(){}static info(t){console.info(...arguments)}}},480:()=>{}},e={};function n(i){var r=e[i];if(void 0!==r)return r.exports;var o=e[i]={exports:{}};return t[i].call(o.exports,o,o.exports,n),o.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{"use strict";const t=(t,e)=>e.some((e=>t instanceof e));let e,i;const r=new WeakMap,o=new WeakMap,s=new WeakMap,c=new WeakMap,a=new WeakMap;let u={get(t,e,n){if(t instanceof IDBTransaction){if("done"===e)return o.get(t);if("objectStoreNames"===e)return t.objectStoreNames||s.get(t);if("store"===e)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return p(t[e])},set:(t,e,n)=>(t[e]=n,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function d(n){return"function"==typeof n?(c=n)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(i||(i=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(c)?function(...t){return c.apply(f(this),t),p(r.get(this))}:function(...t){return p(c.apply(f(this),t))}:function(t,...e){const n=c.call(f(this),t,...e);return s.set(n,t.sort?t.sort():[t]),p(n)}:(n instanceof IDBTransaction&&function(t){if(o.has(t))return;const e=new Promise(((e,n)=>{const i=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",o),t.removeEventListener("abort",o)},r=()=>{e(),i()},o=()=>{n(t.error||new DOMException("AbortError","AbortError")),i()};t.addEventListener("complete",r),t.addEventListener("error",o),t.addEventListener("abort",o)}));o.set(t,e)}(n),t(n,e||(e=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(n,u):n);var c}function p(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,n)=>{const i=()=>{t.removeEventListener("success",r),t.removeEventListener("error",o)},r=()=>{e(p(t.result)),i()},o=()=>{n(t.error),i()};t.addEventListener("success",r),t.addEventListener("error",o)}));return e.then((e=>{e instanceof IDBCursor&&r.set(e,t)})).catch((()=>{})),a.set(e,t),e}(t);if(c.has(t))return c.get(t);const e=d(t);return e!==t&&(c.set(t,e),a.set(e,t)),e}const f=t=>a.get(t),h=["get","getKey","getAll","getAllKeys","count"],l=["put","add","delete","clear"],b=new Map;function g(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(b.get(e))return b.get(e);const n=e.replace(/FromIndex$/,""),i=e!==n,r=l.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!r&&!h.includes(n))return;const o=async function(t,...e){const o=this.transaction(t,r?"readwrite":"readonly");let s=o.store;return i&&(s=s.index(e.shift())),(await Promise.all([s[n](...e),r&&o.done]))[0]};return b.set(e,o),o}var y;y=u,u={...y,get:(t,e,n)=>g(t,e)||y.get(t,e,n),has:(t,e)=>!!g(t,e)||y.has(t,e)};var w=n(716),v=n.n(w);const m=class{static urlBase64ToUint8Array=function(t){const e="=".repeat((4-t.length%4)%4),n=window.atob((t+e).replace(/-/g,"+").replace(/_/g,"/"));let i=new Uint8Array(n.length);for(let t=0;t<n.length;++t)i[t]=n.charCodeAt(t);return i};static md5(t){return v()(t).toString()}static mergeOptions(t,e){const n={};let i;for(i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);for(i in e)e.hasOwnProperty(i)&&(n[i]=e[i]);return n}static trimUndefined(t){for(let e in t)t.hasOwnProperty(e)&&void 0===t[e]&&delete t[e];return t}},k="dextraWebPushDeviceStore2",S="dextraWebPushDataStore",I="device",x="appId",D=class{idb;connect(){if(void 0===this.idb){const t=this;this.idb=function(t,e,{blocked:n,upgrade:i,blocking:r,terminated:o}={}){const s=indexedDB.open(t,e),c=p(s);return i&&s.addEventListener("upgradeneeded",(t=>{i(p(s.result),t.oldVersion,t.newVersion,p(s.transaction))})),n&&s.addEventListener("blocked",(()=>n())),c.then((t=>{o&&t.addEventListener("close",(()=>o())),r&&t.addEventListener("versionchange",(()=>r()))})).catch((()=>{})),c}("dextraWebPushDb2",2,{async upgrade(e,n){if(n<1&&e.createObjectStore(k,{keyPath:"deviceId"}),n<2){e.createObjectStore(S);const n=await(await t.idb).get(k,0);n&&await t.store(I,n)}}})}return this.idb}async get(t){return(await this.connect()).get(S,t)}async store(t,e){(await this.connect()).put(S,e,t)}async getCurrentDevice(){return await this.get(I)||{deviceId:null,subscription:{}}}storeDevice(t){return this.store(I,{deviceId:m.md5(t.endpoint),subscription:{endpoint:t.endpoint}})}resetDevice(){return this.store(I,{deviceId:null,subscription:{}})}storeAppId(t){return this.store(x,t)}getAppId(){return this.get(x)}};var Z=n(54);const A=class{static loadAppConfig=function(t){return new Promise((function(e){const n="https://cdn.dxtrpb.com/wp/config/"+t+".json";try{fetch(n).then((function(i){200!==i.status?(Z.Z.error("[Api] Cannot load app config:",t,i),e(!1)):i.json().then((function(t){Z.Z.debug("[Api] Config loaded from "+n+" :",JSON.stringify(t)),e(t)}))}))}catch(t){Z.Z.error(t),e(!1)}}))};static createSubscription=function(t,e,n={}){return new Promise((function(i){const r={...n,siteUniqueKey:t,endpoint:e.endpoint,publicKey:e.toJSON().keys.p256dh,authToken:e.toJSON().keys.auth,expirationTime:e.expirationTime};Z.Z.debug("[Api] Subscribe with data:",r);try{fetch("https://api.dxtrpb.com/api/webpush/subscribe",{method:"POST",body:JSON.stringify(r),headers:{"Content-Type":"application/json"}}).then((function(t){t.json().then((function(e){Z.Z.debug("[Api] Subscription response:",e),200!==t.status?Z.Z.error("[Api] Subscription response error:",e):!0!==e.success?Z.Z.error("[Api] Subscription response error:",e.errors):Z.Z.debug("[Api] Subscription subscribed:",e),i(!0)}))}))}catch(t){Z.Z.error(t),i(!1)}}))};static unsubscribe=function(t,e){return new Promise((function(n){const i={siteUniqueKey:t,endpoint:e.endpoint};Z.Z.debug("[Api] Unsubscribe subscription:",i);try{fetch("https://api.dxtrpb.com/api/webpush/unsubscribe",{method:"POST",body:JSON.stringify(i),headers:{"Content-Type":"application/json"}}).then((function(t){t.json().then((function(e){Z.Z.debug("[Api] Unsubscribe response:",e),200!==t.status?Z.Z.error("[Api] Unsubscribe response error:",e):!0!==e.success?Z.Z.error("[Api] Unsubscribe response error:",e.errors):Z.Z.debug("[Api] Subscription unsubscribed:",e),n(!0)}))}))}catch(t){Z.Z.error(t),n(!1)}}))};static permissionRequest=function(t){return new Promise((function(e){const n={siteUniqueKey:t};Z.Z.debug("[Api] Permission request subscription:",n);try{fetch("https://api.dxtrpb.com/api/webpush/permission-request",{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}}).then((function(t){t.json().then((function(n){Z.Z.debug("[Api] Permission request response:",n),200!==t.status?Z.Z.error("[Api] Permission request response error:",n):!0!==n.success&&Z.Z.error("[Api] Permission request response error:",n.errors),e(!0)}))}))}catch(t){Z.Z.error(t),e(!1)}}))};static subscriptionDenied=function(t){return new Promise((function(e){const n={siteUniqueKey:t};Z.Z.debug("[Api] Subscription denied:",n);try{fetch("https://api.dxtrpb.com/api/webpush/subscription-denied",{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}}).then((function(t){t.json().then((function(n){Z.Z.debug("[Api] Subscription denied response:",n),200!==t.status?Z.Z.error("[Api] Subscription denied response error:",n):!0!==n.success&&Z.Z.error("[Api] Subscription denied response error:",n.errors),e(!0)}))}))}catch(t){Z.Z.error(t),e(!1)}}))};static setSubscriptionReferenceId(t,e,n){return new Promise((function(i){const r={siteUniqueKey:t,endpoint:e.endpoint,referenceId:n};Z.Z.debug("[Api] set subscription reference with data:",r);try{fetch("https://api.dxtrpb.com/api/webpush/set-subscription-reference-id",{method:"POST",body:JSON.stringify(r),headers:{"Content-Type":"application/json"}}).then((function(t){t.json().then((function(t){Z.Z.debug("[Api] Subscription reference response:",t),i(!0)}))}))}catch(t){Z.Z.error(t),i(!1)}}))}static notification=function(t,e,n){return new Promise((function(i){const r="https://api.dxtrpb.com/api/webpush/notification-event",o={siteUniqueKey:t,eventName:"notification."+e,eventData:n};Z.Z.debug("[Api] Notification event:",r,o);try{fetch(r,{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}}).then((function(t){t.json().then((function(e){Z.Z.debug("[Api] Notification event response:",e),200!==t.status?Z.Z.error("[Api] Notification event response error:",e):!0!==e.success&&Z.Z.error("[Api] Notification event response error:",e.errors),i(!0)}))}))}catch(t){Z.Z.error(t),i(!1)}}))}};let B={};const C=class{config=null;appId=null;db=new D;webHookExecutor=new class{setConfig(t){B=t,Z.Z.debug("[WebHook Executor] Set config",B)}sendWebHook=async function(t,e){const n=B[t]||void 0;if(Z.Z.debug("[WebHook Executor] WebHook raised:",t,e),!n)return Z.Z.debug("[WebHook Executor] Not found webHook url:",t,B),null;try{const i=new D,{deviceId:r}=await i.getCurrentDevice(),o={event:t,deviceId:r,eventData:e},s={method:"post",mode:"no-cors",body:JSON.stringify(o)};return B.corsEnabled&&(s.mode="cors",s.headers={"Content-Type":"application/json"}),Z.Z.debug("[WebHook Executor] Fetch webHook",n,s),fetch(n,s)}catch(t){Z.Z.error(t)}return!1}};constructor(){Z.Z.debug("[Tracking service] constructor")}setConfig(t){Z.Z.debug("[Tracking service] Set config",t),this.config=t,this.webHookExecutor.setConfig(this.config.webHooks||{})}async init(t){if(t?await this.db.storeAppId(t):(t=await this.db.getAppId(),Z.Z.debug("[Tracking service] get appId from db",t)),!t)throw new Error("[Tracking service] appId is undefined");this.appId=t,this.config||(this.setConfig(await A.loadAppConfig(t)),Z.Z.debug("[Tracking service] retrieve app config",this.config))}async permissionRequest(){Z.Z.debug("[TrackingService] permission");const t=this.config.internalTracking?.permissionRequest;t&&await A.permissionRequest(this.appId)}async subscriptionDenied(){await this.webHookExecutor.sendWebHook("subscriptionDenied",{});const t=this.config.internalTracking?.subscriptionDenied;t&&await A.subscriptionDenied(this.appId)}async subscription(t,e={}){Z.Z.debug("subscription",t),await this.db.storeDevice(t),await this.webHookExecutor.sendWebHook("subscribed",{deviceId:m.md5(t.endpoint)}),await A.createSubscription(this.appId,t,e)}async setSubscriptionReferenceId(t,e){return Z.Z.debug("subscription reference",t,e),A.createSubscription(this.appId,t,e)}async unsubscription(t){Z.Z.debug("Unsubscription",t),await this.webHookExecutor.sendWebHook("unsubscribed",{deviceId:m.md5(t.endpoint)}),await A.unsubscribe(this.appId,t),await this.db.resetDevice()}async notificationDelivered(t){await this.webHookExecutor.sendWebHook("notification.delivered",t);const e=this.config.internalTracking?.["notification.delivered"];e&&await A.notification(this.appId,"delivered",t)}async notificationClicked(t){await this.webHookExecutor.sendWebHook("notification.clicked",t);const e=this.config.internalTracking?.["notification.clicked"];e&&await A.notification(this.appId,"clicked",t)}async notificationClosed(t){await this.webHookExecutor.sendWebHook("notification.closed",t);const e=this.config.internalTracking?.["notification.closed"];e&&await A.notification(this.appId,"closed",t)}},P=n(54).Z,T=new class{trackingService=new C;initialized=!1;async init(){this.initialized||(this.trackingService=new C,await this.trackingService.init(),this.initialized=!0)}async onPushReceived(t){if(await this.init(),P.debug("[Worker] notification received:",t),!t.data)return null;const e=t.data.json(),n=this.buildNotification(e),i={title:n.title,body:n.body,url:n.url,icon:n.icon,image:n.image,badge:n.badge,vibrate:n.vibrate,tag:n.tag,data:n.data,actions:n.actions,requireInteraction:!0};P.debug("[Worker] raw notification:",e),this.displayNotification(i),await this.trackingService.notificationDelivered(n.data)}onNotificationClosed(t){P.debug("[Worker] notification closed.",t),t.waitUntil(this.trackingService.notificationClosed(t.notification.data))}onNotificationClicked(t){P.debug("[Worker] notification clicked.",t);let e=[this.trackingService.notificationClicked(t.notification.data)];const n=t.action;let i;return i=t.notification.data.actions[n]?t.notification.data.actions[n].clickUrl:t.notification.data.clickUrl,i&&(console.log(i),e.push(this.openUrl(i))),Promise.all(e)}onPushSubscriptionChange(t){P.debug("[Worker] subscription change.",t)}async openUrl(t){return P.debug("Opening notification URL:",t),self.clients.matchAll({type:"window",includeUncontrolled:!0}).then((function(e){for(const n of e)if(n.url===t&&"focus"in n)return n.focus();if(self.clients.openWindow)return self.clients.openWindow(t)}))}displayNotification(t){return P.debug("[Worker] display notification:",t),self.registration.showNotification(t.title,t)}buildNotification(t){const e={title:t.title,body:t.body,data:{notificationId:t.notificationId??void 0,clickUrl:t.clickUrl??void 0},icon:t.icon??void 0,image:t.image??void 0,tag:t.tag??t.notificationId,badge:t.badge??void 0,vibrate:t.vibrate,renotify:!0,actions:t.actions};if(t.actions){e.actions=[];const n={};for(const i of t.actions)e.actions.push({action:i.id,title:i.title,icon:i.icon}),n[i.id]={action:i.id,clickUrl:i.clickUrl};e.data.actions=n}return m.trimUndefined(e)}};let E=!1;(class{static run(){self.addEventListener("push",(t=>t.waitUntil(T.onPushReceived(t)))),self.addEventListener("notificationclick",(t=>{t.notification.close(),E=!0,t.waitUntil(T.onNotificationClicked(t).then((()=>{E=!1})))})),self.addEventListener("pushsubscriptionchange",(t=>{console.log("pushsubscription change",t),T.onPushSubscriptionChange(t)})),self.addEventListener("notificationclose",(t=>{E?E=!1:T.onNotificationClosed(t)}))}}).run()})()})();